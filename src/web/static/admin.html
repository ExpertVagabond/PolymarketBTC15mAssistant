<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PolySignal Admin</title>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: #0b0b11; color: #c8c8d0; min-height: 100vh; line-height: 1.5; }

    .header { padding: 14px 28px; background: #101018; border-bottom: 1px solid #1e1e2a; display: flex; align-items: center; justify-content: space-between; }
    .header-left { display: flex; align-items: center; gap: 14px; }
    .header-left h1 { font-size: 17px; color: #fff; font-weight: 700; }
    .header-left .badge { font-size: 10px; font-weight: 700; padding: 2px 10px; border-radius: 20px; background: #f8717120; color: #f87171; }
    .header-right { display: flex; align-items: center; gap: 14px; }
    .header-link { color: #6b7280; text-decoration: none; font-size: 12px; font-weight: 500; }
    .header-link:hover { color: #a5b4fc; }
    .refresh-badge { font-size: 10px; color: #4b5563; }

    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; padding: 20px 28px; }
    .card { background: #12121a; border: 1px solid #1e1e2a; border-radius: 10px; padding: 16px 18px; }
    .card.wide { grid-column: 1 / -1; }
    .card.half { grid-column: span 2; }
    .card-title { font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 12px; }
    .kv { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #141420; font-size: 12px; }
    .kv:last-child { border-bottom: none; }
    .kv .k { color: #6b7280; }
    .kv .v { color: #e5e7eb; font-weight: 600; font-variant-numeric: tabular-nums; }
    .kv .v.green { color: #34d399; }
    .kv .v.red { color: #f87171; }
    .kv .v.amber { color: #fbbf24; }
    .kv .v.blue { color: #60a5fa; }

    .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
    .status-dot.ok { background: #34d399; }
    .status-dot.warn { background: #fbbf24; }
    .status-dot.err { background: #f87171; }

    .source-row { display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid #141420; font-size: 12px; }
    .source-row:last-child { border-bottom: none; }
    .source-name { color: #e5e7eb; font-weight: 500; width: 120px; }
    .source-stats { color: #6b7280; flex: 1; font-variant-numeric: tabular-nums; }

    .auth-wall { text-align: center; padding: 80px 28px; }
    .auth-wall h2 { color: #fff; margin-bottom: 8px; }
    .auth-wall p { color: #6b7280; font-size: 13px; }

    .try-btn { background: #1a1a24; border: 1px solid #2a2a36; border-radius: 6px; padding: 3px 10px; font-size: 10px; color: #93c5fd; cursor: pointer; font-family: inherit; font-weight: 600; transition: all 0.15s; }
    .try-btn:hover { border-color: #3b82f6; background: #3b82f618; }

    .footer { text-align: center; padding: 28px; color: #27272f; font-size: 11px; }
    .footer a { color: #4b5563; }

    @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } .card.wide, .card.half { grid-column: 1; } }
  </style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <h1>PolySignal</h1>
    <span class="badge">ADMIN</span>
  </div>
  <div class="header-right">
    <span class="refresh-badge" id="lastRefresh">Loading...</span>
    <a href="/" class="header-link">Dashboard</a>
    <a href="/stats.html" class="header-link">Performance</a>
  </div>
</div>

<div id="authWall" class="auth-wall" style="display:none">
  <h2>Admin Access Required</h2>
  <p>Login via the main dashboard Settings tab to access this page.</p>
</div>

<div id="adminContent">
  <div class="grid">
    <!-- System Health -->
    <div class="card">
      <div class="card-title">System Health</div>
      <div id="healthBlock">
        <div class="kv"><span class="k">Status</span><span class="v" id="sysStatus">-</span></div>
        <div class="kv"><span class="k">Uptime</span><span class="v" id="sysUptime">-</span></div>
        <div class="kv"><span class="k">Memory (Heap)</span><span class="v" id="sysMem">-</span></div>
        <div class="kv"><span class="k">WS Clients</span><span class="v blue" id="sysWs">-</span></div>
      </div>
    </div>

    <!-- Scanner Stats -->
    <div class="card">
      <div class="card-title">Scanner</div>
      <div id="scannerBlock">
        <div class="kv"><span class="k">Tracked Markets</span><span class="v" id="scTracked">-</span></div>
        <div class="kv"><span class="k">Active Signals</span><span class="v green" id="scSignals">-</span></div>
        <div class="kv"><span class="k">Categories</span><span class="v" id="scCats">-</span></div>
      </div>
    </div>

    <!-- Signal Stats -->
    <div class="card">
      <div class="card-title">Signal Performance</div>
      <div id="signalBlock">
        <div class="kv"><span class="k">Total Signals</span><span class="v" id="sigTotal">-</span></div>
        <div class="kv"><span class="k">Win Rate</span><span class="v green" id="sigWinRate">-</span></div>
        <div class="kv"><span class="k">Wins / Losses</span><span class="v" id="sigRecord">-</span></div>
        <div class="kv"><span class="k">Pending</span><span class="v amber" id="sigPending">-</span></div>
        <div class="kv"><span class="k">Avg Edge</span><span class="v" id="sigEdge">-</span></div>
      </div>
    </div>

    <!-- Data Sources -->
    <div class="card half">
      <div class="card-title">Data Source Health</div>
      <div id="sourcesBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Subscribers -->
    <div class="card">
      <div class="card-title">Subscribers</div>
      <div id="subBlock">
        <div class="kv"><span class="k">Total</span><span class="v" id="subTotal">-</span></div>
        <div class="kv"><span class="k">Active</span><span class="v green" id="subActive">-</span></div>
        <div class="kv"><span class="k">Pro</span><span class="v blue" id="subPro">-</span></div>
        <div class="kv"><span class="k">Basic</span><span class="v" id="subBasic">-</span></div>
        <div class="kv"><span class="k">Free</span><span class="v" id="subFree">-</span></div>
      </div>
    </div>

    <!-- Model Drift -->
    <div class="card half">
      <div class="card-title">Model Drift</div>
      <div id="driftBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
      <div style="margin-top:10px"><button class="try-btn" onclick="resetDriftBaseline()">Reset Baseline</button></div>
    </div>

    <!-- Webhook Queue -->
    <div class="card">
      <div class="card-title">Webhook Queue</div>
      <div id="webhookQueueBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Delivery Health -->
    <div class="card">
      <div class="card-title">Delivery Health (7d)</div>
      <div id="deliveryBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Cache Stats -->
    <div class="card">
      <div class="card-title">Response Cache</div>
      <div id="cacheBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Error Trends -->
    <div class="card wide">
      <div class="card-title">Error Trends (7d)</div>
      <div id="errorBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Subscriber List -->
    <div class="card wide">
      <div class="card-title">
        Subscribers
        <select id="subFilter" onchange="loadSubscribers()" style="margin-left:8px;background:#0e0e16;border:1px solid #1e1e2a;border-radius:4px;color:#9ca3af;font-size:10px;padding:2px 6px">
          <option value="">All Plans</option>
          <option value="free">Free</option>
          <option value="basic">Basic</option>
          <option value="pro">Pro</option>
        </select>
      </div>
      <div id="subscriberList"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Grant Comp Access -->
    <div class="card">
      <div class="card-title">Grant Comp Access</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <input type="email" id="compEmail" placeholder="user@example.com" style="background:#0e0e16;border:1px solid #1e1e2a;border-radius:4px;padding:6px 10px;color:#e5e7eb;font-size:12px;font-family:inherit">
        <div style="display:flex;gap:6px">
          <select id="compPlan" style="background:#0e0e16;border:1px solid #1e1e2a;border-radius:4px;padding:4px 8px;color:#9ca3af;font-size:11px;font-family:inherit">
            <option value="pro">Pro</option>
            <option value="basic">Basic</option>
          </select>
          <input type="number" id="compDays" value="30" min="1" max="365" style="background:#0e0e16;border:1px solid #1e1e2a;border-radius:4px;padding:4px 8px;color:#e5e7eb;font-size:11px;width:60px;font-family:inherit"> days
          <button class="try-btn" onclick="grantComp()">Grant</button>
        </div>
        <div id="compResult" style="font-size:11px;color:#34d399;display:none"></div>
      </div>
    </div>
  </div>
</div>

<div class="footer">PolySignal Admin &mdash; <a href="/">Back to Dashboard</a></div>

<script>
const $ = (id) => document.getElementById(id);

async function loadAdmin() {
  try {
    // Check auth
    const me = await fetch("/api/auth/me").then(r => r.json());
    if (!me.email) { showAuthWall(); return; }

    // Load all data in parallel
    const [health, admin, trends, drift, whQueue, delivery, cacheStats] = await Promise.all([
      fetch("/health/detailed").then(r => r.json()),
      fetch("/api/admin/stats").then(r => r.json()).catch(() => null),
      fetch("/api/logs/trends?days=7").then(r => r.json()).catch(() => null),
      fetch("/api/learning/drift-status").then(r => r.json()).catch(() => null),
      fetch("/api/admin/webhook-queue").then(r => r.json()).catch(() => null),
      fetch("/api/admin/delivery-stats").then(r => r.json()).catch(() => null),
      fetch("/api/admin/cache-stats").then(r => r.json()).catch(() => null)
    ]);

    renderHealth(health);
    if (admin) renderAdmin(admin);
    if (trends) renderErrors(trends);
    if (drift) renderDrift(drift);
    if (whQueue) renderWebhookQueue(whQueue);
    if (delivery) renderDeliveryHealth(delivery);
    if (cacheStats) renderCacheStats(cacheStats);
    loadSubscribers();

    $("lastRefresh").textContent = "Updated " + new Date().toLocaleTimeString();
  } catch {
    showAuthWall();
  }
}

function showAuthWall() {
  $("authWall").style.display = "block";
  $("adminContent").style.display = "none";
}

function renderHealth(h) {
  const statusColor = h.status === "healthy" ? "green" : h.status === "degraded" ? "amber" : "red";
  $("sysStatus").innerHTML = `<span class="status-dot ${statusColor === "green" ? "ok" : statusColor === "amber" ? "warn" : "err"}"></span>${h.status || "unknown"}`;
  $("sysUptime").textContent = formatUptime(h.uptime);
  $("sysMem").textContent = h.memory?.heap || "-";
  $("sysWs").textContent = h.wsClients ?? 0;

  // Scanner
  if (h.scanner) {
    $("scTracked").textContent = h.scanner.tracked ?? 0;
    $("scSignals").textContent = h.scanner.withSignal ?? 0;
    $("scCats").textContent = h.scanner.categories ?? 0;
  }

  // Data sources
  const sources = h.sources;
  if (sources && typeof sources === "object") {
    const el = $("sourcesBlock");
    el.innerHTML = Object.entries(sources).map(([name, s]) => {
      const up = s.status === "healthy" || s.uptime > 0.9;
      const dotClass = up ? "ok" : s.status === "degraded" ? "warn" : "err";
      const latency = s.avgLatencyMs != null ? Math.round(s.avgLatencyMs) + "ms" : "-";
      const upPct = s.uptime != null ? (s.uptime * 100).toFixed(1) + "%" : "-";
      return `<div class="source-row">
        <span class="status-dot ${dotClass}"></span>
        <span class="source-name">${esc(name)}</span>
        <span class="source-stats">latency: ${latency} | uptime: ${upPct} | errors: ${s.errors ?? 0}</span>
      </div>`;
    }).join("");
  }
}

function renderAdmin(a) {
  // Signal stats
  const sig = a.signals || {};
  $("sigTotal").textContent = sig.total_signals ?? 0;
  $("sigWinRate").textContent = sig.winRate ? sig.winRate + "%" : "-";
  $("sigRecord").textContent = `${sig.wins ?? 0}W / ${sig.losses ?? 0}L`;
  $("sigPending").textContent = sig.pending ?? 0;
  $("sigEdge").textContent = sig.avg_edge != null ? "+" + (sig.avg_edge * 100).toFixed(1) + "%" : "-";

  // Subscribers
  const sub = a.subscribers || {};
  $("subTotal").textContent = sub.total ?? 0;
  $("subActive").textContent = sub.active ?? 0;
  $("subPro").textContent = sub.pro ?? 0;
  $("subBasic").textContent = sub.basic ?? 0;
  $("subFree").textContent = (sub.total ?? 0) - (sub.pro ?? 0) - (sub.basic ?? 0);
}

function formatUptime(secs) {
  if (!secs) return "-";
  const h = Math.floor(secs / 3600);
  const m = Math.floor((secs % 3600) / 60);
  return h > 0 ? `${h}h ${m}m` : `${m}m`;
}

function renderErrors(t) {
  const el = $("errorBlock");
  if (!t.bySource?.length && !t.daily?.length) {
    el.innerHTML = '<div style="color:#34d399;font-size:12px">No errors in the last 7 days</div>';
    return;
  }
  const sources = (t.bySource || []).map(s =>
    `<div class="kv"><span class="k">${esc(s.source)}</span><span class="v red">${s.count}</span></div>`
  ).join("");
  const levels = (t.byLevel || []).map(l =>
    `<div class="kv"><span class="k">${esc(l.level)}</span><span class="v ${l.level === "error" ? "red" : l.level === "warn" ? "amber" : ""}">${l.count}</span></div>`
  ).join("");
  el.innerHTML = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
    <div><div style="font-size:10px;color:#6b7280;margin-bottom:6px;font-weight:700">BY SOURCE</div>${sources || '<div style="color:#4b5563;font-size:11px">None</div>'}</div>
    <div><div style="font-size:10px;color:#6b7280;margin-bottom:6px;font-weight:700">BY LEVEL</div>${levels || '<div style="color:#4b5563;font-size:11px">None</div>'}</div>
  </div>`;
}

function renderDrift(d) {
  const el = $("driftBlock");
  if (!d.baselineSet) { el.innerHTML = '<div style="color:#4b5563;font-size:12px">No baseline set yet</div>'; return; }
  const sevColor = d.severity === "none" ? "#34d399" : d.severity === "low" ? "#60a5fa" : d.severity === "medium" ? "#fbbf24" : "#f87171";
  let html = `<div class="kv"><span class="k">Severity</span><span class="v" style="color:${sevColor}">${(d.severity || "none").toUpperCase()}</span></div>
    <div class="kv"><span class="k">Checked</span><span class="v">${d.totalChecked ?? 0}</span></div>
    <div class="kv"><span class="k">Drifted</span><span class="v ${d.totalDrifted > 0 ? "red" : ""}">${d.totalDrifted ?? 0}</span></div>
    <div class="kv"><span class="k">Threshold</span><span class="v">${d.driftThreshold ? (d.driftThreshold * 100) + "%" : "20%"}</span></div>`;
  if (d.topDrifts?.length > 0) {
    html += '<div style="font-size:10px;color:#6b7280;font-weight:700;margin-top:8px;margin-bottom:4px">TOP DRIFTS</div>';
    html += d.topDrifts.slice(0, 5).map(dr =>
      `<div class="kv"><span class="k" style="font-size:11px">${esc(dr.feature)}.${esc(dr.value)}</span><span class="v red">${dr.divergencePct}% ${dr.direction}</span></div>`
    ).join("");
  }
  if (d.recommendation) html += `<div style="font-size:11px;color:#9ca3af;margin-top:8px">${esc(d.recommendation)}</div>`;
  el.innerHTML = html;
}

function renderWebhookQueue(q) {
  const el = $("webhookQueueBlock");
  const s = q.status || {};
  let html = `<div class="kv"><span class="k">Pending</span><span class="v amber">${s.pending ?? 0}</span></div>
    <div class="kv"><span class="k">Retrying</span><span class="v amber">${s.retrying ?? 0}</span></div>
    <div class="kv"><span class="k">Delivered</span><span class="v green">${s.delivered ?? 0}</span></div>
    <div class="kv"><span class="k">Failed</span><span class="v red">${s.failed ?? 0}</span></div>
    <div class="kv"><span class="k">Total</span><span class="v">${s.total ?? 0}</span></div>`;
  el.innerHTML = html;
}

async function resetDriftBaseline() {
  try {
    const res = await fetch("/api/learning/drift-baseline", { method: "POST" });
    const data = await res.json();
    if (data.acknowledged) { loadAdmin(); }
  } catch {}
}

function renderDeliveryHealth(d) {
  const el = $("deliveryBlock");
  if (!el) return;
  const byStatus = d.byStatus || [];
  const byChannel = d.byChannel || [];
  let html = "";
  for (const s of byStatus) {
    const color = s.status === "delivered" ? "green" : s.status === "failed" ? "red" : s.status === "throttled" ? "amber" : "";
    html += `<div class="kv"><span class="k">${esc(s.status)}</span><span class="v ${color}">${s.count}</span></div>`;
  }
  if (d.avgLatencyMs != null) html += `<div class="kv"><span class="k">Avg Latency</span><span class="v">${Math.round(d.avgLatencyMs)}ms</span></div>`;
  el.innerHTML = html || '<div style="color:#4b5563;font-size:12px">No delivery data</div>';
}

function renderCacheStats(c) {
  const el = $("cacheBlock");
  if (!el) return;
  el.innerHTML = `
    <div class="kv"><span class="k">Entries</span><span class="v blue">${c.entries ?? 0}</span></div>
    <div class="kv"><span class="k">Hit Rate</span><span class="v green">${c.hitRate ?? 0}%</span></div>
    <div class="kv"><span class="k">Hits / Misses</span><span class="v">${c.hits ?? 0} / ${c.misses ?? 0}</span></div>
  `;
}

async function loadSubscribers() {
  const el = $("subscriberList");
  if (!el) return;
  const plan = $("subFilter")?.value || "";
  const url = "/api/admin/subscribers" + (plan ? "?plan=" + plan : "");
  try {
    const subs = await fetch(url).then(r => r.json());
    if (!Array.isArray(subs) || subs.length === 0) { el.innerHTML = '<div style="color:#4b5563;font-size:12px">No subscribers found</div>'; return; }
    el.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:11px">
      <thead><tr>
        <th style="text-align:left;padding:6px 8px;color:#4b5563;font-size:9px;text-transform:uppercase;border-bottom:1px solid #1e1e2a">Email</th>
        <th style="text-align:left;padding:6px 8px;color:#4b5563;font-size:9px;text-transform:uppercase;border-bottom:1px solid #1e1e2a">Plan</th>
        <th style="text-align:left;padding:6px 8px;color:#4b5563;font-size:9px;text-transform:uppercase;border-bottom:1px solid #1e1e2a">Status</th>
        <th style="text-align:left;padding:6px 8px;color:#4b5563;font-size:9px;text-transform:uppercase;border-bottom:1px solid #1e1e2a">Platforms</th>
        <th style="text-align:left;padding:6px 8px;color:#4b5563;font-size:9px;text-transform:uppercase;border-bottom:1px solid #1e1e2a">Created</th>
      </tr></thead>
      <tbody>${subs.map(s => {
        const planColor = s.plan === "pro" ? "color:#c084fc" : s.plan === "basic" ? "color:#60a5fa" : "color:#6b7280";
        const statusColor = s.status === "active" ? "color:#34d399" : s.status === "cancelled" ? "color:#f87171" : "color:#fbbf24";
        const platforms = [s.telegram_user_id ? "TG" : null, s.discord_user_id ? "DC" : null].filter(Boolean).join(", ") || "-";
        const created = s.created_at ? new Date(s.created_at).toLocaleDateString() : "-";
        return `<tr style="border-bottom:1px solid #141420">
          <td style="padding:6px 8px;color:#e5e7eb">${esc(s.email)}</td>
          <td style="padding:6px 8px;${planColor};font-weight:600;text-transform:uppercase">${s.plan}</td>
          <td style="padding:6px 8px;${statusColor}">${s.status}</td>
          <td style="padding:6px 8px;color:#6b7280">${platforms}</td>
          <td style="padding:6px 8px;color:#4b5563">${created}</td>
        </tr>`;
      }).join("")}</tbody>
    </table>`;
  } catch {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">Failed to load subscribers</div>';
  }
}

async function grantComp() {
  const email = $("compEmail")?.value;
  const plan = $("compPlan")?.value || "pro";
  const days = Number($("compDays")?.value) || 30;
  if (!email) return;
  try {
    const res = await fetch("/api/admin/grant-comp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, plan, days })
    });
    const data = await res.json();
    const el = $("compResult");
    if (el) { el.textContent = data.message || "Done"; el.style.display = "block"; }
    loadSubscribers();
  } catch (err) {
    const el = $("compResult");
    if (el) { el.textContent = "Error: " + err.message; el.style.display = "block"; el.style.color = "#f87171"; }
  }
}

function esc(s) { if (!s) return ""; const el = document.createElement("span"); el.textContent = s; return el.innerHTML; }

loadAdmin();
setInterval(loadAdmin, 30_000);
</script>
</body>
</html>
