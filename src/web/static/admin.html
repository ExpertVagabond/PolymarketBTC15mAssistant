<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PolySignal Admin</title>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: #0b0b11; color: #c8c8d0; min-height: 100vh; line-height: 1.5; }

    .header { padding: 14px 28px; background: #101018; border-bottom: 1px solid #1e1e2a; display: flex; align-items: center; justify-content: space-between; }
    .header-left { display: flex; align-items: center; gap: 14px; }
    .header-left h1 { font-size: 17px; color: #fff; font-weight: 700; }
    .header-left .badge { font-size: 10px; font-weight: 700; padding: 2px 10px; border-radius: 20px; background: #f8717120; color: #f87171; }
    .header-right { display: flex; align-items: center; gap: 14px; }
    .header-link { color: #6b7280; text-decoration: none; font-size: 12px; font-weight: 500; }
    .header-link:hover { color: #a5b4fc; }
    .refresh-badge { font-size: 10px; color: #4b5563; }

    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; padding: 20px 28px; }
    .card { background: #12121a; border: 1px solid #1e1e2a; border-radius: 10px; padding: 16px 18px; }
    .card.wide { grid-column: 1 / -1; }
    .card.half { grid-column: span 2; }
    .card-title { font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 12px; }
    .kv { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #141420; font-size: 12px; }
    .kv:last-child { border-bottom: none; }
    .kv .k { color: #6b7280; }
    .kv .v { color: #e5e7eb; font-weight: 600; font-variant-numeric: tabular-nums; }
    .kv .v.green { color: #34d399; }
    .kv .v.red { color: #f87171; }
    .kv .v.amber { color: #fbbf24; }
    .kv .v.blue { color: #60a5fa; }

    .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
    .status-dot.ok { background: #34d399; }
    .status-dot.warn { background: #fbbf24; }
    .status-dot.err { background: #f87171; }

    .source-row { display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid #141420; font-size: 12px; }
    .source-row:last-child { border-bottom: none; }
    .source-name { color: #e5e7eb; font-weight: 500; width: 120px; }
    .source-stats { color: #6b7280; flex: 1; font-variant-numeric: tabular-nums; }

    .auth-wall { text-align: center; padding: 80px 28px; }
    .auth-wall h2 { color: #fff; margin-bottom: 8px; }
    .auth-wall p { color: #6b7280; font-size: 13px; }

    .try-btn { background: #1a1a24; border: 1px solid #2a2a36; border-radius: 6px; padding: 3px 10px; font-size: 10px; color: #93c5fd; cursor: pointer; font-family: inherit; font-weight: 600; transition: all 0.15s; }
    .try-btn:hover { border-color: #3b82f6; background: #3b82f618; }

    .footer { text-align: center; padding: 28px; color: #27272f; font-size: 11px; }
    .footer a { color: #4b5563; }

    @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } .card.wide, .card.half { grid-column: 1; } }
  </style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <h1>PolySignal</h1>
    <span class="badge">ADMIN</span>
  </div>
  <div class="header-right">
    <span class="refresh-badge" id="lastRefresh">Loading...</span>
    <a href="/" class="header-link">Dashboard</a>
    <a href="/stats.html" class="header-link">Performance</a>
  </div>
</div>

<div id="authWall" class="auth-wall" style="display:none">
  <h2>Admin Access Required</h2>
  <p>Login via the main dashboard Settings tab to access this page.</p>
</div>

<div id="adminContent">
  <div class="grid">
    <!-- System Health -->
    <div class="card">
      <div class="card-title">System Health</div>
      <div id="healthBlock">
        <div class="kv"><span class="k">Status</span><span class="v" id="sysStatus">-</span></div>
        <div class="kv"><span class="k">Uptime</span><span class="v" id="sysUptime">-</span></div>
        <div class="kv"><span class="k">Memory (Heap)</span><span class="v" id="sysMem">-</span></div>
        <div class="kv"><span class="k">WS Clients</span><span class="v blue" id="sysWs">-</span></div>
      </div>
    </div>

    <!-- Scanner Stats -->
    <div class="card">
      <div class="card-title">Scanner</div>
      <div id="scannerBlock">
        <div class="kv"><span class="k">Tracked Markets</span><span class="v" id="scTracked">-</span></div>
        <div class="kv"><span class="k">Active Signals</span><span class="v green" id="scSignals">-</span></div>
        <div class="kv"><span class="k">Categories</span><span class="v" id="scCats">-</span></div>
      </div>
    </div>

    <!-- Signal Stats -->
    <div class="card">
      <div class="card-title">Signal Performance</div>
      <div id="signalBlock">
        <div class="kv"><span class="k">Total Signals</span><span class="v" id="sigTotal">-</span></div>
        <div class="kv"><span class="k">Win Rate</span><span class="v green" id="sigWinRate">-</span></div>
        <div class="kv"><span class="k">Wins / Losses</span><span class="v" id="sigRecord">-</span></div>
        <div class="kv"><span class="k">Pending</span><span class="v amber" id="sigPending">-</span></div>
        <div class="kv"><span class="k">Avg Edge</span><span class="v" id="sigEdge">-</span></div>
      </div>
    </div>

    <!-- Data Sources -->
    <div class="card half">
      <div class="card-title">Data Source Health</div>
      <div id="sourcesBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Subscribers -->
    <div class="card">
      <div class="card-title">Subscribers</div>
      <div id="subBlock">
        <div class="kv"><span class="k">Total</span><span class="v" id="subTotal">-</span></div>
        <div class="kv"><span class="k">Active</span><span class="v green" id="subActive">-</span></div>
        <div class="kv"><span class="k">Pro</span><span class="v blue" id="subPro">-</span></div>
        <div class="kv"><span class="k">Basic</span><span class="v" id="subBasic">-</span></div>
        <div class="kv"><span class="k">Free</span><span class="v" id="subFree">-</span></div>
      </div>
    </div>

    <!-- Model Drift -->
    <div class="card half">
      <div class="card-title">Model Drift</div>
      <div id="driftBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
      <div style="margin-top:10px"><button class="try-btn" onclick="resetDriftBaseline()">Reset Baseline</button></div>
    </div>

    <!-- Webhook Queue -->
    <div class="card">
      <div class="card-title">Webhook Queue</div>
      <div id="webhookQueueBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Delivery Health -->
    <div class="card">
      <div class="card-title">Delivery Health (7d)</div>
      <div id="deliveryBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Cache Stats -->
    <div class="card">
      <div class="card-title">Response Cache</div>
      <div id="cacheBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Endpoint Performance -->
    <div class="card">
      <div class="card-title">Endpoint Performance</div>
      <div id="perfBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Maintenance -->
    <div class="card">
      <div class="card-title">DB Maintenance</div>
      <div id="maintenanceBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
      <button style="margin-top:8px;padding:4px 12px;font-size:11px;background:#1e1e2a;border:1px solid #2d2d3a;color:#a5b4fc;border-radius:6px;cursor:pointer" onclick="runMaintenance()">Run Now</button>
    </div>

    <!-- Trading Config -->
    <div class="card">
      <div class="card-title">Trading Config</div>
      <div id="configBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Trading Status -->
    <div class="card half">
      <div class="card-title">Trading Bot</div>
      <div id="tradingBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Live Trade Feed -->
    <div class="card wide">
      <div class="card-title">Live Trade Feed <span id="wsBadge" style="font-size:9px;padding:1px 6px;border-radius:8px;background:#f8717120;color:#f87171;margin-left:6px">OFFLINE</span></div>
      <div id="tradeFeed" style="max-height:220px;overflow-y:auto;font-size:11px">
        <div data-placeholder style="color:#4b5563;font-size:12px">Waiting for trade events...</div>
      </div>
    </div>

    <!-- Trade Analytics -->
    <div class="card half">
      <div class="card-title">Trade Analytics</div>
      <div id="analyticsBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- P&L Attribution -->
    <div class="card">
      <div class="card-title">P&L Attribution</div>
      <div id="attributionBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Category Intelligence -->
    <div class="card">
      <div class="card-title">Category Intelligence</div>
      <div id="categoryBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Signal Filters -->
    <div class="card">
      <div class="card-title">Signal Filters</div>
      <div id="filterStatsBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Close Reasons -->
    <div class="card">
      <div class="card-title">Close Reasons</div>
      <div id="closeReasonsBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Regime × Category Heatmap -->
    <div class="card wide">
      <div class="card-title">Regime × Category Performance</div>
      <div id="heatmapBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Anomaly Detection -->
    <div class="card">
      <div class="card-title">Performance Anomalies</div>
      <div id="anomalyBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Slippage Analysis -->
    <div class="card">
      <div class="card-title">Slippage Analysis</div>
      <div id="slippageBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Correlation Matrix -->
    <div class="card">
      <div class="card-title">Portfolio Correlation</div>
      <div id="correlationBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- A/B Experiments -->
    <div class="card">
      <div class="card-title">A/B Experiments</div>
      <div id="experimentsBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Execution Quality -->
    <div class="card">
      <div class="card-title">Execution Quality</div>
      <div id="execQualityBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- System Health -->
    <div class="card">
      <div class="card-title">System Health Score</div>
      <div id="healthScoreBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Auto-Recovery Log -->
    <div class="card">
      <div class="card-title">Auto-Recovery</div>
      <div id="recoveryBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Parameter Evolution -->
    <div class="card">
      <div class="card-title">Parameter Evolution</div>
      <div id="evolutionBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Stress Test -->
    <div class="card">
      <div class="card-title">Portfolio Stress Test</div>
      <div id="stressTestBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Decision Tracker -->
    <div class="card">
      <div class="card-title">Decision Tracker</div>
      <div id="decisionBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Hedge Recommendations -->
    <div class="card">
      <div class="card-title">Hedge Recommendations</div>
      <div id="hedgeBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Tail Risk -->
    <div class="card">
      <div class="card-title">Tail Risk (90d)</div>
      <div id="tailRiskBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Model Ensemble -->
    <div class="card">
      <div class="card-title">Model Ensemble</div>
      <div id="ensembleBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Regime Forecast -->
    <div class="card">
      <div class="card-title">Regime Forecast</div>
      <div id="regimeForecastBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Factor Attribution -->
    <div class="card">
      <div class="card-title">Factor Importance</div>
      <div id="factorBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- State Snapshots -->
    <div class="card">
      <div class="card-title">State Snapshots</div>
      <div id="snapshotBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Market Microstructure -->
    <div class="card">
      <div class="card-title">Market Microstructure</div>
      <div id="microstructureBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Regime Sizing -->
    <div class="card">
      <div class="card-title">Regime-Adaptive Sizing</div>
      <div id="regimeSizingBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Strategy Compare -->
    <div class="card">
      <div class="card-title">Strategy Replay</div>
      <div id="replayBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Timing Optimizer -->
    <div class="card">
      <div class="card-title">Timing Optimizer</div>
      <div id="timingBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Liquidation Risk -->
    <div class="card">
      <div class="card-title">Liquidation Risk</div>
      <div id="liquidationBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Regime Divergence -->
    <div class="card">
      <div class="card-title">Regime Divergence</div>
      <div id="divergenceBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Liquidity Forecast -->
    <div class="card">
      <div class="card-title">Liquidity Forecast</div>
      <div id="liquidityBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Signal Freshness -->
    <div class="card">
      <div class="card-title">Signal Freshness</div>
      <div id="freshnessBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Execution Quality (Tier 34) -->
    <div class="card">
      <div class="card-title">Execution Quality</div>
      <div id="execQualityBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Portfolio Optimizer (Tier 34) -->
    <div class="card">
      <div class="card-title">Portfolio Optimizer</div>
      <div id="portfolioOptBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Arbitrage Detection (Tier 34) -->
    <div class="card">
      <div class="card-title">Arbitrage Detection</div>
      <div id="arbitrageBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Market Sentiment (Tier 34) -->
    <div class="card">
      <div class="card-title">Market Sentiment</div>
      <div id="sentimentBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Volatility Surface (Tier 35) -->
    <div class="card">
      <div class="card-title">Volatility Surface</div>
      <div id="volSurfaceBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Risk Budgeting (Tier 35) -->
    <div class="card">
      <div class="card-title">Risk Budgeting (VaR)</div>
      <div id="riskBudgetBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Online Learner (Tier 35) -->
    <div class="card">
      <div class="card-title">Online Learner</div>
      <div id="onlineLearnerBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Trade Journal (Tier 35) -->
    <div class="card">
      <div class="card-title">Trade Journal</div>
      <div id="tradeJournalBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Order Algorithms (Tier 36) -->
    <div class="card">
      <div class="card-title">Order Algorithms</div>
      <div id="orderAlgoBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Predictive Breaker (Tier 36) -->
    <div class="card">
      <div class="card-title">Circuit Breaker</div>
      <div id="breakerBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Kalman Fusion (Tier 36) -->
    <div class="card">
      <div class="card-title">Kalman Signal Fusion</div>
      <div id="kalmanBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Market Impact (Tier 36) -->
    <div class="card">
      <div class="card-title">Market Impact</div>
      <div id="impactBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Position Lifecycle (Tier 37) -->
    <div class="card">
      <div class="card-title">Position Lifecycle</div>
      <div id="lifecycleBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Monte Carlo (Tier 37) -->
    <div class="card">
      <div class="card-title">Monte Carlo Backtest</div>
      <div id="monteCarloBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Alert Fatigue (Tier 37) -->
    <div class="card">
      <div class="card-title">Alert Fatigue</div>
      <div id="fatigueBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Strategy Selector (Tier 37) -->
    <div class="card">
      <div class="card-title">Strategy Selector</div>
      <div id="strategySelectorBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Contagion Detector (Tier 38) -->
    <div class="card">
      <div class="card-title">Contagion Risk</div>
      <div id="contagionBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Adaptive Risk Limits (Tier 38) -->
    <div class="card">
      <div class="card-title">Adaptive Risk</div>
      <div id="adaptiveRiskBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Walk-Forward (Tier 38) -->
    <div class="card">
      <div class="card-title">Walk-Forward Validation</div>
      <div id="walkForwardBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Event Impact (Tier 38) -->
    <div class="card">
      <div class="card-title">Event Impact</div>
      <div id="eventImpactBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Portfolio Drift (Tier 39) -->
    <div class="card">
      <div class="card-title">Portfolio Drift</div>
      <div id="driftBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Cost Optimizer (Tier 39) -->
    <div class="card">
      <div class="card-title">Cost Optimization</div>
      <div id="costOptBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Signal Arbiter (Tier 39) -->
    <div class="card">
      <div class="card-title">Signal Arbiter</div>
      <div id="arbiterBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Recovery Predictor (Tier 39) -->
    <div class="card">
      <div class="card-title">Recovery Predictor</div>
      <div id="recoveryPredBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Execution Latency (Tier 40) -->
    <div class="card">
      <div class="card-title">Execution Latency</div>
      <div id="latencyBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Bayesian Posterior (Tier 40) -->
    <div class="card">
      <div class="card-title">Bayesian Posteriors</div>
      <div id="bayesianBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Exit Optimizer (Tier 40) -->
    <div class="card">
      <div class="card-title">Exit Optimizer</div>
      <div id="exitOptBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Basis Tracker (Tier 40) -->
    <div class="card">
      <div class="card-title">Basis Tracker</div>
      <div id="basisBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Hourly Win Rates -->
    <div class="card wide">
      <div class="card-title">Hourly Win Rates (UTC)</div>
      <div id="hourlyBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Audit Timeline -->
    <div class="card wide">
      <div class="card-title">Trade Audit Timeline</div>
      <div id="auditTimelineBlock" style="max-height:280px;overflow-y:auto"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Error Trends -->
    <div class="card wide">
      <div class="card-title">Error Trends (7d)</div>
      <div id="errorBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Subscriber List -->
    <div class="card wide">
      <div class="card-title">
        Subscribers
        <select id="subFilter" onchange="loadSubscribers()" style="margin-left:8px;background:#0e0e16;border:1px solid #1e1e2a;border-radius:4px;color:#9ca3af;font-size:10px;padding:2px 6px">
          <option value="">All Plans</option>
          <option value="free">Free</option>
          <option value="basic">Basic</option>
          <option value="pro">Pro</option>
        </select>
      </div>
      <div id="subscriberList"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Grant Comp Access -->
    <div class="card">
      <div class="card-title">Grant Comp Access</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <input type="email" id="compEmail" placeholder="user@example.com" style="background:#0e0e16;border:1px solid #1e1e2a;border-radius:4px;padding:6px 10px;color:#e5e7eb;font-size:12px;font-family:inherit">
        <div style="display:flex;gap:6px">
          <select id="compPlan" style="background:#0e0e16;border:1px solid #1e1e2a;border-radius:4px;padding:4px 8px;color:#9ca3af;font-size:11px;font-family:inherit">
            <option value="pro">Pro</option>
            <option value="basic">Basic</option>
          </select>
          <input type="number" id="compDays" value="30" min="1" max="365" style="background:#0e0e16;border:1px solid #1e1e2a;border-radius:4px;padding:4px 8px;color:#e5e7eb;font-size:11px;width:60px;font-family:inherit"> days
          <button class="try-btn" onclick="grantComp()">Grant</button>
        </div>
        <div id="compResult" style="font-size:11px;color:#34d399;display:none"></div>
      </div>
    </div>
  </div>
</div>

<div class="footer">PolySignal Admin &mdash; <a href="/">Back to Dashboard</a></div>

<script>
const $ = (id) => document.getElementById(id);

async function loadAdmin() {
  try {
    // Check auth
    const me = await fetch("/api/auth/me").then(r => r.json());
    if (!me.email) { showAuthWall(); return; }

    // Load all data in parallel
    const [health, admin, trends, drift, whQueue, delivery, cacheStats, perf, maint, trading, openExecs, pnl, tradingConfig, analytics, hourlyStats, filterStatsData, auditEvents, attribution, categoryWeights, regimeAnalytics, anomalyData, slippageData, correlationData, experimentsData, execQualityData, healthScoreData, recoveryData, evolutionData, stressData, filterCostData, hedgeData, tailRiskData, ensembleData, regimeForecastData, factorData, snapshotData, microstructureData, regimeSizingData, replayData, timingData, liquidationData, divergenceData, liquidityData, freshnessData, shortfallData, portfolioOptData, arbitrageData, sentimentData, volSurfaceData, varData, onlineLearnerData, patternsData, algoPerf, breakerData, kalmanData, impactData, lifecycleData, monteCarloData, fatigueData, strategyData, contagionData, adaptiveRiskData, walkForwardData, eventImpactData, driftMonData, costOptData, arbiterData, recoveryPredData, latencyData, bayesianData, exitOptData, basisData, regimeMemData, orderRouterData, mmDetectorData, confCalibData] = await Promise.all([
      fetch("/health/detailed").then(r => r.json()),
      fetch("/api/admin/stats").then(r => r.json()).catch(() => null),
      fetch("/api/logs/trends?days=7").then(r => r.json()).catch(() => null),
      fetch("/api/learning/drift-status").then(r => r.json()).catch(() => null),
      fetch("/api/admin/webhook-queue").then(r => r.json()).catch(() => null),
      fetch("/api/admin/delivery-stats").then(r => r.json()).catch(() => null),
      fetch("/api/admin/cache-stats").then(r => r.json()).catch(() => null),
      fetch("/api/admin/perf").then(r => r.json()).catch(() => null),
      fetch("/api/admin/maintenance").then(r => r.json()).catch(() => null),
      fetch("/api/trading/status").then(r => r.json()).catch(() => null),
      fetch("/api/trading/open").then(r => r.json()).catch(() => []),
      fetch("/api/trading/pnl").then(r => r.json()).catch(() => null),
      fetch("/api/trading/config").then(r => r.json()).catch(() => null),
      fetch("/api/trading/analytics").then(r => r.json()).catch(() => null),
      fetch("/api/trading/hourly-stats").then(r => r.json()).catch(() => []),
      fetch("/api/trading/filter-stats").then(r => r.json()).catch(() => null),
      fetch("/api/trading/audit?days=1&limit=25").then(r => r.json()).catch(() => []),
      fetch("/api/trading/attribution?days=30").then(r => r.json()).catch(() => null),
      fetch("/api/trading/category-weights").then(r => r.json()).catch(() => null),
      fetch("/api/signals/regime-analytics?days=30").then(r => r.json()).catch(() => null),
      fetch("/api/trading/anomalies").then(r => r.json()).catch(() => null),
      fetch("/api/trading/slippage?days=30").then(r => r.json()).catch(() => null),
      fetch("/api/portfolio/open-correlations").then(r => r.json()).catch(() => null),
      fetch("/api/experiments").then(r => r.json()).catch(() => null),
      fetch("/api/trading/execution-quality?days=30").then(r => r.json()).catch(() => null),
      fetch("/api/system/health").then(r => r.json()).catch(() => null),
      fetch("/api/system/recovery-log?limit=10").then(r => r.json()).catch(() => null),
      fetch("/api/trading/evolution").then(r => r.json()).catch(() => null),
      fetch("/api/portfolio/stress-test").then(r => r.json()).catch(() => null),
      fetch("/api/trading/filter-cost?days=7").then(r => r.json()).catch(() => null),
      fetch("/api/portfolio/hedge").then(r => r.json()).catch(() => null),
      fetch("/api/portfolio/tail-risk?days=90").then(r => r.json()).catch(() => null),
      fetch("/api/models/ensemble/performance").then(r => r.json()).catch(() => null),
      fetch("/api/regime/forecast").then(r => r.json()).catch(() => null),
      fetch("/api/analytics/factor-importance?days=30").then(r => r.json()).catch(() => null),
      fetch("/api/system/snapshots?limit=10").then(r => r.json()).catch(() => null),
      fetch("/api/analytics/microstructure").then(r => r.json()).catch(() => null),
      fetch("/api/trading/regime-sizing").then(r => r.json()).catch(() => null),
      fetch("/api/analytics/strategy-compare?days=30").then(r => r.json()).catch(() => null),
      fetch("/api/analytics/timing/windows?days=30").then(r => r.json()).catch(() => null),
      fetch("/api/portfolio/liquidation-risk").then(r => r.json()).catch(() => null),
      fetch("/api/analytics/regime-divergence?days=14").then(r => r.json()).catch(() => null),
      fetch("/api/scanner/liquidity-forecast").then(r => r.json()).catch(() => null),
      fetch("/api/signals/freshness-profile").then(r => r.json()).catch(() => null),
      fetch("/api/trading/implementation-shortfall?days=30").then(r => r.json()).catch(() => null),
      fetch("/api/portfolio/optimize").then(r => r.json()).catch(() => null),
      fetch("/api/analytics/arbitrage").then(r => r.json()).catch(() => null),
      fetch("/api/analytics/sentiment").then(r => r.json()).catch(() => null),
      fetch("/api/analytics/volatility-surface").then(r => r.json()).catch(() => null),
      fetch("/api/portfolio/var?days=30").then(r => r.json()).catch(() => null),
      fetch("/api/engines/online-learner").then(r => r.json()).catch(() => null),
      fetch("/api/trading/patterns?days=30").then(r => r.json()).catch(() => null),
      fetch("/api/trading/algorithm-performance?days=14").then(r => r.json()).catch(() => null),
      fetch("/api/trading/breaker-status").then(r => r.json()).catch(() => null),
      fetch("/api/engines/kalman-fusion").then(r => r.json()).catch(() => null),
      fetch("/api/trading/impact-calibration?days=30").then(r => r.json()).catch(() => null),
      fetch("/api/trading/lifecycles").then(r => r.json()).catch(() => null),
      fetch("/api/backtest/monte-carlo?days=30&paths=500").then(r => r.json()).catch(() => null),
      fetch("/api/notifications/fatigue-status").then(r => r.json()).catch(() => null),
      fetch("/api/engines/strategy-allocation").then(r => r.json()).catch(() => null),
      fetch("/api/engines/contagion?days=7").then(r => r.json()).catch(() => null),
      fetch("/api/portfolio/adaptive-risk").then(r => r.json()).catch(() => null),
      fetch("/api/backtest/walk-forward?days=60").then(r => r.json()).catch(() => null),
      fetch("/api/engines/event-impact?days=30").then(r => r.json()).catch(() => null),
      fetch("/api/portfolio/drift").then(r => r.json()).catch(() => null),
      fetch("/api/trading/cost-optimization").then(r => r.json()).catch(() => null),
      fetch("/api/engines/signal-arbiter").then(r => r.json()).catch(() => null),
      fetch("/api/portfolio/recovery").then(r => r.json()).catch(() => null),
      fetch("/api/engines/latency").then(r => r.json()).catch(() => null),
      fetch("/api/engines/bayesian").then(r => r.json()).catch(() => null),
      fetch("/api/trading/exit-optimizer").then(r => r.json()).catch(() => null),
      fetch("/api/trading/basis").then(r => r.json()).catch(() => null),
      fetch("/api/engines/regime-memory").then(r => r.json()).catch(() => null),
      fetch("/api/engines/order-routing").then(r => r.json()).catch(() => null),
      fetch("/api/engines/mm-detector").then(r => r.json()).catch(() => null),
      fetch("/api/engines/confidence-calibrator").then(r => r.json()).catch(() => null)
    ]);

    renderHealth(health);
    if (admin) renderAdmin(admin);
    if (trends) renderErrors(trends);
    if (drift) renderDrift(drift);
    if (whQueue) renderWebhookQueue(whQueue);
    if (delivery) renderDeliveryHealth(delivery);
    if (cacheStats) renderCacheStats(cacheStats);
    if (perf) renderPerfStats(perf);
    if (maint) renderMaintenance(maint);
    if (tradingConfig) renderTradingConfig(tradingConfig);
    if (trading) { trading._openExecutions = openExecs || []; trading._pnl = pnl; renderTrading(trading); }
    if (analytics) renderAnalytics(analytics);
    if (hourlyStats) renderHourly(hourlyStats);
    if (filterStatsData) renderFilterStats(filterStatsData);
    if (auditEvents) renderAuditTimeline(auditEvents);
    if (attribution) renderAttribution(attribution);
    if (categoryWeights) renderCategoryIntel(categoryWeights);
    if (regimeAnalytics) renderHeatmap(regimeAnalytics);
    if (anomalyData) renderAnomalies(anomalyData);
    if (slippageData) renderSlippage(slippageData);
    if (correlationData) renderCorrelation(correlationData);
    if (experimentsData) renderExperiments(experimentsData);
    if (execQualityData) renderExecQuality(execQualityData);
    if (healthScoreData) renderHealthScore(healthScoreData);
    if (recoveryData) renderRecovery(recoveryData);
    if (evolutionData) renderEvolution(evolutionData);
    if (stressData) renderStressTest(stressData);
    if (filterCostData) renderDecisionTracker(filterCostData);
    if (hedgeData) renderHedge(hedgeData);
    if (tailRiskData) renderTailRisk(tailRiskData);
    if (ensembleData) renderEnsemble(ensembleData);
    if (regimeForecastData) renderRegimeForecast(regimeForecastData);
    if (factorData) renderFactors(factorData);
    if (snapshotData) renderSnapshots(snapshotData);
    if (microstructureData) renderMicrostructure(microstructureData);
    if (regimeSizingData) renderRegimeSizing(regimeSizingData);
    if (replayData) renderReplay(replayData);
    if (timingData) renderTiming(timingData);
    if (liquidationData) renderLiquidation(liquidationData);
    if (divergenceData) renderDivergence(divergenceData);
    if (liquidityData) renderLiquidity(liquidityData);
    if (freshnessData) renderFreshness(freshnessData);
    if (shortfallData) renderShortfall(shortfallData);
    if (portfolioOptData) renderPortfolioOpt(portfolioOptData);
    if (arbitrageData) renderArbitrage(arbitrageData);
    if (sentimentData) renderSentiment(sentimentData);
    if (volSurfaceData) renderVolSurface(volSurfaceData);
    if (varData) renderRiskBudget(varData);
    if (onlineLearnerData) renderOnlineLearner(onlineLearnerData);
    if (patternsData) renderTradeJournal(patternsData);
    if (algoPerf) renderOrderAlgo(algoPerf);
    if (breakerData) renderBreaker(breakerData);
    if (kalmanData) renderKalman(kalmanData);
    if (impactData) renderImpact(impactData);
    if (lifecycleData) renderLifecycle(lifecycleData);
    if (monteCarloData) renderMonteCarlo(monteCarloData);
    if (fatigueData) renderFatigue(fatigueData);
    if (strategyData) renderStrategySelector(strategyData);
    if (contagionData) renderContagion(contagionData);
    if (adaptiveRiskData) renderAdaptiveRisk(adaptiveRiskData);
    if (walkForwardData) renderWalkForward(walkForwardData);
    if (eventImpactData) renderEventImpact(eventImpactData);
    if (driftMonData) renderDriftMonitor(driftMonData);
    if (costOptData) renderCostOpt(costOptData);
    if (arbiterData) renderArbiter(arbiterData);
    if (recoveryPredData) renderRecoveryPred(recoveryPredData);
    if (latencyData) renderLatency(latencyData);
    if (bayesianData) renderBayesian(bayesianData);
    if (exitOptData) renderExitOpt(exitOptData);
    if (basisData) renderBasis(basisData);
    if (regimeMemData) renderRegimeMemory(regimeMemData);
    if (orderRouterData) renderOrderRouter(orderRouterData);
    if (mmDetectorData) renderMMDetector(mmDetectorData);
    if (confCalibData) renderConfCalib(confCalibData);
    loadSubscribers();

    $("lastRefresh").textContent = "Updated " + new Date().toLocaleTimeString();
  } catch {
    showAuthWall();
  }
}

function showAuthWall() {
  $("authWall").style.display = "block";
  $("adminContent").style.display = "none";
}

function renderHealth(h) {
  const statusColor = h.status === "healthy" ? "green" : h.status === "degraded" ? "amber" : "red";
  $("sysStatus").innerHTML = `<span class="status-dot ${statusColor === "green" ? "ok" : statusColor === "amber" ? "warn" : "err"}"></span>${h.status || "unknown"}`;
  $("sysUptime").textContent = formatUptime(h.uptime);
  $("sysMem").textContent = h.memory?.heap || "-";
  $("sysWs").textContent = h.wsClients ?? 0;

  // Scanner
  if (h.scanner) {
    $("scTracked").textContent = h.scanner.tracked ?? 0;
    $("scSignals").textContent = h.scanner.withSignal ?? 0;
    $("scCats").textContent = h.scanner.categories ?? 0;
  }

  // Data sources
  const sources = h.sources;
  if (sources && typeof sources === "object") {
    const el = $("sourcesBlock");
    el.innerHTML = Object.entries(sources).map(([name, s]) => {
      const up = s.status === "healthy" || s.uptime > 0.9;
      const dotClass = up ? "ok" : s.status === "degraded" ? "warn" : "err";
      const latency = s.avgLatencyMs != null ? Math.round(s.avgLatencyMs) + "ms" : "-";
      const upPct = s.uptime != null ? (s.uptime * 100).toFixed(1) + "%" : "-";
      return `<div class="source-row">
        <span class="status-dot ${dotClass}"></span>
        <span class="source-name">${esc(name)}</span>
        <span class="source-stats">latency: ${latency} | uptime: ${upPct} | errors: ${s.errors ?? 0}</span>
      </div>`;
    }).join("");
  }
}

function renderAdmin(a) {
  // Signal stats
  const sig = a.signals || {};
  $("sigTotal").textContent = sig.total_signals ?? 0;
  $("sigWinRate").textContent = sig.winRate ? sig.winRate + "%" : "-";
  $("sigRecord").textContent = `${sig.wins ?? 0}W / ${sig.losses ?? 0}L`;
  $("sigPending").textContent = sig.pending ?? 0;
  $("sigEdge").textContent = sig.avg_edge != null ? "+" + (sig.avg_edge * 100).toFixed(1) + "%" : "-";

  // Subscribers
  const sub = a.subscribers || {};
  $("subTotal").textContent = sub.total ?? 0;
  $("subActive").textContent = sub.active ?? 0;
  $("subPro").textContent = sub.pro ?? 0;
  $("subBasic").textContent = sub.basic ?? 0;
  $("subFree").textContent = (sub.total ?? 0) - (sub.pro ?? 0) - (sub.basic ?? 0);
}

function formatUptime(secs) {
  if (!secs) return "-";
  const h = Math.floor(secs / 3600);
  const m = Math.floor((secs % 3600) / 60);
  return h > 0 ? `${h}h ${m}m` : `${m}m`;
}

function renderErrors(t) {
  const el = $("errorBlock");
  if (!t.bySource?.length && !t.daily?.length) {
    el.innerHTML = '<div style="color:#34d399;font-size:12px">No errors in the last 7 days</div>';
    return;
  }
  const sources = (t.bySource || []).map(s =>
    `<div class="kv"><span class="k">${esc(s.source)}</span><span class="v red">${s.count}</span></div>`
  ).join("");
  const levels = (t.byLevel || []).map(l =>
    `<div class="kv"><span class="k">${esc(l.level)}</span><span class="v ${l.level === "error" ? "red" : l.level === "warn" ? "amber" : ""}">${l.count}</span></div>`
  ).join("");
  el.innerHTML = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
    <div><div style="font-size:10px;color:#6b7280;margin-bottom:6px;font-weight:700">BY SOURCE</div>${sources || '<div style="color:#4b5563;font-size:11px">None</div>'}</div>
    <div><div style="font-size:10px;color:#6b7280;margin-bottom:6px;font-weight:700">BY LEVEL</div>${levels || '<div style="color:#4b5563;font-size:11px">None</div>'}</div>
  </div>`;
}

function renderDrift(d) {
  const el = $("driftBlock");
  if (!d.baselineSet) { el.innerHTML = '<div style="color:#4b5563;font-size:12px">No baseline set yet</div>'; return; }
  const sevColor = d.severity === "none" ? "#34d399" : d.severity === "low" ? "#60a5fa" : d.severity === "medium" ? "#fbbf24" : "#f87171";
  let html = `<div class="kv"><span class="k">Severity</span><span class="v" style="color:${sevColor}">${(d.severity || "none").toUpperCase()}</span></div>
    <div class="kv"><span class="k">Checked</span><span class="v">${d.totalChecked ?? 0}</span></div>
    <div class="kv"><span class="k">Drifted</span><span class="v ${d.totalDrifted > 0 ? "red" : ""}">${d.totalDrifted ?? 0}</span></div>
    <div class="kv"><span class="k">Threshold</span><span class="v">${d.driftThreshold ? (d.driftThreshold * 100) + "%" : "20%"}</span></div>`;
  if (d.topDrifts?.length > 0) {
    html += '<div style="font-size:10px;color:#6b7280;font-weight:700;margin-top:8px;margin-bottom:4px">TOP DRIFTS</div>';
    html += d.topDrifts.slice(0, 5).map(dr =>
      `<div class="kv"><span class="k" style="font-size:11px">${esc(dr.feature)}.${esc(dr.value)}</span><span class="v red">${dr.divergencePct}% ${dr.direction}</span></div>`
    ).join("");
  }
  if (d.recommendation) html += `<div style="font-size:11px;color:#9ca3af;margin-top:8px">${esc(d.recommendation)}</div>`;
  el.innerHTML = html;
}

function renderWebhookQueue(q) {
  const el = $("webhookQueueBlock");
  const s = q.status || {};
  let html = `<div class="kv"><span class="k">Pending</span><span class="v amber">${s.pending ?? 0}</span></div>
    <div class="kv"><span class="k">Retrying</span><span class="v amber">${s.retrying ?? 0}</span></div>
    <div class="kv"><span class="k">Delivered</span><span class="v green">${s.delivered ?? 0}</span></div>
    <div class="kv"><span class="k">Failed</span><span class="v red">${s.failed ?? 0}</span></div>
    <div class="kv"><span class="k">Total</span><span class="v">${s.total ?? 0}</span></div>`;
  el.innerHTML = html;
}

async function resetDriftBaseline() {
  try {
    const res = await fetch("/api/learning/drift-baseline", { method: "POST" });
    const data = await res.json();
    if (data.acknowledged) { loadAdmin(); }
  } catch {}
}

function renderDeliveryHealth(d) {
  const el = $("deliveryBlock");
  if (!el) return;
  const byStatus = d.byStatus || [];
  const byChannel = d.byChannel || [];
  let html = "";
  for (const s of byStatus) {
    const color = s.status === "delivered" ? "green" : s.status === "failed" ? "red" : s.status === "throttled" ? "amber" : "";
    html += `<div class="kv"><span class="k">${esc(s.status)}</span><span class="v ${color}">${s.count}</span></div>`;
  }
  if (d.avgLatencyMs != null) html += `<div class="kv"><span class="k">Avg Latency</span><span class="v">${Math.round(d.avgLatencyMs)}ms</span></div>`;
  el.innerHTML = html || '<div style="color:#4b5563;font-size:12px">No delivery data</div>';
}

function renderCacheStats(c) {
  const el = $("cacheBlock");
  if (!el) return;
  el.innerHTML = `
    <div class="kv"><span class="k">Entries</span><span class="v blue">${c.entries ?? 0}</span></div>
    <div class="kv"><span class="k">Hit Rate</span><span class="v green">${c.hitRate ?? 0}%</span></div>
    <div class="kv"><span class="k">Hits / Misses</span><span class="v">${c.hits ?? 0} / ${c.misses ?? 0}</span></div>
  `;
}

async function loadSubscribers() {
  const el = $("subscriberList");
  if (!el) return;
  const plan = $("subFilter")?.value || "";
  const url = "/api/admin/subscribers" + (plan ? "?plan=" + plan : "");
  try {
    const data = await fetch(url).then(r => r.json());
    // Handle both cursor { subscribers, nextCursor } and legacy array
    const subs = data.subscribers || (Array.isArray(data) ? data : []);
    if (subs.length === 0) { el.innerHTML = '<div style="color:#4b5563;font-size:12px">No subscribers found</div>'; return; }
    el.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:11px">
      <thead><tr>
        <th style="text-align:left;padding:6px 8px;color:#4b5563;font-size:9px;text-transform:uppercase;border-bottom:1px solid #1e1e2a">Email</th>
        <th style="text-align:left;padding:6px 8px;color:#4b5563;font-size:9px;text-transform:uppercase;border-bottom:1px solid #1e1e2a">Plan</th>
        <th style="text-align:left;padding:6px 8px;color:#4b5563;font-size:9px;text-transform:uppercase;border-bottom:1px solid #1e1e2a">Status</th>
        <th style="text-align:left;padding:6px 8px;color:#4b5563;font-size:9px;text-transform:uppercase;border-bottom:1px solid #1e1e2a">Platforms</th>
        <th style="text-align:left;padding:6px 8px;color:#4b5563;font-size:9px;text-transform:uppercase;border-bottom:1px solid #1e1e2a">Created</th>
      </tr></thead>
      <tbody>${subs.map(s => {
        const planColor = s.plan === "pro" ? "color:#c084fc" : s.plan === "basic" ? "color:#60a5fa" : "color:#6b7280";
        const statusColor = s.status === "active" ? "color:#34d399" : s.status === "cancelled" ? "color:#f87171" : "color:#fbbf24";
        const platforms = [s.telegram_user_id ? "TG" : null, s.discord_user_id ? "DC" : null].filter(Boolean).join(", ") || "-";
        const created = s.created_at ? new Date(s.created_at).toLocaleDateString() : "-";
        return `<tr style="border-bottom:1px solid #141420">
          <td style="padding:6px 8px;color:#e5e7eb">${esc(s.email)}</td>
          <td style="padding:6px 8px;${planColor};font-weight:600;text-transform:uppercase">${s.plan}</td>
          <td style="padding:6px 8px;${statusColor}">${s.status}</td>
          <td style="padding:6px 8px;color:#6b7280">${platforms}</td>
          <td style="padding:6px 8px;color:#4b5563">${created}</td>
        </tr>`;
      }).join("")}</tbody>
    </table>`;
  } catch {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">Failed to load subscribers</div>';
  }
}

function renderPerfStats(p) {
  const el = $("perfBlock");
  if (!el) return;
  const routes = (p.routes || []).slice(0, 8);
  if (routes.length === 0) { el.innerHTML = '<div style="color:#4b5563;font-size:12px">No data yet</div>'; return; }
  let html = '';
  for (const r of routes) {
    const avgColor = r.avgMs < 50 ? "green" : r.avgMs < 200 ? "amber" : "red";
    html += `<div class="kv"><span class="k" style="font-size:10px">${esc(r.route)}</span><span class="v ${avgColor}">${r.avgMs}ms <span style="color:#4b5563;font-size:9px">(${r.count}x)</span></span></div>`;
  }
  if ((p.slowRequests || []).length > 0) {
    html += `<div class="kv"><span class="k">Slow Requests</span><span class="v red">${p.slowRequests.length}</span></div>`;
  }
  el.innerHTML = html;
}

function renderMaintenance(m) {
  const el = $("maintenanceBlock");
  if (!el) return;
  let html = `<div class="kv"><span class="k">Last Run</span><span class="v">${m.lastRun ? new Date(m.lastRun).toLocaleString() : "Never"}</span></div>`;
  html += `<div class="kv"><span class="k">Total Runs</span><span class="v blue">${m.runCount ?? 0}</span></div>`;
  if (m.lastResults) {
    const r = m.lastResults;
    html += `<div class="kv"><span class="k">Last: Voided</span><span class="v">${r.voided ?? "-"}</span></div>`;
    html += `<div class="kv"><span class="k">Last: Purged</span><span class="v">${r.purgedSignals ?? "-"} signals, ${r.purgedQueue ?? "-"} queue</span></div>`;
  }
  el.innerHTML = html;
}

async function runMaintenance() {
  try {
    const res = await fetch("/api/admin/maintenance/run", { method: "POST" });
    const data = await res.json();
    renderMaintenance({ lastRun: new Date().toISOString(), runCount: "-", lastResults: data });
  } catch {}
}

async function grantComp() {
  const email = $("compEmail")?.value;
  const plan = $("compPlan")?.value || "pro";
  const days = Number($("compDays")?.value) || 30;
  if (!email) return;
  try {
    const res = await fetch("/api/admin/grant-comp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, plan, days })
    });
    const data = await res.json();
    const el = $("compResult");
    if (el) { el.textContent = data.message || "Done"; el.style.display = "block"; }
    loadSubscribers();
  } catch (err) {
    const el = $("compResult");
    if (el) { el.textContent = "Error: " + err.message; el.style.display = "block"; el.style.color = "#f87171"; }
  }
}

function renderTrading(t) {
  const el = $("tradingBlock");
  if (!el) return;
  const r = t.risk || {};
  const m = t.monitor || {};
  const e = t.executionStats || {};
  const c = t.control || {};
  const cbColor = r.circuitBroken ? "red" : "green";
  const pnlColor = r.dailyPnl >= 0 ? "green" : "red";
  const stateColor = c.state === "running" ? "green" : c.state === "paused" ? "amber" : c.state === "draining" ? "blue" : "red";
  let html = `
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:10px">
      <div class="kv"><span class="k">Bot State</span><span class="v ${stateColor}">${(c.state || "unknown").toUpperCase()}</span></div>
      <div class="kv"><span class="k">API</span><span class="v ${t.configured ? "green" : "red"}">${t.configured ? "Configured" : "Not Set"}</span></div>
      <div class="kv"><span class="k">Balance</span><span class="v ${(t.wallet?.balance || 0) > 5 ? "green" : "red"}">$${(t.wallet?.balance || 0).toFixed(2)}</span></div>
      <div class="kv"><span class="k">Circuit</span><span class="v ${cbColor}">${r.circuitBroken ? "BROKEN" : "OK"}</span></div>
      <div class="kv"><span class="k">Monitor</span><span class="v ${m.running ? "green" : "amber"}">${m.running ? "Running" : "Stopped"}</span></div>
    </div>
    <div style="display:flex;gap:6px;margin-bottom:12px">
      <button class="try-btn" style="${c.state === "running" ? "border-color:#34d399;color:#34d399" : ""}" onclick="botControl('resume')">Resume</button>
      <button class="try-btn" style="${c.state === "paused" ? "border-color:#fbbf24;color:#fbbf24" : ""}" onclick="botControl('pause')">Pause</button>
      <button class="try-btn" style="${c.state === "draining" ? "border-color:#60a5fa;color:#60a5fa" : ""}" onclick="botControl('drain')">Drain</button>
      <button class="try-btn" style="${c.state === "stopped" ? "border-color:#f87171;color:#f87171" : ""}" onclick="botControl('stop')">Stop</button>
      <button class="try-btn" style="border-color:#f87171;color:#f87171;margin-left:auto" onclick="liquidateAll()">Liquidate All</button>
    </div>
    <div class="kv"><span class="k">Daily P&L</span><span class="v ${pnlColor}">$${(r.dailyPnl || 0).toFixed(2)} / -$${r.dailyLossLimit || 0} limit</span></div>
    <div class="kv"><span class="k">Open Positions</span><span class="v">${r.openPositions || 0} / ${r.maxPositions || 0}</span></div>
    <div class="kv"><span class="k">Total Trades</span><span class="v blue">${r.totalTrades || 0} (${e.live_trades || 0} live, ${e.dry_runs || 0} dry)</span></div>
    <div class="kv"><span class="k">Total P&L</span><span class="v ${(r.totalPnl || 0) >= 0 ? "green" : "red"}">$${(r.totalPnl || 0).toFixed(2)}</span></div>
    <div class="kv"><span class="k">Win/Loss</span><span class="v">${e.wins || 0}W / ${e.losses || 0}L</span></div>
    <div class="kv"><span class="k">TP / SL</span><span class="v">+${m.takeProfitPct || 0}% / ${m.stopLossPct || 0}%</span></div>
  `;
  // Streak info
  const streak = r.streak || {};
  if (streak.direction && streak.direction !== "none") {
    const sColor = streak.direction === "win" ? "green" : "red";
    const multColor = streak.multiplier < 1 ? "red" : streak.multiplier > 1 ? "green" : "";
    html += `<div class="kv"><span class="k">Streak</span><span class="v ${sColor}">${streak.streak}x ${streak.direction.toUpperCase()} <span style="font-size:9px;color:#6b7280">(${streak.multiplier}x sizing)</span></span></div>`;
  }
  // Exposure & concentration
  const exp = r.exposure || {};
  if (exp.totalExposure != null) {
    const expColor = exp.totalExposure >= (exp.maxExposure || 50) ? "red" : exp.totalExposure > 0 ? "amber" : "green";
    html += `<div class="kv"><span class="k">Total Exposure</span><span class="v ${expColor}">$${(exp.totalExposure || 0).toFixed(2)} / $${exp.maxExposure || 0}</span></div>`;
    if (exp.byCategory && Object.keys(exp.byCategory).length > 0) {
      html += '<div style="margin-top:4px;font-size:9px;color:#4b5563;font-weight:700">CATEGORY EXPOSURE</div>';
      for (const [cat, amt] of Object.entries(exp.byCategory)) {
        const pct = exp.totalExposure > 0 ? (amt / exp.totalExposure * 100).toFixed(0) : 0;
        const warn = (exp.warnings || []).some(w => w.category === cat);
        html += `<div class="kv"><span class="k" style="font-size:10px">${esc(cat)}</span><span class="v ${warn ? "red" : ""}" style="font-size:10px">$${amt.toFixed(2)} (${pct}%)</span></div>`;
      }
    }
  }
  // Unrealized P&L from real-time tracker
  const pnl = t._pnl;
  if (pnl && pnl.aggregate) {
    const a = pnl.aggregate;
    const upnlColor = a.totalUnrealizedPnl >= 0 ? "green" : "red";
    html += `<div class="kv"><span class="k">Unrealized P&L</span><span class="v ${upnlColor}">$${a.totalUnrealizedPnl.toFixed(2)} (${a.positionCount} positions)</span></div>`;
  }
  if (c.reason) html += `<div class="kv"><span class="k">State Reason</span><span class="v" style="color:#6b7280">${esc(c.reason)}</span></div>`;
  // Show open executions from DB with close buttons and live P&L
  const openExecs = t._openExecutions || [];
  const pnlPositions = pnl?.positions || [];
  if (openExecs.length > 0) {
    html += '<div style="margin-top:10px;font-size:10px;color:#4b5563;font-weight:700">OPEN POSITIONS</div>';
    for (const ex of openExecs) {
      const pp = pnlPositions.find(p => p.executionId === ex.id);
      const pnlStr = pp && pp.priceAvailable ? ` | <span style="color:${pp.unrealizedPnlPct >= 0 ? "#34d399" : "#f87171"}">${pp.unrealizedPnlPct >= 0 ? "+" : ""}${pp.unrealizedPnlPct.toFixed(1)}% ($${pp.unrealizedPnlUsd.toFixed(2)})</span>` : "";
      html += `<div style="display:flex;align-items:center;gap:6px;font-size:10px;color:#9ca3af;padding:3px 0;border-bottom:1px solid #141420">
        <span style="flex:1">#${ex.id} ${esc(ex.side)} ${esc(ex.question?.slice(0,40) || ex.market_id?.slice(0,12))} @ ${(ex.entry_price||0).toFixed(3)} ${ex.dry_run ? "[DRY]" : "[LIVE]"}${pnlStr}</span>
        <button class="try-btn" style="font-size:9px;padding:1px 6px;border-color:#f87171;color:#f87171" onclick="closePosition(${ex.id})">Close</button>
      </div>`;
    }
  } else if (m.trades && m.trades.length > 0) {
    html += '<div style="margin-top:8px;font-size:10px;color:#4b5563">Open trades (monitor):</div>';
    for (const tr of m.trades) {
      html += `<div style="font-size:10px;color:#9ca3af;padding:2px 0">${esc(tr.side)} ${esc(tr.marketId?.slice(0,12))} @ ${tr.entryPrice?.toFixed(3)} (${tr.ageMinutes}m) ${tr.dryRun ? "[DRY]" : "[LIVE]"}</div>`;
    }
  }
  el.innerHTML = html;
}

async function botControl(action) {
  try {
    const res = await fetch("/api/trading/control", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action })
    });
    const data = await res.json();
    if (data.ok) loadAdmin();
    else alert(data.error || "Failed");
  } catch (err) { alert("Error: " + err.message); }
}

async function closePosition(id) {
  if (!confirm("Cancel position #" + id + "?")) return;
  try {
    const res = await fetch("/api/trading/close/" + id, { method: "POST" });
    const data = await res.json();
    if (data.ok) loadAdmin();
    else alert(data.error || "Failed");
  } catch (err) { alert("Error: " + err.message); }
}

async function liquidateAll() {
  if (!confirm("Cancel ALL open positions and pause the bot?")) return;
  try {
    const res = await fetch("/api/trading/liquidate-all", { method: "POST" });
    const data = await res.json();
    if (data.ok) { alert("Cancelled " + data.cancelled + " positions. Bot paused."); loadAdmin(); }
    else alert(data.error || "Failed");
  } catch (err) { alert("Error: " + err.message); }
}

const CONFIG_LABELS = {
  max_bet_usd: "Max Bet ($)",
  daily_loss_limit_usd: "Daily Loss Limit ($)",
  max_open_positions: "Max Positions",
  take_profit_pct: "Take Profit (%)",
  stop_loss_pct: "Stop Loss (%)",
  trailing_stop_pct: "Trailing Stop (%)",
  breakeven_trigger_pct: "Breakeven Trigger (%)",
  max_hold_hours: "Max Hold (hours)",
  max_total_exposure_usd: "Max Exposure ($)",
  max_category_concentration_pct: "Max Category (%)",
  max_slippage_pct: "Max Slippage (%)",
  min_balance_usd: "Min Balance ($)",
  min_settlement_minutes: "Min Settlement (min)",
  max_spread: "Max Spread"
};

function renderTradingConfig(cfg) {
  const el = $("configBlock");
  if (!el) return;
  let html = '<div style="display:flex;flex-direction:column;gap:4px">';
  for (const [key, meta] of Object.entries(cfg)) {
    const label = CONFIG_LABELS[key] || key;
    const custom = meta.isCustom ? ' style="color:#c084fc"' : '';
    html += `<div style="display:flex;align-items:center;gap:6px;font-size:11px">
      <span style="color:#6b7280;width:110px;flex-shrink:0">${esc(label)}</span>
      <input type="number" id="cfg_${key}" value="${meta.value}" min="${meta.min}" max="${meta.max}" step="any"
        style="width:70px;background:#0e0e16;border:1px solid #1e1e2a;border-radius:4px;padding:3px 6px;color:#e5e7eb;font-size:11px;font-family:inherit;text-align:right"${custom}>
      <span style="color:#27272f;font-size:9px">${meta.min}-${meta.max}</span>
    </div>`;
  }
  html += '</div>';
  html += '<button class="try-btn" style="margin-top:8px" onclick="saveConfig()">Save Config</button>';
  html += '<div id="configResult" style="font-size:10px;margin-top:4px;display:none"></div>';
  el.innerHTML = html;
}

async function saveConfig() {
  const updates = {};
  for (const key of Object.keys(CONFIG_LABELS)) {
    const input = $("cfg_" + key);
    if (input) updates[key] = Number(input.value);
  }
  try {
    const res = await fetch("/api/trading/config", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(updates)
    });
    const data = await res.json();
    const el = $("configResult");
    if (data.ok) {
      const warnText = (data.warnings || []).map(w => w.warning).join("; ");
      el.innerHTML = "Saved" + (warnText ? `<br><span style="color:#fbbf24;font-size:10px">${esc(warnText)}</span>` : "");
      el.style.color = "#34d399"; el.style.display = "block";
      setTimeout(() => { el.style.display = "none"; }, warnText ? 6000 : 3000);
    } else {
      el.textContent = "Errors: " + (data.errors || []).map(e => e.key + ": " + e.error).join(", ");
      el.style.color = "#f87171"; el.style.display = "block";
    }
  } catch (err) { alert("Error: " + err.message); }
}

function renderAnalytics(a) {
  if (!a || !a.overall) return;
  const o = a.overall;
  const wr = o.win_rate != null ? o.win_rate + "%" : "N/A";
  const wrClass = (o.win_rate || 0) >= 50 ? "green" : "red";
  const pnlClass = (o.total_pnl || 0) >= 0 ? "green" : "red";

  $("analyticsBlock").innerHTML = `
    <div class="kv"><span class="k">Total Trades</span><span class="v">${o.total_trades} (${o.live_trades} live / ${o.dry_runs} dry)</span></div>
    <div class="kv"><span class="k">Win Rate</span><span class="v ${wrClass}">${wr}</span></div>
    <div class="kv"><span class="k">Total P&L</span><span class="v ${pnlClass}">$${(o.total_pnl || 0).toFixed(2)}</span></div>
    <div class="kv"><span class="k">Avg Win / Loss</span><span class="v">$${(o.avg_win || 0).toFixed(2)} / $${(o.avg_loss || 0).toFixed(2)}</span></div>
    <div class="kv"><span class="k">Best / Worst</span><span class="v">$${(o.best_trade || 0).toFixed(2)} / $${(o.worst_trade || 0).toFixed(2)}</span></div>
    <div class="kv"><span class="k">Avg Hold Time</span><span class="v">${a.avgHoldMinutes ? a.avgHoldMinutes.toFixed(0) + " min" : "N/A"}</span></div>
    <div class="kv"><span class="k">Edge Accuracy</span><span class="v">${a.edgeAccuracy?.avg_predicted_edge_pct != null ? "Pred: " + a.edgeAccuracy.avg_predicted_edge_pct + "% / Actual: " + a.edgeAccuracy.avg_actual_pnl_pct + "% (" + a.edgeAccuracy.sample_size + " trades)" : "N/A"}</span></div>
    ${(a.byCategory || []).length > 0 ? '<div style="margin-top:8px;font-size:10px;color:#4b5563;font-weight:700;text-transform:uppercase">By Category</div>' +
      a.byCategory.map(c => `<div class="kv"><span class="k">${esc(c.category)}</span><span class="v">${c.wins}W/${c.losses}L | $${(c.total_pnl || 0).toFixed(2)}</span></div>`).join("") : ""}
  `;

  // Close reasons
  $("closeReasonsBlock").innerHTML = (a.byCloseReason || []).length > 0
    ? a.byCloseReason.map(r => `<div class="kv"><span class="k">${esc(r.reason)}</span><span class="v">${r.count} trades | $${(r.total_pnl || 0).toFixed(2)}</span></div>`).join("")
    : '<div style="color:#4b5563;font-size:12px">No closed trades yet</div>';
}

function renderFilterStats(f) {
  const el = $("filterStatsBlock");
  if (!el) return;
  const passRate = f.signalsReceived > 0 ? ((f.tradesExecuted / f.signalsReceived) * 100).toFixed(1) : "0";
  const labels = { dedup: "Duplicate Market", cooldown: "Cooldown", correlated: "Correlated", settlement: "Settlement", spread: "Wide Spread", chop: "CHOP Regime", risk: "Risk Limit", quality: "Low Quality" };
  let html = `<div class="kv"><span class="k">Signals In</span><span class="v blue">${f.signalsReceived}</span></div>
    <div class="kv"><span class="k">Trades Out</span><span class="v green">${f.tradesExecuted}</span></div>
    <div class="kv"><span class="k">Pass Rate</span><span class="v">${passRate}%</span></div>
    <div class="kv"><span class="k">Total Filtered</span><span class="v amber">${f.totalFiltered}</span></div>`;
  for (const [key, label] of Object.entries(labels)) {
    const val = f[key] || 0;
    if (val > 0) html += `<div class="kv"><span class="k" style="font-size:10px">${label}</span><span class="v red" style="font-size:10px">${val}</span></div>`;
  }
  el.innerHTML = html;
}

function renderHourly(data) {
  const el = $("hourlyBlock");
  if (!el || !Array.isArray(data)) return;
  if (data.length === 0) { el.innerHTML = '<div style="color:#4b5563;font-size:12px">No hourly data yet</div>'; return; }
  const byHour = {};
  for (const d of data) byHour[d.hour] = d;
  let html = '<div style="display:flex;gap:2px;flex-wrap:wrap">';
  for (let h = 0; h < 24; h++) {
    const d = byHour[h];
    const wr = d?.win_rate;
    const n = d ? (d.wins || 0) + (d.losses || 0) : 0;
    let bg = "#1e1e2a"; let fg = "#4b5563";
    if (n >= 5) {
      if (wr >= 65) { bg = "#34d39930"; fg = "#34d399"; }
      else if (wr < 40) { bg = "#f8717130"; fg = "#f87171"; }
      else { bg = "#fbbf2420"; fg = "#fbbf24"; }
    }
    html += `<div title="${h}:00 UTC — ${n > 0 ? wr?.toFixed(0) + '% WR (' + n + ' trades)' : 'No data'}" style="width:30px;height:36px;background:${bg};border-radius:4px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:9px;cursor:default">
      <span style="color:${fg};font-weight:700">${h}</span>
      <span style="color:${n >= 5 ? fg : '#27272f'};font-size:8px">${n > 0 ? (wr?.toFixed(0) || "?") + "%" : "-"}</span>
    </div>`;
  }
  html += '</div>';
  el.innerHTML = html;
}

function renderAttribution(a) {
  const el = $("attributionBlock");
  if (!el) return;
  let html = '';

  // Quality tier attribution (most important)
  if (a.byQuality?.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-bottom:4px">BY QUALITY</div>';
    for (const q of a.byQuality) {
      const wrColor = (q.win_rate || 0) >= 55 ? "green" : (q.win_rate || 0) < 45 ? "red" : "amber";
      const pnlColor = (q.total_pnl || 0) >= 0 ? "green" : "red";
      html += `<div class="kv"><span class="k" style="font-size:10px">Q:${q.tier}</span><span class="v" style="font-size:10px"><span class="${wrColor}">${q.win_rate ?? "-"}%</span> | <span class="${pnlColor}">$${(q.total_pnl || 0).toFixed(2)}</span> <span style="color:#4b5563">(${q.trades})</span></span></div>`;
    }
  }

  // Regime attribution
  if (a.byRegime?.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:8px;margin-bottom:4px">BY REGIME</div>';
    for (const r of a.byRegime) {
      const pnlColor = (r.total_pnl || 0) >= 0 ? "green" : "red";
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(r.regime)}</span><span class="v" style="font-size:10px">${r.win_rate ?? "-"}% WR | <span class="${pnlColor}">$${(r.total_pnl || 0).toFixed(2)}</span></span></div>`;
    }
  }

  // Strength attribution
  if (a.byStrength?.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:8px;margin-bottom:4px">BY STRENGTH</div>';
    for (const s of a.byStrength) {
      const pnlColor = (s.total_pnl || 0) >= 0 ? "green" : "red";
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(s.strength)}</span><span class="v" style="font-size:10px">${s.win_rate ?? "-"}% | <span class="${pnlColor}">$${(s.total_pnl || 0).toFixed(2)}</span></span></div>`;
    }
  }

  el.innerHTML = html || '<div style="color:#4b5563;font-size:12px">No attribution data yet</div>';
}

function renderCategoryIntel(data) {
  const el = $("categoryBlock");
  if (!el) return;
  let html = '';

  // Category confidence & Kelly adjustments table
  const confAdj = { crypto: "+5", Bitcoin: "+5", Ethereum: "+5", Sports: "-5", Esports: "-5", Tennis: "-5", Politics: "-5", Weather: "-3", Economics: "-3" };
  const kellyMult = { crypto: "1.0x", Bitcoin: "1.0x", Ethereum: "1.0x", Sports: "0.8x", Esports: "0.8x", Tennis: "0.8x", Politics: "0.7x", Weather: "0.6x", Economics: "0.7x" };

  html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-bottom:4px">CATEGORY TUNING</div>';
  for (const cat of Object.keys(confAdj)) {
    const adj = confAdj[cat];
    const kelly = kellyMult[cat];
    const adjColor = adj.startsWith("+") ? "#34d399" : "#f87171";
    html += `<div class="kv"><span class="k" style="font-size:10px">${esc(cat)}</span><span class="v" style="font-size:10px"><span style="color:${adjColor}">${adj}pts</span> | Kelly ${kelly}</span></div>`;
  }

  // Category-specific learned weights
  const cats = data.categories || {};
  const catCount = data.categoryCount || 0;
  if (catCount > 0) {
    html += `<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:10px;margin-bottom:4px">LEARNED WEIGHTS (${catCount} categories)</div>`;
    for (const [cat, weights] of Object.entries(cats)) {
      const featureCount = Object.keys(weights).length;
      const totalValues = Object.values(weights).reduce((s, f) => s + Object.keys(f).length, 0);
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(cat)}</span><span class="v" style="font-size:10px">${featureCount} features, ${totalValues} weights</span></div>`;
    }
  } else {
    html += '<div style="font-size:9px;color:#4b5563;margin-top:10px">Category weights: awaiting sufficient data (20+ settled per category)</div>';
  }

  // Global model info
  html += `<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:10px;margin-bottom:4px">GLOBAL MODEL</div>`;
  html += `<div class="kv"><span class="k" style="font-size:10px">Source</span><span class="v" style="font-size:10px">${esc(data.global?.source || "default")}</span></div>`;
  html += `<div class="kv"><span class="k" style="font-size:10px">Version</span><span class="v" style="font-size:10px">v${data.global?.modelVersion || 0}</span></div>`;

  el.innerHTML = html;
}

function renderAuditTimeline(events) {
  const el = $("auditTimelineBlock");
  if (!el) return;
  const list = Array.isArray(events) ? events : [];
  if (list.length === 0) { el.innerHTML = '<div style="color:#4b5563;font-size:12px">No audit events today</div>'; return; }

  const colors = {
    ORDER_PLACED: "#a78bfa", ORDER_FILLED: "#34d399", ORDER_PARTIAL_FILL: "#fbbf24",
    ORDER_REJECTED: "#f87171", ORDER_FILL_FAILED: "#f87171", ORDER_FILL_ERROR: "#f87171",
    POSITION_OPENED: "#34d399", POSITION_CLOSED: "#60a5fa", POSITION_AUTO_REPAIRED: "#fbbf24",
    RISK_BLOCKED: "#f87171", CIRCUIT_BREAKER: "#f87171", BOT_STATE_CHANGE: "#c084fc",
    CONFIG_CHANGE: "#c084fc", SETTLEMENT: "#60a5fa"
  };

  let html = '';
  for (const evt of list) {
    const color = colors[evt.event_type] || "#6b7280";
    const time = evt.created_at ? new Date(evt.created_at).toLocaleTimeString() : "";
    const dryTag = evt.dry_run ? '<span style="color:#6b7280;font-size:9px">[DRY]</span>' : '';
    const amtStr = evt.amount ? `$${Number(evt.amount).toFixed(2)}` : "";
    const pnlStr = evt.pnl_usd != null ? ` <span style="color:${evt.pnl_usd >= 0 ? "#34d399" : "#f87171"}">${evt.pnl_usd >= 0 ? "+" : ""}$${Number(evt.pnl_usd).toFixed(2)}</span>` : "";
    let detail = "";
    try { const d = evt.detail ? JSON.parse(evt.detail) : {}; detail = d.quality ? `Q:${d.quality}` : ""; } catch { detail = ""; }
    const sideTag = evt.side ? `<span style="color:${evt.side === "UP" ? "#34d399" : "#f87171"};font-weight:600">${evt.side}</span>` : "";

    html += `<div style="display:flex;gap:8px;padding:4px 0;border-bottom:1px solid #141420;align-items:baseline;font-size:11px">
      <span style="color:#4b5563;min-width:65px;font-size:10px">${time}</span>
      <span style="color:${color};font-weight:600;min-width:140px;font-size:10px">${esc(evt.event_type)}</span>
      <span style="color:#9ca3af;flex:1">${sideTag} ${amtStr}${pnlStr} ${detail} ${dryTag}</span>
      <span style="color:#27272f;font-size:9px">#${evt.execution_id || "-"}</span>
    </div>`;
  }
  el.innerHTML = html;
}

function esc(s) { if (!s) return ""; const el = document.createElement("span"); el.textContent = s; return el.innerHTML; }

// --- WebSocket: live trade events ---
const MAX_FEED_ITEMS = 50;
let ws = null;
let wsReconnectTimer = null;

function connectWs() {
  const proto = location.protocol === "https:" ? "wss:" : "ws:";
  ws = new WebSocket(`${proto}//${location.host}/ws`);

  ws.onopen = () => {
    const badge = $("wsBadge");
    if (badge) { badge.textContent = "LIVE"; badge.style.background = "#34d39920"; badge.style.color = "#34d399"; }
  };

  ws.onclose = () => {
    const badge = $("wsBadge");
    if (badge) { badge.textContent = "OFFLINE"; badge.style.background = "#f8717120"; badge.style.color = "#f87171"; }
    wsReconnectTimer = setTimeout(connectWs, 5000);
  };

  ws.onerror = () => ws.close();

  ws.onmessage = (evt) => {
    try {
      const msg = JSON.parse(evt.data);
      if (msg.type === "trade") handleTradeEvent(msg);
    } catch {}
  };
}

function handleTradeEvent(msg) {
  const feed = $("tradeFeed");
  if (!feed) return;

  // Remove placeholder text on first event
  if (feed.children.length === 1 && feed.children[0].tagName !== "DIV") { /* keep */ }
  if (feed.querySelector("[data-placeholder]")) feed.querySelector("[data-placeholder]").remove();

  const colors = {
    POSITION_OPENED: "#34d399", POSITION_CLOSED: "#60a5fa", PARTIAL_EXIT: "#c084fc", ORDER_PLACED: "#a78bfa",
    ORDER_FILLED: "#34d399", TRAILING_STOP: "#fbbf24", BREAKEVEN_STOP: "#fbbf24",
    RISK_BLOCKED: "#f87171", CLOB_UNREACHABLE: "#f87171", CONFIG_CHANGE: "#c084fc"
  };

  const color = colors[msg.event] || "#6b7280";
  const time = new Date(msg.timestamp).toLocaleTimeString();
  let detail = "";

  if (msg.event === "POSITION_OPENED") {
    const qBadge = msg.quality != null ? `<span style="color:#a78bfa;font-weight:700">Q:${msg.quality}</span> ` : "";
    const rBadge = msg.regime ? `<span style="color:#6b7280">[${msg.regime}]</span> ` : "";
    const catBadge = msg.category ? `<span style="color:#818cf8;font-size:9px">${esc(msg.category)}</span> ` : "";
    const mhColor = msg.microHealth >= 65 ? "#34d399" : msg.microHealth >= 40 ? "#fbbf24" : "#f87171";
    const mhBadge = msg.microHealth != null ? `<span style="color:${mhColor};font-size:9px">MH:${msg.microHealth}</span> ` : "";
    detail = `${qBadge}${rBadge}${catBadge}${mhBadge}${msg.side} on ${esc((msg.question || msg.marketId || "").slice(0, 40))} | $${(msg.amount || 0).toFixed(2)} @ ${(msg.price || 0).toFixed(3)}${msg.dryRun ? " [DRY]" : ""}`;
  } else if (msg.event === "POSITION_CLOSED") {
    const pnl = msg.pnlUsd || 0;
    detail = `${msg.closeReason} | ${msg.side} | P&L: ${pnl >= 0 ? "+" : ""}$${pnl.toFixed(2)} (${(msg.pnlPct || 0).toFixed(1)}%) | held ${msg.holdMinutes || 0}m`;
  } else if (msg.event === "PARTIAL_EXIT") {
    const pnl = msg.pnlUsd || 0;
    detail = `Scale-out $${(msg.partialSize || 0).toFixed(2)} | P&L: ${pnl >= 0 ? "+" : ""}$${pnl.toFixed(2)} | remaining: $${(msg.remainingSize || 0).toFixed(2)}`;
  } else if (msg.event === "ORDER_PLACED") {
    detail = `${msg.side} $${(msg.amount || 0).toFixed(2)} @ ${(msg.price || 0).toFixed(3)}`;
  } else if (msg.event === "CLOB_UNREACHABLE") {
    detail = `${msg.consecutiveFailures} consecutive failures`;
  } else if (msg.event === "CONFIG_CHANGE") {
    detail = JSON.stringify(msg.changes || {}).slice(0, 80);
  } else {
    detail = msg.marketId || "";
  }

  const row = document.createElement("div");
  row.style.cssText = "display:flex;gap:8px;padding:4px 0;border-bottom:1px solid #141420;align-items:baseline";
  row.innerHTML = `<span style="color:#4b5563;min-width:65px">${time}</span><span style="color:${color};font-weight:600;min-width:130px">${esc(msg.event)}</span><span style="color:#9ca3af;flex:1">${detail}</span>`;
  feed.prepend(row);

  // Trim old entries
  while (feed.children.length > MAX_FEED_ITEMS) feed.removeChild(feed.lastChild);

  // Auto-refresh positions on trade events
  if (msg.event === "POSITION_OPENED" || msg.event === "POSITION_CLOSED") {
    loadAdmin();
  }
}

function renderHeatmap(data) {
  const el = $("heatmapBlock");
  if (!el) return;
  const matrix = data.regimeCategoryMatrix || [];
  if (matrix.length === 0) { el.innerHTML = '<div style="color:#4b5563;font-size:12px">No regime×category data yet</div>'; return; }

  // Build matrix: rows = regimes, cols = categories
  const regimes = [...new Set(matrix.map(m => m.regime))];
  const categories = [...new Set(matrix.map(m => m.category))];
  const lookup = {};
  for (const m of matrix) lookup[m.regime + "|" + m.category] = m;

  let html = '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:10px">';
  html += '<tr><th style="text-align:left;padding:4px;color:#6b7280"></th>';
  for (const cat of categories) html += `<th style="padding:4px;color:#6b7280;font-weight:600;min-width:60px">${esc(cat?.slice(0,10) || "?")}</th>`;
  html += '</tr>';

  for (const reg of regimes) {
    html += `<tr><td style="padding:4px;color:#9ca3af;font-weight:600">${esc(reg)}</td>`;
    for (const cat of categories) {
      const cell = lookup[reg + "|" + cat];
      if (cell) {
        const wr = cell.winRate || 0;
        const bg = wr >= 60 ? "#065f4620" : wr >= 45 ? "#78350f20" : "#7f1d1d20";
        const color = wr >= 60 ? "#34d399" : wr >= 45 ? "#fbbf24" : "#f87171";
        html += `<td style="padding:4px;text-align:center;background:${bg}"><span style="color:${color};font-weight:700">${wr}%</span><br><span style="color:#4b5563;font-size:9px">${cell.total}t</span></td>`;
      } else {
        html += '<td style="padding:4px;text-align:center;color:#374151">-</td>';
      }
    }
    html += '</tr>';
  }
  html += '</table></div>';
  el.innerHTML = html;
}

function renderAnomalies(data) {
  const el = $("anomalyBlock");
  if (!el) return;
  const sevColors = { none: "#34d399", warning: "#fbbf24", critical: "#f87171" };
  const sevColor = sevColors[data.severity] || "#6b7280";
  let html = `<div class="kv"><span class="k">Status</span><span class="v" style="color:${sevColor};font-weight:700">${(data.severity || "none").toUpperCase()}</span></div>`;

  if (data.recent) {
    html += `<div class="kv"><span class="k">Recent (${data.recent.trades}t)</span><span class="v">${data.recent.winRate ?? "-"}% WR | Sharpe ${data.recent.sharpe ?? "-"}</span></div>`;
  }
  if (data.baseline) {
    html += `<div class="kv"><span class="k">Baseline (${data.baseline.trades}t)</span><span class="v">${data.baseline.winRate ?? "-"}% WR | Sharpe ${data.baseline.sharpe ?? "-"}</span></div>`;
  }

  for (const a of (data.anomalies || [])) {
    const ac = a.severity === "critical" ? "#f87171" : "#fbbf24";
    html += `<div style="margin-top:6px;padding:6px 8px;background:${a.severity === "critical" ? "#7f1d1d15" : "#78350f15"};border-radius:6px;border-left:3px solid ${ac}"><div style="font-size:10px;color:${ac};font-weight:700">${esc(a.type.replace(/_/g, " ").toUpperCase())}</div><div style="font-size:10px;color:#9ca3af;margin-top:2px">${esc(a.detail)}</div></div>`;
  }

  if ((data.anomalies || []).length === 0) {
    html += '<div style="margin-top:6px;font-size:11px;color:#34d399">All systems nominal</div>';
  }

  html += `<div style="margin-top:6px;font-size:9px;color:#4b5563">${esc(data.recommendation || "")}</div>`;
  el.innerHTML = html;
}

function renderSlippage(data) {
  const el = $("slippageBlock");
  if (!el) return;
  const o = data.overall || {};
  if (!o.trades) { el.innerHTML = '<div style="color:#4b5563;font-size:12px">No slippage data yet</div>'; return; }

  let html = `<div class="kv"><span class="k">Trades analyzed</span><span class="v">${o.trades}</span></div>`;
  html += `<div class="kv"><span class="k">Avg slippage</span><span class="v">${o.avg_abs_slippage ?? "-"}</span></div>`;
  html += `<div class="kv"><span class="k">Max slippage</span><span class="v">${o.max_slippage ?? "-"}</span></div>`;
  html += `<div class="kv"><span class="k">Worse/Better/Exact</span><span class="v">${o.worse_fills || 0}/${o.better_fills || 0}/${o.exact_fills || 0}</span></div>`;

  if (data.bySize?.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:8px;margin-bottom:4px">BY SIZE</div>';
    for (const s of data.bySize) {
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(s.size_bucket)}</span><span class="v" style="font-size:10px">${s.avg_slippage ?? "-"} (${s.trades}t)</span></div>`;
    }
  }

  el.innerHTML = html;
}

function renderCorrelation(data) {
  const el = $("correlationBlock");
  if (!el) return;
  if (!data || data.positions < 2) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">Need 2+ open positions for correlation analysis</div>';
    return;
  }

  const riskColors = { low: "green", medium: "amber", high: "red" };
  let html = `<div class="kv"><span class="k">Open positions</span><span class="v">${data.positions}</span></div>`;
  html += `<div class="kv"><span class="k">Risk level</span><span class="v ${riskColors[data.riskLevel] || ""}">${(data.riskLevel || "low").toUpperCase()}</span></div>`;

  if (data.correlatedPairs?.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:8px;margin-bottom:4px">CORRELATED PAIRS</div>';
    for (const p of data.correlatedPairs.slice(0, 5)) {
      const color = p.correlation >= 0.7 ? "red" : "amber";
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(p.marketA.slice(0, 20))}</span><span class="v ${color}" style="font-size:10px">r=${p.correlation.toFixed(2)}</span></div>`;
    }
  } else {
    html += '<div style="color:#34d399;font-size:11px;margin-top:6px">No high correlations detected</div>';
  }

  el.innerHTML = html;
}

function renderExperiments(data) {
  const el = $("experimentsBlock");
  if (!el) return;
  if (!Array.isArray(data) || data.length === 0) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No experiments yet</div>';
    return;
  }

  let html = "";
  for (const exp of data.slice(0, 5)) {
    const statusColors = { active: "green", completed: "blue", paused: "amber" };
    const badge = `<span class="v ${statusColors[exp.status] || ""}" style="font-size:10px">${exp.status.toUpperCase()}</span>`;
    html += `<div class="kv"><span class="k" style="font-size:10px">${esc(exp.name)}</span>${badge}</div>`;
    html += `<div class="kv"><span class="k" style="font-size:10px;padding-left:8px">Samples / Arms</span><span class="v" style="font-size:10px">${exp.totalSamples} / ${exp.armCount}</span></div>`;
    if (exp.winner) {
      html += `<div class="kv"><span class="k" style="font-size:10px;padding-left:8px">Winner</span><span class="v green" style="font-size:10px">${esc(exp.winner)}</span></div>`;
    }
  }

  el.innerHTML = html;
}

function renderExecQuality(data) {
  const el = $("execQualityBlock");
  if (!el) return;
  if (!data || !data.overall || data.overall.totalExecutions === 0) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No latency data yet</div>';
    return;
  }

  const o = data.overall;
  const scoreColor = data.qualityScore >= 70 ? "green" : data.qualityScore >= 40 ? "amber" : "red";
  let html = `<div class="kv"><span class="k">Quality Score</span><span class="v ${scoreColor}" style="font-size:14px;font-weight:700">${data.qualityScore}/100</span></div>`;
  html += `<div class="kv"><span class="k">Avg latency</span><span class="v">${o.avgLatency ?? "-"}ms</span></div>`;
  html += `<div class="kv"><span class="k">P50 / P95 / P99</span><span class="v">${o.p50 ?? "-"} / ${o.p95 ?? "-"} / ${o.p99 ?? "-"}ms</span></div>`;
  html += `<div class="kv"><span class="k">Fill rate</span><span class="v ${(data.fillRate || 0) >= 80 ? "green" : "amber"}">${data.fillRate ?? "-"}%</span></div>`;

  if (data.fillStats) {
    html += `<div class="kv"><span class="k">Filled / Failed</span><span class="v">${data.fillStats.filled || 0} / ${data.fillStats.failed || 0}</span></div>`;
  }

  el.innerHTML = html;
}

function renderHealthScore(data) {
  const el = $("healthScoreBlock");
  if (!el) return;
  if (!data || data.score == null) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No health data</div>';
    return;
  }

  const sc = data.score;
  const level = sc >= 80 ? "healthy" : sc >= 50 ? "degraded" : sc >= 30 ? "unhealthy" : "critical";
  const color = sc >= 80 ? "green" : sc >= 50 ? "amber" : "red";
  let html = `<div class="kv"><span class="k">Score</span><span class="v ${color}" style="font-size:16px;font-weight:700">${sc}/100</span></div>`;
  html += `<div class="kv"><span class="k">Status</span><span class="v ${color}">${level}</span></div>`;

  if (data.components) {
    const c = data.components;
    if (c.memory) html += `<div class="kv"><span class="k">Memory</span><span class="v">${c.memory.heapUsedMB}/${c.memory.heapTotalMB}MB (${c.memory.usagePct}%)</span></div>`;
    if (c.errors) html += `<div class="kv"><span class="k">Error rate</span><span class="v ${c.errors.score < 50 ? "red" : ""}">${(c.errors.errorRate * 100).toFixed(1)}%</span></div>`;
    if (c.freshness) html += `<div class="kv"><span class="k">Data fresh</span><span class="v ${c.freshness.isStale ? "red" : "green"}">${c.freshness.isStale ? "STALE" : "OK"}</span></div>`;
  }

  if (data.alerts && data.alerts.length > 0) {
    html += `<div style="margin-top:8px;font-size:11px;color:#f87171">${data.alerts.map(a => "⚠ " + a).join("<br>")}</div>`;
  }

  el.innerHTML = html;
}

function renderRecovery(data) {
  const el = $("recoveryBlock");
  if (!el) return;
  if (!data || !data.entries || data.entries.length === 0) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No recovery actions taken</div>';
    return;
  }

  let html = `<div class="kv"><span class="k">Total recoveries</span><span class="v amber">${data.totalRecoveries || 0}</span></div>`;
  if (data.lastRecoveryAt) {
    html += `<div class="kv"><span class="k">Last recovery</span><span class="v">${new Date(data.lastRecoveryAt).toLocaleTimeString()}</span></div>`;
  }

  const recent = data.entries.slice(0, 5);
  for (const e of recent) {
    const color = e.success ? "green" : "red";
    html += `<div class="kv"><span class="k" style="font-size:10px">${e.action}</span><span class="v ${color}" style="font-size:10px">score ${e.health_score} | ${e.success ? "ok" : "fail"}</span></div>`;
  }

  el.innerHTML = html;
}

function renderEvolution(data) {
  const el = $("evolutionBlock");
  if (!el) return;
  if (!data) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No evolution data</div>';
    return;
  }

  let html = `<div class="kv"><span class="k">Generation</span><span class="v blue">${data.generation}</span></div>`;
  html += `<div class="kv"><span class="k">Population</span><span class="v">${data.populationSize}</span></div>`;

  if (data.bestEver) {
    const p = data.bestEver.params;
    const f = data.bestEver.fitness;
    html += `<div class="kv"><span class="k">Best fitness</span><span class="v green">${f?.score ?? "-"}</span></div>`;
    html += `<div class="kv"><span class="k">Best conf</span><span class="v">${p.minConfidence}</span></div>`;
    html += `<div class="kv"><span class="k">Best edge</span><span class="v">${(p.minEdge * 100).toFixed(1)}%</span></div>`;
    html += `<div class="kv"><span class="k">Best sizing</span><span class="v">${p.sizingMultiplier}x</span></div>`;
  } else {
    html += '<div style="color:#4b5563;font-size:11px;margin-top:6px">Waiting for trade data to evolve</div>';
  }

  el.innerHTML = html;
}

function renderStressTest(data) {
  const el = $("stressTestBlock");
  if (!el) return;
  if (!data || !data.scenarios || data.scenarios.length === 0) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No open positions to stress test</div>';
    return;
  }

  let html = `<div class="kv"><span class="k">Positions</span><span class="v">${data.portfolio.positions}</span></div>`;
  html += `<div class="kv"><span class="k">Exposure</span><span class="v">$${data.portfolio.totalExposure}</span></div>`;

  if (data.worstCase) {
    html += `<div class="kv"><span class="k">Worst case</span><span class="v red">${data.worstCase.name}: $${data.worstCase.loss}</span></div>`;
  }

  for (const s of data.scenarios.slice(0, 3)) {
    const color = s.totalImpact < -5 ? "red" : s.totalImpact < 0 ? "amber" : "green";
    html += `<div class="kv"><span class="k" style="font-size:10px">${s.name}</span><span class="v ${color}" style="font-size:10px">$${s.totalImpact} (${s.impactPct}%)</span></div>`;
  }

  el.innerHTML = html;
}

function renderDecisionTracker(data) {
  const el = $("decisionBlock");
  if (!el) return;
  if (!data) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No decision data</div>';
    return;
  }

  let html = `<div class="kv"><span class="k">Pass rate</span><span class="v ${data.passRate > 10 ? "green" : "amber"}">${data.passRate}%</span></div>`;
  html += `<div class="kv"><span class="k">Executed / Blocked</span><span class="v">${data.totalExecuted} / ${data.totalBlocked}</span></div>`;

  for (const g of (data.byGate || []).slice(0, 4)) {
    html += `<div class="kv"><span class="k" style="font-size:10px">${g.gate || "unknown"}</span><span class="v" style="font-size:10px">${g.blocked} (${g.pctOfTotal}%)</span></div>`;
  }

  el.innerHTML = html;
}

function renderHedge(data) {
  const el = $("hedgeBlock");
  if (!el) return;
  if (!data || data.recommendations.length === 0) {
    const msg = data?.riskScore === 0 ? "No hedges needed" : "No open positions";
    el.innerHTML = `<div style="color:#4b5563;font-size:12px">${msg}</div>`;
    return;
  }

  const riskColor = data.riskLevel === "high" ? "red" : data.riskLevel === "medium" ? "amber" : "green";
  let html = `<div class="kv"><span class="k">Risk score</span><span class="v ${riskColor}">${data.riskScore}/100</span></div>`;
  html += `<div class="kv"><span class="k">Exposure</span><span class="v">$${data.exposure.total} (${data.exposure.positions} pos)</span></div>`;

  for (const r of data.recommendations.slice(0, 3)) {
    const prioColor = r.priority === "high" ? "red" : r.priority === "medium" ? "amber" : "";
    html += `<div style="margin-top:6px;font-size:10px;color:#9ca3af"><span class="v ${prioColor}" style="font-size:9px;text-transform:uppercase">${r.priority}</span> ${r.action}</div>`;
  }

  el.innerHTML = html;
}

function renderTailRisk(data) {
  const el = $("tailRiskBlock");
  if (!el) return;
  if (!data || data.insufficient) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">Insufficient data (&lt;5 trading days)</div>';
    return;
  }

  let html = `<div class="kv"><span class="k">95th pctl loss</span><span class="v red">$${data.p95Loss}</span></div>`;
  html += `<div class="kv"><span class="k">99th pctl loss</span><span class="v red">$${data.p99Loss}</span></div>`;
  html += `<div class="kv"><span class="k">Max daily loss</span><span class="v red">$${data.maxDailyLoss}</span></div>`;
  html += `<div class="kv"><span class="k">Avg daily P&L</span><span class="v ${data.avgDailyPnl >= 0 ? "green" : "red"}">$${data.avgDailyPnl}</span></div>`;
  html += `<div class="kv"><span class="k">Daily Sharpe</span><span class="v">${data.dailySharpe}</span></div>`;
  html += `<div class="kv"><span class="k">Trading days</span><span class="v">${data.tradingDays}</span></div>`;

  el.innerHTML = html;
}

function renderEnsemble(data) {
  const el = $("ensembleBlock");
  if (!el) return;
  if (!data || !data.models) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No ensemble data</div>';
    return;
  }

  let html = '';
  for (const m of data.models) {
    const accColor = (m.accuracy || 0) >= 0.55 ? "green" : (m.accuracy || 0) >= 0.45 ? "amber" : "red";
    html += `<div class="kv"><span class="k" style="font-size:10px">${esc(m.name)}</span><span class="v" style="font-size:10px">w: ${(m.weight || 0).toFixed(3)} | <span class="${accColor}">${((m.accuracy || 0) * 100).toFixed(1)}%</span> (${m.predictions || 0})</span></div>`;
  }

  if (data.agreement != null) {
    const agColor = data.agreement >= 0.7 ? "green" : data.agreement >= 0.5 ? "amber" : "red";
    html += `<div class="kv"><span class="k">Agreement</span><span class="v ${agColor}">${(data.agreement * 100).toFixed(0)}%</span></div>`;
  }

  el.innerHTML = html;
}

function renderRegimeForecast(data) {
  const el = $("regimeForecastBlock");
  if (!el) return;
  if (!data || !data.predicted) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No forecast data</div>';
    return;
  }

  const regColors = { TREND_UP: "green", TREND_DOWN: "red", RANGE: "blue", CHOP: "amber" };
  const curColor = regColors[data.currentRegime] || "";
  const predColor = regColors[data.predicted] || "";
  let html = `<div class="kv"><span class="k">Current</span><span class="v ${curColor}">${data.currentRegime || "-"}</span></div>`;
  html += `<div class="kv"><span class="k">Predicted</span><span class="v ${predColor}">${data.predicted}</span></div>`;
  html += `<div class="kv"><span class="k">Confidence</span><span class="v">${data.confidence || 0}%</span></div>`;

  if (data.probabilities) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">PROBABILITIES</div>';
    for (const [regime, prob] of Object.entries(data.probabilities)) {
      const barWidth = Math.round(prob * 100);
      const c = regColors[regime] || "";
      html += `<div class="kv"><span class="k" style="font-size:10px">${regime}</span><span class="v ${c}" style="font-size:10px">${(prob * 100).toFixed(1)}%</span></div>`;
    }
  }

  el.innerHTML = html;
}

function renderFactors(data) {
  const el = $("factorBlock");
  if (!el) return;
  if (!data || data.insufficient) {
    el.innerHTML = `<div style="color:#4b5563;font-size:12px">Insufficient data (${data?.sampleSize || 0} trades, need 20+)</div>`;
    return;
  }

  let html = `<div class="kv"><span class="k">Sample size</span><span class="v">${data.sampleSize} trades (${data.days}d)</span></div>`;
  html += `<div class="kv"><span class="k">Base win rate</span><span class="v">${((data.baseWinRate || 0) * 100).toFixed(1)}%</span></div>`;

  for (const f of (data.factors || []).slice(0, 6)) {
    if (f.type === "numeric") {
      const dirLabel = f.direction === "higher_is_better" ? "↑" : "↓";
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(f.factor)} ${dirLabel}</span><span class="v" style="font-size:10px">r=${f.correlation} | W:${f.avgWin} L:${f.avgLoss}</span></div>`;
    } else {
      const top = (f.breakdown || [])[0];
      const topStr = top ? ` (best: ${top.value} ${(top.winRate * 100).toFixed(0)}%)` : "";
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(f.factor)}</span><span class="v" style="font-size:10px">IG=${f.infoGain}${topStr}</span></div>`;
    }
  }

  el.innerHTML = html;
}

function renderSnapshots(data) {
  const el = $("snapshotBlock");
  if (!el) return;
  if (!data || !data.snapshots || data.snapshots.length === 0) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No snapshots yet</div>';
    return;
  }

  let html = `<div class="kv"><span class="k">Total</span><span class="v blue">${data.totalSnapshots || data.snapshots.length}</span></div>`;
  if (data.lastSnapshotAt) {
    html += `<div class="kv"><span class="k">Last</span><span class="v">${new Date(data.lastSnapshotAt).toLocaleTimeString()}</span></div>`;
  }

  for (const s of data.snapshots.slice(0, 5)) {
    const typeColor = s.type === "startup" ? "blue" : s.type === "shutdown" ? "amber" : "";
    html += `<div class="kv"><span class="k" style="font-size:10px">${new Date(s.timestamp).toLocaleTimeString()}</span><span class="v ${typeColor}" style="font-size:10px">${s.type} | ${s.botState} | ${s.openPositions}pos</span></div>`;
  }

  el.innerHTML = html;
}

function renderMicrostructure(data) {
  const el = $("microstructureBlock");
  if (!el) return;
  if (!data || !data.summary) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No microstructure data</div>';
    return;
  }

  const s = data.summary;
  const qColor = s.overallQuality === "healthy" ? "green" : s.overallQuality === "fair" ? "amber" : "red";
  let html = `<div class="kv"><span class="k">Markets tracked</span><span class="v">${s.totalTracked}</span></div>`;
  html += `<div class="kv"><span class="k">Avg liquidity</span><span class="v ${qColor}">${s.avgLiquidityScore}/100</span></div>`;
  html += `<div class="kv"><span class="k">Low liquidity</span><span class="v ${s.lowLiquidityMarkets > 0 ? "red" : ""}">${s.lowLiquidityMarkets}</span></div>`;
  html += `<div class="kv"><span class="k">Toxic flow</span><span class="v ${s.toxicFlowMarkets > 0 ? "amber" : ""}">${s.toxicFlowMarkets}</span></div>`;

  for (const m of (data.markets || []).slice(0, 4)) {
    const lqColor = m.liquidityScore >= 70 ? "green" : m.liquidityScore >= 40 ? "amber" : "red";
    html += `<div class="kv"><span class="k" style="font-size:10px">${esc(m.marketId?.slice(0, 16))}</span><span class="v ${lqColor}" style="font-size:10px">${m.liquidityScore} | spr:${m.spread?.stability}</span></div>`;
  }

  el.innerHTML = html;
}

function renderRegimeSizing(data) {
  const el = $("regimeSizingBlock");
  if (!el) return;
  if (!data || !data.regimeMultipliers) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No sizing data</div>';
    return;
  }

  let html = '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-bottom:4px">REGIME MULTIPLIERS</div>';
  for (const [regime, mult] of Object.entries(data.regimeMultipliers)) {
    const color = mult > 1.0 ? "green" : mult < 1.0 ? "red" : "";
    html += `<div class="kv"><span class="k" style="font-size:10px">${regime}</span><span class="v ${color}" style="font-size:10px">${mult}x</span></div>`;
  }

  const hourMults = data.hourMultipliers || {};
  const hourKeys = Object.keys(hourMults);
  if (hourKeys.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:4px">HOUR ADJUSTMENTS</div>';
    for (const h of hourKeys.sort((a, b) => a - b).slice(0, 6)) {
      const m = hourMults[h];
      const color = m > 1.0 ? "green" : m < 1.0 ? "red" : "";
      html += `<div class="kv"><span class="k" style="font-size:10px">${h}:00</span><span class="v ${color}" style="font-size:10px">${m}x</span></div>`;
    }
  }

  el.innerHTML = html;
}

function renderReplay(data) {
  const el = $("replayBlock");
  if (!el) return;
  if (!data || !data.strategies) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No replay data</div>';
    return;
  }

  let html = '';
  if (data.winner) {
    html += `<div class="kv"><span class="k">Winner</span><span class="v green">${esc(data.winner)}</span></div>`;
  }

  for (const s of data.strategies) {
    const isWinner = s.name === data.winner;
    const pnlColor = s.totalPnl >= 0 ? "green" : "red";
    html += `<div class="kv"><span class="k" style="font-size:10px;${isWinner ? "color:#34d399;font-weight:700" : ""}">${esc(s.name)}</span><span class="v" style="font-size:10px">${s.winRate ?? "-"}% | <span class="${pnlColor}">$${s.totalPnl}</span> (${s.settled}t)</span></div>`;
  }

  html += `<div style="font-size:9px;color:#4b5563;margin-top:6px">${data.days}d lookback</div>`;
  el.innerHTML = html;
}

function renderTiming(data) {
  const el = $("timingBlock");
  if (!el) return;
  if (!data || data.insufficient) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">Insufficient data</div>';
    return;
  }

  let html = `<div class="kv"><span class="k">Base win rate</span><span class="v">${data.baseWinRate}%</span></div>`;

  if (data.hot?.length > 0) {
    html += '<div style="font-size:9px;color:#34d399;font-weight:700;margin-top:6px;margin-bottom:2px">HOT WINDOWS</div>';
    for (const w of data.hot.slice(0, 3)) {
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(w.label)}</span><span class="v green" style="font-size:10px">${w.winRate}% (+${w.lift})</span></div>`;
    }
  }

  if (data.cold?.length > 0) {
    html += '<div style="font-size:9px;color:#f87171;font-weight:700;margin-top:6px;margin-bottom:2px">COLD WINDOWS</div>';
    for (const w of data.cold.slice(0, 3)) {
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(w.label)}</span><span class="v red" style="font-size:10px">${w.winRate}% (-${w.deficit})</span></div>`;
    }
  }

  if ((data.hot || []).length === 0 && (data.cold || []).length === 0) {
    html += '<div style="color:#4b5563;font-size:11px;margin-top:6px">No significant timing patterns detected</div>';
  }

  el.innerHTML = html;
}

function renderLiquidation(data) {
  const el = $("liquidationBlock");
  if (!el) return;
  if (!data || !data.currentRisk) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No risk data</div>';
    return;
  }

  const r = data.currentRisk;
  const usedColor = r.pctUsed > 75 ? "red" : r.pctUsed > 50 ? "amber" : "green";
  let html = `<div class="kv"><span class="k">Daily P&L</span><span class="v ${r.dailyPnl >= 0 ? "green" : "red"}">$${r.dailyPnl} / -$${r.dailyLimit}</span></div>`;
  html += `<div class="kv"><span class="k">Budget used</span><span class="v ${usedColor}">${r.pctUsed}%</span></div>`;

  for (const h of (data.horizons || [])) {
    if (h.insufficientData) continue;
    const pColor = h.breachProbability > 25 ? "red" : h.breachProbability > 10 ? "amber" : "green";
    html += `<div class="kv"><span class="k">${h.hours}h breach</span><span class="v ${pColor}">${h.breachProbability}%</span></div>`;
  }

  for (const rec of (data.recommendations || []).slice(0, 2)) {
    html += `<div style="font-size:10px;color:#fbbf24;margin-top:4px">${esc(rec)}</div>`;
  }

  el.innerHTML = html;
}

function renderDivergence(data) {
  const el = $("divergenceBlock");
  if (!el) return;
  if (!data || data.insufficient) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">Insufficient data</div>';
    return;
  }

  const alColor = data.overallAlignment >= 70 ? "green" : data.overallAlignment >= 40 ? "amber" : "red";
  let html = `<div class="kv"><span class="k">Current regime</span><span class="v blue">${data.currentRegime}</span></div>`;
  html += `<div class="kv"><span class="k">Alignment</span><span class="v ${alColor}">${data.overallAlignment}% (${data.alignedCategories}/${data.totalCategories})</span></div>`;

  for (const d of (data.divergences || []).slice(0, 4)) {
    const dColor = d.direction === "outperforming" ? "green" : "red";
    html += `<div class="kv"><span class="k" style="font-size:10px">${esc(d.category)}</span><span class="v ${dColor}" style="font-size:10px">${d.winRate}% (${d.deviation > 0 ? "+" : ""}${d.deviation})</span></div>`;
  }

  if ((data.divergences || []).length === 0) {
    html += '<div style="font-size:11px;color:#34d399;margin-top:4px">All categories aligned</div>';
  }

  el.innerHTML = html;
}

function renderLiquidity(data) {
  const el = $("liquidityBlock");
  if (!el) return;
  if (!data || !data.totalMarkets) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No liquidity data</div>';
    return;
  }

  const qColor = data.overallQuality === "healthy" ? "green" : data.overallQuality === "fair" ? "amber" : "red";
  let html = `<div class="kv"><span class="k">Markets</span><span class="v">${data.totalMarkets}</span></div>`;
  html += `<div class="kv"><span class="k">Avg score</span><span class="v ${qColor}">${data.avgLiquidityScore}/100</span></div>`;
  html += `<div class="kv"><span class="k">High / Med / Low</span><span class="v">${data.highLiquidity} / ${data.mediumLiquidity} / ${data.lowLiquidity}</span></div>`;

  if (data.atRisk?.length > 0) {
    html += `<div class="kv"><span class="k">At risk</span><span class="v red">${data.atRisk.length} markets</span></div>`;
  }

  if (data.recommendation) {
    html += `<div style="font-size:10px;color:#9ca3af;margin-top:4px">${esc(data.recommendation)}</div>`;
  }

  el.innerHTML = html;
}

function renderFreshness(data) {
  const el = $("freshnessBlock");
  if (!el) return;
  if (!data || !data.categories) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No freshness data</div>';
    return;
  }

  let html = `<div class="kv"><span class="k">Cutoff</span><span class="v">${data.freshnessCutoff} (${data.freshnessCutoff * 100}%)</span></div>`;
  html += `<div class="kv"><span class="k">Regime penalty</span><span class="v amber">${data.regimeChangePenalty}</span></div>`;

  html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">HALF-LIVES</div>';
  for (const c of data.categories.slice(0, 8)) {
    html += `<div class="kv"><span class="k" style="font-size:10px">${esc(c.category)}</span><span class="v" style="font-size:10px">${c.halfLife}min (stale@${c.staleAt}min)</span></div>`;
  }

  el.innerHTML = html;
}

function renderShortfall(data) {
  const el = $("execQualityBlock");
  if (!el) return;
  if (!data || !data.summary) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No execution quality data</div>';
    return;
  }
  const s = data.summary;
  const cb = s.costBreakdown || {};
  let html = `<div class="kv"><span class="k">Trades analyzed</span><span class="v">${s.count}</span></div>`;
  html += `<div class="kv"><span class="k">Avg delay</span><span class="v ${s.avgDelayMinutes > 2 ? 'red' : 'green'}">${s.avgDelayMinutes} min</span></div>`;
  html += `<div class="kv"><span class="k">Avg slippage</span><span class="v ${s.avgSlippageBps > 10 ? 'red' : 'amber'}">${s.avgSlippageBps} bps</span></div>`;
  html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">COST DECOMPOSITION</div>';
  html += `<div class="kv"><span class="k" style="font-size:10px">Spread</span><span class="v" style="font-size:10px">${cb.spreadBps || 0} bps</span></div>`;
  html += `<div class="kv"><span class="k" style="font-size:10px">Impact</span><span class="v" style="font-size:10px">${cb.impactBps || 0} bps</span></div>`;
  html += `<div class="kv"><span class="k" style="font-size:10px">Timing</span><span class="v" style="font-size:10px">${cb.timingBps || 0} bps</span></div>`;
  if (s.byRegime) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">BY REGIME</div>';
    for (const [r, d] of Object.entries(s.byRegime).slice(0, 4)) {
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(r)}</span><span class="v" style="font-size:10px">${d.avgDelay}m / ${d.avgSlipBps}bps (${d.count})</span></div>`;
    }
  }
  el.innerHTML = html;
}

function renderPortfolioOpt(data) {
  const el = $("portfolioOptBlock");
  if (!el) return;
  if (!data || !data.current) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No portfolio data</div>';
    return;
  }
  const scoreColor = data.score >= 80 ? 'green' : data.score >= 50 ? 'amber' : 'red';
  let html = `<div class="kv"><span class="k">Score</span><span class="v ${scoreColor}">${data.score}/100</span></div>`;
  html += `<div class="kv"><span class="k">Positions</span><span class="v">${data.current.positions}</span></div>`;
  html += `<div class="kv"><span class="k">Dir. bias</span><span class="v ${data.current.directionalBias > 0.5 ? 'red' : 'green'}">${(data.current.directionalBias * 100).toFixed(1)}%</span></div>`;
  html += `<div class="kv"><span class="k">Violations</span><span class="v ${data.violations.length > 0 ? 'red' : 'green'}">${data.violations.length}</span></div>`;
  if (data.rebalanceActions && data.rebalanceActions.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">REBALANCE ACTIONS</div>';
    for (const a of data.rebalanceActions.slice(0, 4)) {
      const icon = a.action === 'reduce' ? '↓' : '↑';
      html += `<div class="kv"><span class="k" style="font-size:10px">${icon} ${esc(a.category)}</span><span class="v" style="font-size:10px">${(a.driftPct * 100).toFixed(1)}% drift</span></div>`;
    }
  }
  html += `<div style="font-size:10px;color:#6b7280;margin-top:6px">${esc(data.recommendation || '')}</div>`;
  el.innerHTML = html;
}

function renderArbitrage(data) {
  const el = $("arbitrageBlock");
  if (!el) return;
  if (!data || !data.summary) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No arbitrage data</div>';
    return;
  }
  const s = data.summary;
  let html = `<div class="kv"><span class="k">Markets scanned</span><span class="v">${s.marketsScanned}</span></div>`;
  html += `<div class="kv"><span class="k">Opportunities</span><span class="v ${s.opportunitiesFound > 0 ? 'amber' : 'green'}">${s.opportunitiesFound}</span></div>`;
  html += `<div class="kv"><span class="k">High confidence</span><span class="v ${s.highConfidence > 0 ? 'red' : 'green'}">${s.highConfidence}</span></div>`;
  if (s.byType) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">BY TYPE</div>';
    html += `<div class="kv"><span class="k" style="font-size:10px">Complementary</span><span class="v" style="font-size:10px">${s.byType.complementary || 0}</span></div>`;
    html += `<div class="kv"><span class="k" style="font-size:10px">Category outlier</span><span class="v" style="font-size:10px">${s.byType.categoryOutlier || 0}</span></div>`;
    html += `<div class="kv"><span class="k" style="font-size:10px">Cross-market</span><span class="v" style="font-size:10px">${s.byType.crossMarket || 0}</span></div>`;
  }
  if (data.opportunities && data.opportunities.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">TOP OPPORTUNITIES</div>';
    for (const o of data.opportunities.slice(0, 3)) {
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(o.type)}</span><span class="v" style="font-size:10px">${o.edgeBps || 0}bps (${o.confidence})</span></div>`;
    }
  }
  el.innerHTML = html;
}

function renderSentiment(data) {
  const el = $("sentimentBlock");
  if (!el) return;
  if (!data || !data.overall) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No sentiment data</div>';
    return;
  }
  const o = data.overall;
  const sentColor = o.score > 15 ? 'green' : o.score < -15 ? 'red' : 'amber';
  let html = `<div class="kv"><span class="k">Overall</span><span class="v ${sentColor}">${o.score > 0 ? '+' : ''}${o.score} (${esc(o.label)})</span></div>`;
  html += `<div class="kv"><span class="k">Markets</span><span class="v">${o.marketCount}</span></div>`;
  html += `<div class="kv"><span class="k">Bullish</span><span class="v green">${(o.bullishPct * 100).toFixed(0)}%</span></div>`;
  html += `<div class="kv"><span class="k">Bearish</span><span class="v red">${(o.bearishPct * 100).toFixed(0)}%</span></div>`;
  if (data.byCategory && data.byCategory.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">BY CATEGORY</div>';
    for (const c of data.byCategory.slice(0, 5)) {
      const catColor = c.avgScore > 15 ? 'green' : c.avgScore < -15 ? 'red' : 'amber';
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(c.category)}</span><span class="v ${catColor}" style="font-size:10px">${c.avgScore > 0 ? '+' : ''}${c.avgScore} (${c.marketCount})</span></div>`;
    }
  }
  el.innerHTML = html;
}

function renderVolSurface(data) {
  const el = $("volSurfaceBlock");
  if (!el) return;
  if (!data || !data.summary) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No volatility data</div>';
    return;
  }
  const s = data.summary;
  let html = `<div class="kv"><span class="k">Markets</span><span class="v">${s.count}</span></div>`;
  html += `<div class="kv"><span class="k">Avg IV</span><span class="v ${s.avgImpliedVol > 1.0 ? 'red' : 'green'}">${(s.avgImpliedVol * 100).toFixed(1)}%</span></div>`;
  html += `<div class="kv"><span class="k">Avg HV</span><span class="v">${(s.avgHistoricalVol * 100).toFixed(1)}%</span></div>`;
  html += `<div class="kv"><span class="k">Vol premium</span><span class="v ${s.avgVolPremium > 0 ? 'amber' : 'green'}">${(s.avgVolPremium * 100).toFixed(1)}%</span></div>`;
  html += `<div class="kv"><span class="k">High vol</span><span class="v ${s.highVolMarkets > 0 ? 'red' : 'green'}">${s.highVolMarkets}</span></div>`;
  html += `<div class="kv"><span class="k">Skewed</span><span class="v">${s.skewedMarkets}</span></div>`;
  if (data.categoryBreakdown && data.categoryBreakdown.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">BY CATEGORY</div>';
    for (const c of data.categoryBreakdown.slice(0, 5)) {
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(c.category)}</span><span class="v" style="font-size:10px">IV ${(c.avgIV * 100).toFixed(0)}% / HV ${(c.avgHV * 100).toFixed(0)}% (${c.count})</span></div>`;
    }
  }
  el.innerHTML = html;
}

function renderRiskBudget(data) {
  const el = $("riskBudgetBlock");
  if (!el) return;
  if (!data || !data.summary) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No VaR data</div>';
    return;
  }
  const s = data.summary;
  let html = `<div class="kv"><span class="k">Historical VaR (95%)</span><span class="v red">$${data.historicalVaR}</span></div>`;
  html += `<div class="kv"><span class="k">Parametric VaR</span><span class="v amber">$${data.parametricVaR}</span></div>`;
  html += `<div class="kv"><span class="k">CVaR (Exp. Shortfall)</span><span class="v red">$${data.cvar}</span></div>`;
  html += `<div class="kv"><span class="k">Daily Sharpe</span><span class="v ${s.sharpeDaily > 0 ? 'green' : 'red'}">${s.sharpeDaily}</span></div>`;
  html += `<div class="kv"><span class="k">Sample days</span><span class="v">${s.days}</span></div>`;
  html += `<div class="kv"><span class="k">VaR breaches</span><span class="v ${s.breachDays > s.expectedBreaches ? 'red' : 'green'}">${s.breachDays} (expected ${s.expectedBreaches})</span></div>`;
  html += `<div class="kv"><span class="k">Worst day</span><span class="v red">$${s.worstDay}</span></div>`;
  html += `<div class="kv"><span class="k">Best day</span><span class="v green">$${s.bestDay}</span></div>`;
  el.innerHTML = html;
}

function renderOnlineLearner(data) {
  const el = $("onlineLearnerBlock");
  if (!el) return;
  if (!data) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No learner data</div>';
    return;
  }
  const accColor = data.recentAccuracy >= 0.6 ? 'green' : data.recentAccuracy >= 0.5 ? 'amber' : 'red';
  let html = `<div class="kv"><span class="k">Iterations</span><span class="v">${data.totalUpdates}</span></div>`;
  html += `<div class="kv"><span class="k">LR phase</span><span class="v">${data.lrPhase} (${data.learningRate})</span></div>`;
  html += `<div class="kv"><span class="k">Recent accuracy</span><span class="v ${accColor}">${(data.recentAccuracy * 100).toFixed(1)}% (n=${data.recentSampleSize})</span></div>`;
  html += `<div class="kv"><span class="k">Overall accuracy</span><span class="v">${(data.overallAccuracy * 100).toFixed(1)}%</span></div>`;
  if (data.featureRanking && data.featureRanking.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">TOP FEATURES</div>';
    for (const f of data.featureRanking.slice(0, 5)) {
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(f.feature)}</span><span class="v" style="font-size:10px">${(f.share * 100).toFixed(0)}%</span></div>`;
    }
  }
  el.innerHTML = html;
}

function renderTradeJournal(data) {
  const el = $("tradeJournalBlock");
  if (!el) return;
  if (!data || !data.winningPatterns) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No pattern data</div>';
    return;
  }
  let html = '';
  if (data.insights && data.insights.length > 0) {
    for (const ins of data.insights.slice(0, 3)) {
      html += `<div style="font-size:10px;color:#6b7280;margin-bottom:4px">${esc(ins)}</div>`;
    }
  }
  if (data.winningPatterns.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">WINNING PATTERNS</div>';
    for (const p of data.winningPatterns.slice(0, 4)) {
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(p.regime)} + ${esc(p.category)}</span><span class="v green" style="font-size:10px">${(p.winRate * 100).toFixed(0)}% WR (${p.count})</span></div>`;
    }
  }
  if (data.losingPatterns.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">LOSING PATTERNS</div>';
    for (const p of data.losingPatterns.slice(0, 3)) {
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(p.regime)} + ${esc(p.category)}</span><span class="v red" style="font-size:10px">${(p.winRate * 100).toFixed(0)}% WR (${p.count})</span></div>`;
    }
  }
  if (!html) html = '<div style="color:#4b5563;font-size:12px">Insufficient trade data for patterns</div>';
  el.innerHTML = html;
}

function renderOrderAlgo(data) {
  const el = $("orderAlgoBlock");
  if (!el) return;
  if (!data || !data.byAlgorithm) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No algorithm data</div>';
    return;
  }
  let html = `<div class="kv"><span class="k">Total trades</span><span class="v">${data.totalTrades}</span></div>`;
  if (data.recommendation) {
    html += `<div style="font-size:10px;color:#6b7280;margin-bottom:4px">${esc(data.recommendation)}</div>`;
  }
  if (data.byAlgorithm.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">BY METHOD</div>';
    for (const a of data.byAlgorithm.slice(0, 5)) {
      const slipColor = a.avgSlippageBps > 15 ? 'red' : a.avgSlippageBps > 5 ? 'amber' : 'green';
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(a.method)}</span><span class="v ${slipColor}" style="font-size:10px">${a.avgSlippageBps}bps / ${(a.winRate * 100).toFixed(0)}% WR (${a.trades})</span></div>`;
    }
  }
  el.innerHTML = html;
}

function renderBreaker(data) {
  const el = $("breakerBlock");
  if (!el) return;
  if (!data || !data.current) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No breaker data</div>';
    return;
  }
  const c = data.current;
  const statusColor = c.status === 'normal' ? 'green' : c.status === 'cautious' ? 'amber' : 'red';
  let html = `<div class="kv"><span class="k">Status</span><span class="v ${statusColor}">${esc(c.status).toUpperCase()}</span></div>`;
  if (c.reason) html += `<div class="kv"><span class="k">Reason</span><span class="v" style="font-size:10px">${esc(c.reason)}</span></div>`;
  if (data.stats) {
    html += `<div class="kv"><span class="k">Halts (7d)</span><span class="v">${data.stats.haltsLast7Days}</span></div>`;
    html += `<div class="kv"><span class="k">Loss days (7d)</span><span class="v ${data.stats.lossDaysLast7 > 3 ? 'red' : 'green'}">${data.stats.lossDaysLast7}/${data.stats.totalDays}</span></div>`;
    html += `<div class="kv"><span class="k">Avg daily P&L</span><span class="v ${data.stats.avgDailyPnl >= 0 ? 'green' : 'red'}">$${data.stats.avgDailyPnl}</span></div>`;
  }
  if (data.recentDays && data.recentDays.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">RECENT DAYS</div>';
    for (const d of data.recentDays.slice(0, 5)) {
      const dayColor = d.pnl >= 0 ? 'green' : d.wouldHalt ? 'red' : 'amber';
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(d.date)}</span><span class="v ${dayColor}" style="font-size:10px">$${d.pnl} (${d.trades}t)</span></div>`;
    }
  }
  el.innerHTML = html;
}

function renderKalman(data) {
  const el = $("kalmanBlock");
  if (!el) return;
  if (!data || !data.summary) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No fusion data</div>';
    return;
  }
  const s = data.summary;
  let html = `<div class="kv"><span class="k">Filters active</span><span class="v">${s.count}</span></div>`;
  html += `<div class="kv"><span class="k">Avg confidence</span><span class="v">${esc(String(s.avgConfidence))}</span></div>`;
  html += `<div class="kv"><span class="k">Net direction</span><span class="v ${s.netDirection === 'bullish' ? 'green' : s.netDirection === 'bearish' ? 'red' : 'amber'}">${esc(s.netDirection)}</span></div>`;
  html += `<div class="kv"><span class="k">Strong signals</span><span class="v">${s.strongSignals}</span></div>`;
  html += `<div class="kv"><span class="k">Bullish / Bearish</span><span class="v"><span class="green">${s.bullish}</span> / <span class="red">${s.bearish}</span></span></div>`;
  if (data.markets && data.markets.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">TOP SIGNALS</div>';
    for (const m of data.markets.slice(0, 4)) {
      const sigColor = m.direction === 'bullish' ? 'green' : m.direction === 'bearish' ? 'red' : 'amber';
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(m.marketId).slice(0,12)}</span><span class="v ${sigColor}" style="font-size:10px">${m.signal} (${esc(m.confidence)})</span></div>`;
    }
  }
  el.innerHTML = html;
}

function renderImpact(data) {
  const el = $("impactBlock");
  if (!el) return;
  if (!data || !data.modelFit) {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">No impact data</div>';
    return;
  }
  const f = data.modelFit;
  let html = `<div class="kv"><span class="k">Sample size</span><span class="v">${f.sampleSize}</span></div>`;
  html += `<div class="kv"><span class="k">Avg slippage</span><span class="v ${f.avgSlippageBps > 15 ? 'red' : 'amber'}">${f.avgSlippageBps} bps</span></div>`;
  html += `<div class="kv"><span class="k">P95 slippage</span><span class="v red">${f.p95SlippageBps} bps</span></div>`;
  html += `<div class="kv"><span class="k">Max slippage</span><span class="v red">${f.maxSlippageBps} bps</span></div>`;
  if (data.calibration && data.calibration.byRegime) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">BY REGIME</div>';
    for (const [r, d] of Object.entries(data.calibration.byRegime).slice(0, 4)) {
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(r)}</span><span class="v" style="font-size:10px">${d.avgSlippageBps}±${d.stdSlippageBps} bps (${d.sampleSize})</span></div>`;
    }
  }
  el.innerHTML = html;
}

function renderLifecycle(data) {
  const el = $("lifecycleBlock");
  if (!el || !data) return;
  const s = data.summary || {};
  let html = `<div class="kv"><span class="k">Total Tracked</span><span class="v">${s.totalTracked || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Active</span><span class="v">${s.activeCount || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Timed Out</span><span class="v">${s.timedOutCancelled || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Realized P&L</span><span class="v">${s.totalRealizedPnl || 0}</span></div>`;
  if (s.byState) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">BY STATE</div>';
    for (const [st, ct] of Object.entries(s.byState)) {
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(st)}</span><span class="v" style="font-size:10px">${ct}</span></div>`;
    }
  }
  const active = (data.active || []).slice(0, 5);
  if (active.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">ACTIVE POSITIONS</div>';
    for (const p of active) {
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(p.id?.slice(0,12))}</span><span class="v" style="font-size:10px">${p.state} ${p.side} ${p.currentShares}sh ${p.ageMinutes}m</span></div>`;
    }
  }
  el.innerHTML = html;
}

function renderMonteCarlo(data) {
  const el = $("monteCarloBlock");
  if (!el || !data) return;
  if (data.message === "insufficient_data") { el.innerHTML = '<div style="color:#9ca3af;font-size:11px">Insufficient data</div>'; return; }
  const sim = data.simulation || {};
  const pct = data.percentiles || {};
  const risk = data.riskMetrics || {};
  let html = `<div class="kv"><span class="k">Paths</span><span class="v">${sim.paths || 0} × ${sim.tradesPerPath || 0} trades</span></div>`;
  if (pct.totalPnl) {
    html += `<div class="kv"><span class="k">P&L p5/p50/p95</span><span class="v">${pct.totalPnl.p5} / ${pct.totalPnl.p50} / ${pct.totalPnl.p95}</span></div>`;
  }
  if (pct.sharpe) {
    html += `<div class="kv"><span class="k">Sharpe p5/p50/p95</span><span class="v">${pct.sharpe.p5} / ${pct.sharpe.p50} / ${pct.sharpe.p95}</span></div>`;
  }
  if (pct.maxDrawdown) {
    html += `<div class="kv"><span class="k">MaxDD p50/p95</span><span class="v">${pct.maxDrawdown.p50} / ${pct.maxDrawdown.p95}</span></div>`;
  }
  html += `<div class="kv"><span class="k">Prob of Loss</span><span class="v">${((risk.probOfLoss || 0) * 100).toFixed(1)}%</span></div>`;
  html += `<div class="kv"><span class="k">Worst/Best Case</span><span class="v">${risk.expectedWorstCase || 0} / ${risk.expectedBestCase || 0}</span></div>`;
  el.innerHTML = html;
}

function renderFatigue(data) {
  const el = $("fatigueBlock");
  if (!el || !data) return;
  const stats = data.stats || {};
  let html = `<div class="kv"><span class="k">Health</span><span class="v" style="color:${stats.overallHealth === 'healthy' ? '#22c55e' : stats.overallHealth === 'busy' ? '#f59e0b' : '#ef4444'}">${stats.overallHealth || 'unknown'}</span></div>`;
  html += `<div class="kv"><span class="k">Sent / Suppressed</span><span class="v">${stats.totalSentThisHour || 0} / ${stats.totalSuppressed || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Suppression Rate</span><span class="v">${((stats.suppressionRate || 0) * 100).toFixed(1)}%</span></div>`;
  html += `<div class="kv"><span class="k">Coalesced</span><span class="v">${stats.totalCoalesced || 0}</span></div>`;
  if (data.channels) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">CHANNELS</div>';
    for (const [ch, info] of Object.entries(data.channels)) {
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(ch)}</span><span class="v" style="font-size:10px">${info.sentThisHour}/${info.limit} (${(info.utilization * 100).toFixed(0)}%)</span></div>`;
    }
  }
  el.innerHTML = html;
}

function renderStrategySelector(data) {
  const el = $("strategySelectorBlock");
  if (!el || !data) return;
  if (data.message === "insufficient_data") { el.innerHTML = '<div style="color:#9ca3af;font-size:11px">Insufficient data</div>'; return; }
  let html = `<div class="kv"><span class="k">Regime</span><span class="v">${esc(data.currentRegime || 'RANGE')}</span></div>`;
  html += `<div class="kv"><span class="k">Total Trades</span><span class="v">${data.totalTrades || 0}</span></div>`;
  const rec = data.recommended || [];
  if (rec.length > 0) {
    html += `<div class="kv"><span class="k">Recommended</span><span class="v" style="color:#22c55e">${rec.map(esc).join(', ')}</span></div>`;
  }
  const benched = data.benched || [];
  if (benched.length > 0) {
    html += `<div class="kv"><span class="k">Benched</span><span class="v" style="color:#ef4444">${benched.map(esc).join(', ')}</span></div>`;
  }
  if (data.allocation) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">ALLOCATION</div>';
    for (const [strat, pct] of Object.entries(data.allocation).slice(0, 5)) {
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(strat)}</span><span class="v" style="font-size:10px">${(pct * 100).toFixed(1)}%</span></div>`;
    }
  }
  el.innerHTML = html;
}

function renderContagion(data) {
  const el = $("contagionBlock");
  if (!el || !data) return;
  let html = `<div class="kv"><span class="k">Risk Score</span><span class="v" style="color:${data.riskLevel === 'high' ? '#ef4444' : data.riskLevel === 'moderate' ? '#f59e0b' : '#22c55e'}">${data.riskScore}/100 (${data.riskLevel})</span></div>`;
  const cr = data.correlationRegime || {};
  html += `<div class="kv"><span class="k">Corr Regime</span><span class="v">${esc(cr.regime || 'unknown')} (${cr.trend || 'stable'})</span></div>`;
  html += `<div class="kv"><span class="k">Avg Correlation</span><span class="v">${cr.recentAvgCorrelation || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Systemic Risk</span><span class="v">${data.systemicRisk || 0}</span></div>`;
  const clusters = data.clusters || [];
  if (clusters.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">CLUSTERS</div>';
    for (const c of clusters.slice(0, 3)) {
      html += `<div class="kv"><span class="k" style="font-size:10px">${c.size} mkts</span><span class="v" style="font-size:10px">corr ${c.avgIntraCorrelation}</span></div>`;
    }
  }
  if (data.recommendations?.length > 0) {
    html += `<div style="font-size:9px;color:#f59e0b;margin-top:4px">${esc(data.recommendations[0])}</div>`;
  }
  el.innerHTML = html;
}

function renderAdaptiveRisk(data) {
  const el = $("adaptiveRiskBlock");
  if (!el || !data) return;
  const k = data.kelly || {};
  const s = data.stress || {};
  let html = `<div class="kv"><span class="k">Kelly Fraction</span><span class="v">${k.recommendedFraction || 0} (${k.adaptiveMultiplier || 1}x)</span></div>`;
  html += `<div class="kv"><span class="k">Portfolio Risk</span><span class="v" style="color:${s.riskLevel === 'critical' ? '#ef4444' : s.riskLevel === 'elevated' ? '#f59e0b' : '#22c55e'}">${s.portfolioRisk || 0}/100 (${s.riskLevel || 'unknown'})</span></div>`;
  html += `<div class="kv"><span class="k">Alerts</span><span class="v">${s.alertCount || 0}</span></div>`;
  const lim = data.limits || {};
  html += `<div class="kv"><span class="k">Regime</span><span class="v">${esc(lim.regime || 'RANGE')}</span></div>`;
  if (lim.global) {
    html += `<div class="kv"><span class="k">Daily Loss Limit</span><span class="v">$${lim.global.maxDailyLoss || 0}</span></div>`;
    html += `<div class="kv"><span class="k">Max Positions</span><span class="v">${lim.global.maxOpenPositions || 0}</span></div>`;
  }
  if (k.rationale?.length > 0) {
    html += `<div style="font-size:9px;color:#4b5563;margin-top:4px">${esc(k.rationale[0])}</div>`;
  }
  el.innerHTML = html;
}

function renderWalkForward(data) {
  const el = $("walkForwardBlock");
  if (!el || !data) return;
  if (data.message) { el.innerHTML = `<div style="color:#9ca3af;font-size:11px">${esc(data.message)}</div>`; return; }
  let html = `<div class="kv"><span class="k">Stability Score</span><span class="v" style="color:${data.stabilityScore > 70 ? '#22c55e' : data.stabilityScore > 45 ? '#f59e0b' : '#ef4444'}">${data.stabilityScore}/100 (${data.verdict})</span></div>`;
  html += `<div class="kv"><span class="k">Windows</span><span class="v">${data.windowCount || 0} (${data.profitableWindows || 0} profitable)</span></div>`;
  html += `<div class="kv"><span class="k">Overfit Ratio</span><span class="v">${data.avgOverfitRatio || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Train Sharpe</span><span class="v">${data.avgTrainSharpe || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Test Sharpe</span><span class="v">${data.avgTestSharpe || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Params Stable</span><span class="v">${data.parameterStable === true ? 'Yes' : data.parameterStable === false ? 'Drifting' : 'N/A'}</span></div>`;
  if (data.recommendation) {
    html += `<div style="font-size:9px;color:#4b5563;margin-top:4px">${esc(data.recommendation)}</div>`;
  }
  el.innerHTML = html;
}

function renderEventImpact(data) {
  const el = $("eventImpactBlock");
  if (!el || !data) return;
  let html = '';
  const tod = data.timeOfDay || {};
  if (tod.bestHours?.length > 0) {
    html += `<div class="kv"><span class="k">Best Hours (UTC)</span><span class="v" style="color:#22c55e">${tod.bestHours.join(', ')}</span></div>`;
  }
  if (tod.worstHours?.length > 0) {
    html += `<div class="kv"><span class="k">Worst Hours</span><span class="v" style="color:#ef4444">${tod.worstHours.join(', ')}</span></div>`;
  }
  const dow = data.dayOfWeek || {};
  if (dow.bestDays?.length > 0) {
    html += `<div class="kv"><span class="k">Best Days</span><span class="v">${dow.bestDays.join(', ')}</span></div>`;
  }
  if (dow.worstDays?.length > 0) {
    html += `<div class="kv"><span class="k">Worst Days</span><span class="v">${dow.worstDays.join(', ')}</span></div>`;
  }
  html += `<div class="kv"><span class="k">Settlement</span><span class="v">${esc(data.settlementPattern || 'unknown')}</span></div>`;
  html += `<div class="kv"><span class="k">Top Category</span><span class="v">${esc(data.topCategory || 'unknown')}</span></div>`;
  const insights = data.insights || [];
  if (insights.length > 0) {
    html += `<div style="font-size:9px;color:#4b5563;margin-top:4px">${esc(insights[0])}</div>`;
  }
  el.innerHTML = html;
}

function renderDriftMonitor(data) {
  const el = $("driftBlock");
  if (!el || !data) return;
  let html = `<div class="kv"><span class="k">Drift Score</span><span class="v" style="color:${data.driftScore > 50 ? '#ef4444' : data.driftScore > 25 ? '#f59e0b' : '#22c55e'}">${data.driftScore}/100</span></div>`;
  html += `<div class="kv"><span class="k">Rebalance Needed</span><span class="v">${data.rebalanceNeeded ? 'YES' : 'No'}</span></div>`;
  const roi = data.roi || {};
  html += `<div class="kv"><span class="k">ROI</span><span class="v">${roi.netROI || 0}x (${roi.paybackDays || 0}d payback)</span></div>`;
  const top = data.topDrift || [];
  if (top.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">TOP DRIFT</div>';
    for (const d of top.slice(0, 4)) {
      const c = d.direction === 'overweight' ? '#f59e0b' : d.direction === 'underweight' ? '#3b82f6' : '#9ca3af';
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(d.category)}</span><span class="v" style="font-size:10px;color:${c}">${d.direction} ${(d.absDrift * 100).toFixed(1)}%</span></div>`;
    }
  }
  el.innerHTML = html;
}

function renderCostOpt(data) {
  const el = $("costOptBlock");
  if (!el || !data) return;
  let html = `<div class="kv"><span class="k">Avg Cost</span><span class="v">${data.avgCostBps || 0} bps</span></div>`;
  html += `<div class="kv"><span class="k">Best Method</span><span class="v" style="color:#22c55e">${esc(data.bestMethod || 'unknown')}</span></div>`;
  html += `<div class="kv"><span class="k">Worst Method</span><span class="v" style="color:#ef4444">${esc(data.worstMethod || 'unknown')}</span></div>`;
  html += `<div class="kv"><span class="k">Smart Route Savings</span><span class="v">${data.sampleSavingsBps || 0} bps</span></div>`;
  html += `<div class="kv"><span class="k">Methods Tracked</span><span class="v">${data.methodCount || 0}</span></div>`;
  const recs = data.recommendations || [];
  if (recs.length > 0) {
    html += `<div style="font-size:9px;color:#4b5563;margin-top:4px">${esc(recs[0])}</div>`;
  }
  el.innerHTML = html;
}

function renderArbiter(data) {
  const el = $("arbiterBlock");
  if (!el || !data) return;
  let html = `<div class="kv"><span class="k">Weight Confidence</span><span class="v">${data.weightConfidence || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Trades Analyzed</span><span class="v">${data.totalTradesAnalyzed || 0}</span></div>`;
  const top = data.topSources || [];
  if (top.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">TOP SOURCES</div>';
    for (const s of top.slice(0, 4)) {
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(s.source)}</span><span class="v" style="font-size:10px">WR ${(s.winRate * 100).toFixed(0)}% w:${s.weight}</span></div>`;
    }
  }
  const veto = data.vetoRules || [];
  if (veto.length > 0) {
    html += '<div style="font-size:9px;color:#4b5563;font-weight:700;margin-top:6px;margin-bottom:2px">VETO RULES</div>';
    for (const v of veto.slice(0, 3)) {
      html += `<div class="kv"><span class="k" style="font-size:10px">${esc(v.regime)}</span><span class="v" style="font-size:10px">≥${v.minConfidence} conf, max ${v.maxSignals}</span></div>`;
    }
  }
  el.innerHTML = html;
}

function renderRecoveryPred(data) {
  const el = $("recoveryPredBlock");
  if (!el || !data) return;
  const statusColor = data.status === 'recovering' ? '#22c55e' : data.status === 'deepening' ? '#ef4444' : '#9ca3af';
  let html = `<div class="kv"><span class="k">Status</span><span class="v" style="color:${statusColor}">${esc(data.status || 'unknown')}</span></div>`;
  html += `<div class="kv"><span class="k">Drawdown</span><span class="v">$${data.currentDrawdown || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Days to Breakeven</span><span class="v">${data.daysToBreakeven ?? 'N/A'}</span></div>`;
  html += `<div class="kv"><span class="k">Regime</span><span class="v">${esc(data.regime || 'unknown')} (${esc(data.regimeStability || '?')})</span></div>`;
  html += `<div class="kv"><span class="k">Resume Trading</span><span class="v" style="color:${data.resumeTrading ? '#22c55e' : '#ef4444'}">${data.resumeTrading ? 'YES' : 'No'} — ${esc(data.tradingSuggestion || '')}</span></div>`;
  html += `<div class="kv"><span class="k">Confidence</span><span class="v">${data.recoveryConfidence || 0}</span></div>`;
  if (data.recommendation) {
    html += `<div style="font-size:9px;color:#4b5563;margin-top:4px">${esc(data.recommendation)}</div>`;
  }
  el.innerHTML = html;
}

function renderLatency(data) {
  const el = $("latencyBlock");
  if (!el || !data) return;
  let html = `<div class="kv"><span class="k">P50</span><span class="v">${data.p50 || 0}ms</span></div>`;
  html += `<div class="kv"><span class="k">P95</span><span class="v">${data.p95 || 0}ms</span></div>`;
  html += `<div class="kv"><span class="k">P99</span><span class="v">${data.p99 || 0}ms</span></div>`;
  html += `<div class="kv"><span class="k">Bottlenecks</span><span class="v">${data.bottleneckCount || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Samples</span><span class="v">${data.totalSamples || 0}</span></div>`;
  if (data.recommendations?.length) {
    for (const r of data.recommendations.slice(0, 2)) {
      html += `<div style="font-size:9px;color:#4b5563;margin-top:2px">${esc(r)}</div>`;
    }
  }
  el.innerHTML = html;
}

function renderBayesian(data) {
  const el = $("bayesianBlock");
  if (!el || !data) return;
  let html = `<div class="kv"><span class="k">Posteriors</span><span class="v">${data.totalPosteriors || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Total Updates</span><span class="v">${data.totalUpdates || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Avg Mean</span><span class="v">${data.avgMean || 0}</span></div>`;
  if (data.mostConfident) {
    html += `<div class="kv"><span class="k">Best</span><span class="v" style="color:#22c55e">${esc(data.mostConfident.key)} (${data.mostConfident.mean})</span></div>`;
  }
  if (data.leastConfident) {
    html += `<div class="kv"><span class="k">Worst</span><span class="v" style="color:#ef4444">${esc(data.leastConfident.key)} (${data.leastConfident.mean})</span></div>`;
  }
  el.innerHTML = html;
}

function renderExitOpt(data) {
  const el = $("exitOptBlock");
  if (!el || !data) return;
  let html = `<div class="kv"><span class="k">Profit Factor</span><span class="v">${data.profitFactor || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Early Exit Rate</span><span class="v">${((data.earlyExitRate || 0) * 100).toFixed(1)}%</span></div>`;
  html += `<div class="kv"><span class="k">Late Exit Rate</span><span class="v">${((data.lateExitRate || 0) * 100).toFixed(1)}%</span></div>`;
  html += `<div class="kv"><span class="k">Optimal Stop</span><span class="v">${data.optimalStopBps || 0} bps</span></div>`;
  html += `<div class="kv"><span class="k">Optimal TP</span><span class="v">${data.optimalTpBps || 0} bps</span></div>`;
  html += `<div class="kv"><span class="k">R:R Ratio</span><span class="v">${data.riskRewardRatio || 0}</span></div>`;
  if (data.recommendations?.length) {
    for (const r of data.recommendations.slice(0, 2)) {
      html += `<div style="font-size:9px;color:#4b5563;margin-top:2px">${esc(r)}</div>`;
    }
  }
  el.innerHTML = html;
}

function renderBasis(data) {
  const el = $("basisBlock");
  if (!el || !data) return;
  let html = `<div class="kv"><span class="k">Avg Basis</span><span class="v">${data.avgBasis || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Basis Std</span><span class="v">${data.basisStd || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Divergences</span><span class="v">${data.divergenceCount || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Markets</span><span class="v">${data.marketsAnalyzed || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Calib Error</span><span class="v">${data.avgCalibrationError || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Revert Signals</span><span class="v">${data.strongRevertSignals || 0} strong</span></div>`;
  html += `<div class="kv"><span class="k">Best Category</span><span class="v" style="color:#22c55e">${esc(data.bestCategory || 'unknown')}</span></div>`;
  html += `<div class="kv"><span class="k">Worst Category</span><span class="v" style="color:#ef4444">${esc(data.worstCategory || 'unknown')}</span></div>`;
  el.innerHTML = html;
}

function renderRegimeMemory(data) {
  const el = $("regimeMemBlock");
  if (!el || !data) return;
  let html = `<div class="kv"><span class="k">Best Regime</span><span class="v" style="color:#22c55e">${esc(data.bestRegime || 'unknown')} ($${data.bestRegimePnl || 0})</span></div>`;
  html += `<div class="kv"><span class="k">Worst Regime</span><span class="v" style="color:#ef4444">${esc(data.worstRegime || 'unknown')} ($${data.worstRegimePnl || 0})</span></div>`;
  html += `<div class="kv"><span class="k">Regimes Tracked</span><span class="v">${data.regimeCount || 0}</span></div>`;
  html += `<div class="kv"><span class="k">In-Memory</span><span class="v">${data.inMemorySize || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Total Trades</span><span class="v">${data.totalTrades || 0}</span></div>`;
  if (data.crossRegimeInsights?.length) {
    for (const i of data.crossRegimeInsights.slice(0, 2)) {
      html += `<div style="font-size:9px;color:#4b5563;margin-top:2px">${esc(i.message)}</div>`;
    }
  }
  el.innerHTML = html;
}

function renderOrderRouter(data) {
  const el = $("orderRouterBlock");
  if (!el || !data) return;
  let html = `<div class="kv"><span class="k">Recommended</span><span class="v">${esc(data.recommendedName || 'unknown')}</span></div>`;
  html += `<div class="kv"><span class="k">Expected Cost</span><span class="v">${data.expectedCostBps || 0} bps</span></div>`;
  html += `<div class="kv"><span class="k">Venues</span><span class="v">${data.venueCount || 0} known, ${data.trackedVenues || 0} tracked</span></div>`;
  html += `<div class="kv"><span class="k">Top Method</span><span class="v">${esc(data.topMethod || 'unknown')} ($${data.topMethodPnl || 0})</span></div>`;
  html += `<div class="kv"><span class="k">Total Trades</span><span class="v">${data.totalTrades || 0}</span></div>`;
  el.innerHTML = html;
}

function renderMMDetector(data) {
  const el = $("mmDetectorBlock");
  if (!el || !data) return;
  const riskColor = data.toxicFlowRisk === 'high' ? '#ef4444' : data.toxicFlowRisk === 'moderate' ? '#f59e0b' : '#22c55e';
  let html = `<div class="kv"><span class="k">MM Presence</span><span class="v">${data.avgMMPresenceScore || 0}/100</span></div>`;
  html += `<div class="kv"><span class="k">Toxic Flow</span><span class="v" style="color:${riskColor}">${esc(data.toxicFlowRisk || 'unknown')} (${data.toxicFlowCount || 0})</span></div>`;
  html += `<div class="kv"><span class="k">Markets Analyzed</span><span class="v">${data.marketsAnalyzed || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Spread Markets</span><span class="v">${data.spreadMarkets || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Avg Spread</span><span class="v">${data.avgSpread || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Tightest</span><span class="v">${esc(data.tightestMarket || 'unknown')}</span></div>`;
  el.innerHTML = html;
}

function renderConfCalib(data) {
  const el = $("confCalibBlock");
  if (!el || !data) return;
  const calColor = data.overallCalibration === 'overconfident' ? '#ef4444' : data.overallCalibration === 'underconfident' ? '#f59e0b' : '#22c55e';
  let html = `<div class="kv"><span class="k">Brier Score</span><span class="v">${data.brierScore || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Calibration</span><span class="v" style="color:${calColor}">${esc(data.overallCalibration || 'unknown')}</span></div>`;
  html += `<div class="kv"><span class="k">Overconfident</span><span class="v">${data.overconfidentBuckets || 0} buckets</span></div>`;
  html += `<div class="kv"><span class="k">Underconfident</span><span class="v">${data.underconfidentBuckets || 0} buckets</span></div>`;
  html += `<div class="kv"><span class="k">Avg Gap</span><span class="v">${data.avgCalibrationGap || 0}</span></div>`;
  html += `<div class="kv"><span class="k">Sample</span><span class="v">${esc(data.sampleAdjustment || 'N/A')}</span></div>`;
  html += `<div class="kv"><span class="k">Best Regime</span><span class="v" style="color:#22c55e">${esc(data.bestRegime || 'unknown')}</span></div>`;
  html += `<div class="kv"><span class="k">Worst Regime</span><span class="v" style="color:#ef4444">${esc(data.worstRegime || 'unknown')}</span></div>`;
  el.innerHTML = html;
}

connectWs();
loadAdmin();
setInterval(loadAdmin, 30_000);
</script>
</body>
</html>
