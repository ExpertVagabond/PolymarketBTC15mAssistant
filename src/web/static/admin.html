<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PolySignal Admin</title>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: #0b0b11; color: #c8c8d0; min-height: 100vh; line-height: 1.5; }

    .header { padding: 14px 28px; background: #101018; border-bottom: 1px solid #1e1e2a; display: flex; align-items: center; justify-content: space-between; }
    .header-left { display: flex; align-items: center; gap: 14px; }
    .header-left h1 { font-size: 17px; color: #fff; font-weight: 700; }
    .header-left .badge { font-size: 10px; font-weight: 700; padding: 2px 10px; border-radius: 20px; background: #f8717120; color: #f87171; }
    .header-right { display: flex; align-items: center; gap: 14px; }
    .header-link { color: #6b7280; text-decoration: none; font-size: 12px; font-weight: 500; }
    .header-link:hover { color: #a5b4fc; }
    .refresh-badge { font-size: 10px; color: #4b5563; }

    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; padding: 20px 28px; }
    .card { background: #12121a; border: 1px solid #1e1e2a; border-radius: 10px; padding: 16px 18px; }
    .card.wide { grid-column: 1 / -1; }
    .card.half { grid-column: span 2; }
    .card-title { font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 12px; }
    .kv { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #141420; font-size: 12px; }
    .kv:last-child { border-bottom: none; }
    .kv .k { color: #6b7280; }
    .kv .v { color: #e5e7eb; font-weight: 600; font-variant-numeric: tabular-nums; }
    .kv .v.green { color: #34d399; }
    .kv .v.red { color: #f87171; }
    .kv .v.amber { color: #fbbf24; }
    .kv .v.blue { color: #60a5fa; }

    .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
    .status-dot.ok { background: #34d399; }
    .status-dot.warn { background: #fbbf24; }
    .status-dot.err { background: #f87171; }

    .source-row { display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid #141420; font-size: 12px; }
    .source-row:last-child { border-bottom: none; }
    .source-name { color: #e5e7eb; font-weight: 500; width: 120px; }
    .source-stats { color: #6b7280; flex: 1; font-variant-numeric: tabular-nums; }

    .auth-wall { text-align: center; padding: 80px 28px; }
    .auth-wall h2 { color: #fff; margin-bottom: 8px; }
    .auth-wall p { color: #6b7280; font-size: 13px; }

    .try-btn { background: #1a1a24; border: 1px solid #2a2a36; border-radius: 6px; padding: 3px 10px; font-size: 10px; color: #93c5fd; cursor: pointer; font-family: inherit; font-weight: 600; transition: all 0.15s; }
    .try-btn:hover { border-color: #3b82f6; background: #3b82f618; }

    .footer { text-align: center; padding: 28px; color: #27272f; font-size: 11px; }
    .footer a { color: #4b5563; }

    @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } .card.wide, .card.half { grid-column: 1; } }
  </style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <h1>PolySignal</h1>
    <span class="badge">ADMIN</span>
  </div>
  <div class="header-right">
    <span class="refresh-badge" id="lastRefresh">Loading...</span>
    <a href="/" class="header-link">Dashboard</a>
    <a href="/stats.html" class="header-link">Performance</a>
  </div>
</div>

<div id="authWall" class="auth-wall" style="display:none">
  <h2>Admin Access Required</h2>
  <p>Login via the main dashboard Settings tab to access this page.</p>
</div>

<div id="adminContent">
  <div class="grid">
    <!-- System Health -->
    <div class="card">
      <div class="card-title">System Health</div>
      <div id="healthBlock">
        <div class="kv"><span class="k">Status</span><span class="v" id="sysStatus">-</span></div>
        <div class="kv"><span class="k">Uptime</span><span class="v" id="sysUptime">-</span></div>
        <div class="kv"><span class="k">Memory (Heap)</span><span class="v" id="sysMem">-</span></div>
        <div class="kv"><span class="k">WS Clients</span><span class="v blue" id="sysWs">-</span></div>
      </div>
    </div>

    <!-- Scanner Stats -->
    <div class="card">
      <div class="card-title">Scanner</div>
      <div id="scannerBlock">
        <div class="kv"><span class="k">Tracked Markets</span><span class="v" id="scTracked">-</span></div>
        <div class="kv"><span class="k">Active Signals</span><span class="v green" id="scSignals">-</span></div>
        <div class="kv"><span class="k">Categories</span><span class="v" id="scCats">-</span></div>
      </div>
    </div>

    <!-- Signal Stats -->
    <div class="card">
      <div class="card-title">Signal Performance</div>
      <div id="signalBlock">
        <div class="kv"><span class="k">Total Signals</span><span class="v" id="sigTotal">-</span></div>
        <div class="kv"><span class="k">Win Rate</span><span class="v green" id="sigWinRate">-</span></div>
        <div class="kv"><span class="k">Wins / Losses</span><span class="v" id="sigRecord">-</span></div>
        <div class="kv"><span class="k">Pending</span><span class="v amber" id="sigPending">-</span></div>
        <div class="kv"><span class="k">Avg Edge</span><span class="v" id="sigEdge">-</span></div>
      </div>
    </div>

    <!-- Data Sources -->
    <div class="card half">
      <div class="card-title">Data Source Health</div>
      <div id="sourcesBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Subscribers -->
    <div class="card">
      <div class="card-title">Subscribers</div>
      <div id="subBlock">
        <div class="kv"><span class="k">Total</span><span class="v" id="subTotal">-</span></div>
        <div class="kv"><span class="k">Active</span><span class="v green" id="subActive">-</span></div>
        <div class="kv"><span class="k">Pro</span><span class="v blue" id="subPro">-</span></div>
        <div class="kv"><span class="k">Basic</span><span class="v" id="subBasic">-</span></div>
        <div class="kv"><span class="k">Free</span><span class="v" id="subFree">-</span></div>
      </div>
    </div>

    <!-- Model Drift -->
    <div class="card half">
      <div class="card-title">Model Drift</div>
      <div id="driftBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
      <div style="margin-top:10px"><button class="try-btn" onclick="resetDriftBaseline()">Reset Baseline</button></div>
    </div>

    <!-- Webhook Queue -->
    <div class="card">
      <div class="card-title">Webhook Queue</div>
      <div id="webhookQueueBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Delivery Health -->
    <div class="card">
      <div class="card-title">Delivery Health (7d)</div>
      <div id="deliveryBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Cache Stats -->
    <div class="card">
      <div class="card-title">Response Cache</div>
      <div id="cacheBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Endpoint Performance -->
    <div class="card">
      <div class="card-title">Endpoint Performance</div>
      <div id="perfBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Maintenance -->
    <div class="card">
      <div class="card-title">DB Maintenance</div>
      <div id="maintenanceBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
      <button style="margin-top:8px;padding:4px 12px;font-size:11px;background:#1e1e2a;border:1px solid #2d2d3a;color:#a5b4fc;border-radius:6px;cursor:pointer" onclick="runMaintenance()">Run Now</button>
    </div>

    <!-- Trading Config -->
    <div class="card">
      <div class="card-title">Trading Config</div>
      <div id="configBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Trading Status -->
    <div class="card half">
      <div class="card-title">Trading Bot</div>
      <div id="tradingBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Live Trade Feed -->
    <div class="card wide">
      <div class="card-title">Live Trade Feed <span id="wsBadge" style="font-size:9px;padding:1px 6px;border-radius:8px;background:#f8717120;color:#f87171;margin-left:6px">OFFLINE</span></div>
      <div id="tradeFeed" style="max-height:220px;overflow-y:auto;font-size:11px">
        <div data-placeholder style="color:#4b5563;font-size:12px">Waiting for trade events...</div>
      </div>
    </div>

    <!-- Trade Analytics -->
    <div class="card half">
      <div class="card-title">Trade Analytics</div>
      <div id="analyticsBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Signal Filters -->
    <div class="card">
      <div class="card-title">Signal Filters</div>
      <div id="filterStatsBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Close Reasons -->
    <div class="card">
      <div class="card-title">Close Reasons</div>
      <div id="closeReasonsBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Hourly Win Rates -->
    <div class="card wide">
      <div class="card-title">Hourly Win Rates (UTC)</div>
      <div id="hourlyBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Error Trends -->
    <div class="card wide">
      <div class="card-title">Error Trends (7d)</div>
      <div id="errorBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Subscriber List -->
    <div class="card wide">
      <div class="card-title">
        Subscribers
        <select id="subFilter" onchange="loadSubscribers()" style="margin-left:8px;background:#0e0e16;border:1px solid #1e1e2a;border-radius:4px;color:#9ca3af;font-size:10px;padding:2px 6px">
          <option value="">All Plans</option>
          <option value="free">Free</option>
          <option value="basic">Basic</option>
          <option value="pro">Pro</option>
        </select>
      </div>
      <div id="subscriberList"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
    </div>

    <!-- Grant Comp Access -->
    <div class="card">
      <div class="card-title">Grant Comp Access</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <input type="email" id="compEmail" placeholder="user@example.com" style="background:#0e0e16;border:1px solid #1e1e2a;border-radius:4px;padding:6px 10px;color:#e5e7eb;font-size:12px;font-family:inherit">
        <div style="display:flex;gap:6px">
          <select id="compPlan" style="background:#0e0e16;border:1px solid #1e1e2a;border-radius:4px;padding:4px 8px;color:#9ca3af;font-size:11px;font-family:inherit">
            <option value="pro">Pro</option>
            <option value="basic">Basic</option>
          </select>
          <input type="number" id="compDays" value="30" min="1" max="365" style="background:#0e0e16;border:1px solid #1e1e2a;border-radius:4px;padding:4px 8px;color:#e5e7eb;font-size:11px;width:60px;font-family:inherit"> days
          <button class="try-btn" onclick="grantComp()">Grant</button>
        </div>
        <div id="compResult" style="font-size:11px;color:#34d399;display:none"></div>
      </div>
    </div>
  </div>
</div>

<div class="footer">PolySignal Admin &mdash; <a href="/">Back to Dashboard</a></div>

<script>
const $ = (id) => document.getElementById(id);

async function loadAdmin() {
  try {
    // Check auth
    const me = await fetch("/api/auth/me").then(r => r.json());
    if (!me.email) { showAuthWall(); return; }

    // Load all data in parallel
    const [health, admin, trends, drift, whQueue, delivery, cacheStats, perf, maint, trading, openExecs, pnl, tradingConfig, analytics, hourlyStats, filterStatsData] = await Promise.all([
      fetch("/health/detailed").then(r => r.json()),
      fetch("/api/admin/stats").then(r => r.json()).catch(() => null),
      fetch("/api/logs/trends?days=7").then(r => r.json()).catch(() => null),
      fetch("/api/learning/drift-status").then(r => r.json()).catch(() => null),
      fetch("/api/admin/webhook-queue").then(r => r.json()).catch(() => null),
      fetch("/api/admin/delivery-stats").then(r => r.json()).catch(() => null),
      fetch("/api/admin/cache-stats").then(r => r.json()).catch(() => null),
      fetch("/api/admin/perf").then(r => r.json()).catch(() => null),
      fetch("/api/admin/maintenance").then(r => r.json()).catch(() => null),
      fetch("/api/trading/status").then(r => r.json()).catch(() => null),
      fetch("/api/trading/open").then(r => r.json()).catch(() => []),
      fetch("/api/trading/pnl").then(r => r.json()).catch(() => null),
      fetch("/api/trading/config").then(r => r.json()).catch(() => null),
      fetch("/api/trading/analytics").then(r => r.json()).catch(() => null),
      fetch("/api/trading/hourly-stats").then(r => r.json()).catch(() => []),
      fetch("/api/trading/filter-stats").then(r => r.json()).catch(() => null)
    ]);

    renderHealth(health);
    if (admin) renderAdmin(admin);
    if (trends) renderErrors(trends);
    if (drift) renderDrift(drift);
    if (whQueue) renderWebhookQueue(whQueue);
    if (delivery) renderDeliveryHealth(delivery);
    if (cacheStats) renderCacheStats(cacheStats);
    if (perf) renderPerfStats(perf);
    if (maint) renderMaintenance(maint);
    if (tradingConfig) renderTradingConfig(tradingConfig);
    if (trading) { trading._openExecutions = openExecs || []; trading._pnl = pnl; renderTrading(trading); }
    if (analytics) renderAnalytics(analytics);
    if (hourlyStats) renderHourly(hourlyStats);
    if (filterStatsData) renderFilterStats(filterStatsData);
    loadSubscribers();

    $("lastRefresh").textContent = "Updated " + new Date().toLocaleTimeString();
  } catch {
    showAuthWall();
  }
}

function showAuthWall() {
  $("authWall").style.display = "block";
  $("adminContent").style.display = "none";
}

function renderHealth(h) {
  const statusColor = h.status === "healthy" ? "green" : h.status === "degraded" ? "amber" : "red";
  $("sysStatus").innerHTML = `<span class="status-dot ${statusColor === "green" ? "ok" : statusColor === "amber" ? "warn" : "err"}"></span>${h.status || "unknown"}`;
  $("sysUptime").textContent = formatUptime(h.uptime);
  $("sysMem").textContent = h.memory?.heap || "-";
  $("sysWs").textContent = h.wsClients ?? 0;

  // Scanner
  if (h.scanner) {
    $("scTracked").textContent = h.scanner.tracked ?? 0;
    $("scSignals").textContent = h.scanner.withSignal ?? 0;
    $("scCats").textContent = h.scanner.categories ?? 0;
  }

  // Data sources
  const sources = h.sources;
  if (sources && typeof sources === "object") {
    const el = $("sourcesBlock");
    el.innerHTML = Object.entries(sources).map(([name, s]) => {
      const up = s.status === "healthy" || s.uptime > 0.9;
      const dotClass = up ? "ok" : s.status === "degraded" ? "warn" : "err";
      const latency = s.avgLatencyMs != null ? Math.round(s.avgLatencyMs) + "ms" : "-";
      const upPct = s.uptime != null ? (s.uptime * 100).toFixed(1) + "%" : "-";
      return `<div class="source-row">
        <span class="status-dot ${dotClass}"></span>
        <span class="source-name">${esc(name)}</span>
        <span class="source-stats">latency: ${latency} | uptime: ${upPct} | errors: ${s.errors ?? 0}</span>
      </div>`;
    }).join("");
  }
}

function renderAdmin(a) {
  // Signal stats
  const sig = a.signals || {};
  $("sigTotal").textContent = sig.total_signals ?? 0;
  $("sigWinRate").textContent = sig.winRate ? sig.winRate + "%" : "-";
  $("sigRecord").textContent = `${sig.wins ?? 0}W / ${sig.losses ?? 0}L`;
  $("sigPending").textContent = sig.pending ?? 0;
  $("sigEdge").textContent = sig.avg_edge != null ? "+" + (sig.avg_edge * 100).toFixed(1) + "%" : "-";

  // Subscribers
  const sub = a.subscribers || {};
  $("subTotal").textContent = sub.total ?? 0;
  $("subActive").textContent = sub.active ?? 0;
  $("subPro").textContent = sub.pro ?? 0;
  $("subBasic").textContent = sub.basic ?? 0;
  $("subFree").textContent = (sub.total ?? 0) - (sub.pro ?? 0) - (sub.basic ?? 0);
}

function formatUptime(secs) {
  if (!secs) return "-";
  const h = Math.floor(secs / 3600);
  const m = Math.floor((secs % 3600) / 60);
  return h > 0 ? `${h}h ${m}m` : `${m}m`;
}

function renderErrors(t) {
  const el = $("errorBlock");
  if (!t.bySource?.length && !t.daily?.length) {
    el.innerHTML = '<div style="color:#34d399;font-size:12px">No errors in the last 7 days</div>';
    return;
  }
  const sources = (t.bySource || []).map(s =>
    `<div class="kv"><span class="k">${esc(s.source)}</span><span class="v red">${s.count}</span></div>`
  ).join("");
  const levels = (t.byLevel || []).map(l =>
    `<div class="kv"><span class="k">${esc(l.level)}</span><span class="v ${l.level === "error" ? "red" : l.level === "warn" ? "amber" : ""}">${l.count}</span></div>`
  ).join("");
  el.innerHTML = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
    <div><div style="font-size:10px;color:#6b7280;margin-bottom:6px;font-weight:700">BY SOURCE</div>${sources || '<div style="color:#4b5563;font-size:11px">None</div>'}</div>
    <div><div style="font-size:10px;color:#6b7280;margin-bottom:6px;font-weight:700">BY LEVEL</div>${levels || '<div style="color:#4b5563;font-size:11px">None</div>'}</div>
  </div>`;
}

function renderDrift(d) {
  const el = $("driftBlock");
  if (!d.baselineSet) { el.innerHTML = '<div style="color:#4b5563;font-size:12px">No baseline set yet</div>'; return; }
  const sevColor = d.severity === "none" ? "#34d399" : d.severity === "low" ? "#60a5fa" : d.severity === "medium" ? "#fbbf24" : "#f87171";
  let html = `<div class="kv"><span class="k">Severity</span><span class="v" style="color:${sevColor}">${(d.severity || "none").toUpperCase()}</span></div>
    <div class="kv"><span class="k">Checked</span><span class="v">${d.totalChecked ?? 0}</span></div>
    <div class="kv"><span class="k">Drifted</span><span class="v ${d.totalDrifted > 0 ? "red" : ""}">${d.totalDrifted ?? 0}</span></div>
    <div class="kv"><span class="k">Threshold</span><span class="v">${d.driftThreshold ? (d.driftThreshold * 100) + "%" : "20%"}</span></div>`;
  if (d.topDrifts?.length > 0) {
    html += '<div style="font-size:10px;color:#6b7280;font-weight:700;margin-top:8px;margin-bottom:4px">TOP DRIFTS</div>';
    html += d.topDrifts.slice(0, 5).map(dr =>
      `<div class="kv"><span class="k" style="font-size:11px">${esc(dr.feature)}.${esc(dr.value)}</span><span class="v red">${dr.divergencePct}% ${dr.direction}</span></div>`
    ).join("");
  }
  if (d.recommendation) html += `<div style="font-size:11px;color:#9ca3af;margin-top:8px">${esc(d.recommendation)}</div>`;
  el.innerHTML = html;
}

function renderWebhookQueue(q) {
  const el = $("webhookQueueBlock");
  const s = q.status || {};
  let html = `<div class="kv"><span class="k">Pending</span><span class="v amber">${s.pending ?? 0}</span></div>
    <div class="kv"><span class="k">Retrying</span><span class="v amber">${s.retrying ?? 0}</span></div>
    <div class="kv"><span class="k">Delivered</span><span class="v green">${s.delivered ?? 0}</span></div>
    <div class="kv"><span class="k">Failed</span><span class="v red">${s.failed ?? 0}</span></div>
    <div class="kv"><span class="k">Total</span><span class="v">${s.total ?? 0}</span></div>`;
  el.innerHTML = html;
}

async function resetDriftBaseline() {
  try {
    const res = await fetch("/api/learning/drift-baseline", { method: "POST" });
    const data = await res.json();
    if (data.acknowledged) { loadAdmin(); }
  } catch {}
}

function renderDeliveryHealth(d) {
  const el = $("deliveryBlock");
  if (!el) return;
  const byStatus = d.byStatus || [];
  const byChannel = d.byChannel || [];
  let html = "";
  for (const s of byStatus) {
    const color = s.status === "delivered" ? "green" : s.status === "failed" ? "red" : s.status === "throttled" ? "amber" : "";
    html += `<div class="kv"><span class="k">${esc(s.status)}</span><span class="v ${color}">${s.count}</span></div>`;
  }
  if (d.avgLatencyMs != null) html += `<div class="kv"><span class="k">Avg Latency</span><span class="v">${Math.round(d.avgLatencyMs)}ms</span></div>`;
  el.innerHTML = html || '<div style="color:#4b5563;font-size:12px">No delivery data</div>';
}

function renderCacheStats(c) {
  const el = $("cacheBlock");
  if (!el) return;
  el.innerHTML = `
    <div class="kv"><span class="k">Entries</span><span class="v blue">${c.entries ?? 0}</span></div>
    <div class="kv"><span class="k">Hit Rate</span><span class="v green">${c.hitRate ?? 0}%</span></div>
    <div class="kv"><span class="k">Hits / Misses</span><span class="v">${c.hits ?? 0} / ${c.misses ?? 0}</span></div>
  `;
}

async function loadSubscribers() {
  const el = $("subscriberList");
  if (!el) return;
  const plan = $("subFilter")?.value || "";
  const url = "/api/admin/subscribers" + (plan ? "?plan=" + plan : "");
  try {
    const data = await fetch(url).then(r => r.json());
    // Handle both cursor { subscribers, nextCursor } and legacy array
    const subs = data.subscribers || (Array.isArray(data) ? data : []);
    if (subs.length === 0) { el.innerHTML = '<div style="color:#4b5563;font-size:12px">No subscribers found</div>'; return; }
    el.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:11px">
      <thead><tr>
        <th style="text-align:left;padding:6px 8px;color:#4b5563;font-size:9px;text-transform:uppercase;border-bottom:1px solid #1e1e2a">Email</th>
        <th style="text-align:left;padding:6px 8px;color:#4b5563;font-size:9px;text-transform:uppercase;border-bottom:1px solid #1e1e2a">Plan</th>
        <th style="text-align:left;padding:6px 8px;color:#4b5563;font-size:9px;text-transform:uppercase;border-bottom:1px solid #1e1e2a">Status</th>
        <th style="text-align:left;padding:6px 8px;color:#4b5563;font-size:9px;text-transform:uppercase;border-bottom:1px solid #1e1e2a">Platforms</th>
        <th style="text-align:left;padding:6px 8px;color:#4b5563;font-size:9px;text-transform:uppercase;border-bottom:1px solid #1e1e2a">Created</th>
      </tr></thead>
      <tbody>${subs.map(s => {
        const planColor = s.plan === "pro" ? "color:#c084fc" : s.plan === "basic" ? "color:#60a5fa" : "color:#6b7280";
        const statusColor = s.status === "active" ? "color:#34d399" : s.status === "cancelled" ? "color:#f87171" : "color:#fbbf24";
        const platforms = [s.telegram_user_id ? "TG" : null, s.discord_user_id ? "DC" : null].filter(Boolean).join(", ") || "-";
        const created = s.created_at ? new Date(s.created_at).toLocaleDateString() : "-";
        return `<tr style="border-bottom:1px solid #141420">
          <td style="padding:6px 8px;color:#e5e7eb">${esc(s.email)}</td>
          <td style="padding:6px 8px;${planColor};font-weight:600;text-transform:uppercase">${s.plan}</td>
          <td style="padding:6px 8px;${statusColor}">${s.status}</td>
          <td style="padding:6px 8px;color:#6b7280">${platforms}</td>
          <td style="padding:6px 8px;color:#4b5563">${created}</td>
        </tr>`;
      }).join("")}</tbody>
    </table>`;
  } catch {
    el.innerHTML = '<div style="color:#4b5563;font-size:12px">Failed to load subscribers</div>';
  }
}

function renderPerfStats(p) {
  const el = $("perfBlock");
  if (!el) return;
  const routes = (p.routes || []).slice(0, 8);
  if (routes.length === 0) { el.innerHTML = '<div style="color:#4b5563;font-size:12px">No data yet</div>'; return; }
  let html = '';
  for (const r of routes) {
    const avgColor = r.avgMs < 50 ? "green" : r.avgMs < 200 ? "amber" : "red";
    html += `<div class="kv"><span class="k" style="font-size:10px">${esc(r.route)}</span><span class="v ${avgColor}">${r.avgMs}ms <span style="color:#4b5563;font-size:9px">(${r.count}x)</span></span></div>`;
  }
  if ((p.slowRequests || []).length > 0) {
    html += `<div class="kv"><span class="k">Slow Requests</span><span class="v red">${p.slowRequests.length}</span></div>`;
  }
  el.innerHTML = html;
}

function renderMaintenance(m) {
  const el = $("maintenanceBlock");
  if (!el) return;
  let html = `<div class="kv"><span class="k">Last Run</span><span class="v">${m.lastRun ? new Date(m.lastRun).toLocaleString() : "Never"}</span></div>`;
  html += `<div class="kv"><span class="k">Total Runs</span><span class="v blue">${m.runCount ?? 0}</span></div>`;
  if (m.lastResults) {
    const r = m.lastResults;
    html += `<div class="kv"><span class="k">Last: Voided</span><span class="v">${r.voided ?? "-"}</span></div>`;
    html += `<div class="kv"><span class="k">Last: Purged</span><span class="v">${r.purgedSignals ?? "-"} signals, ${r.purgedQueue ?? "-"} queue</span></div>`;
  }
  el.innerHTML = html;
}

async function runMaintenance() {
  try {
    const res = await fetch("/api/admin/maintenance/run", { method: "POST" });
    const data = await res.json();
    renderMaintenance({ lastRun: new Date().toISOString(), runCount: "-", lastResults: data });
  } catch {}
}

async function grantComp() {
  const email = $("compEmail")?.value;
  const plan = $("compPlan")?.value || "pro";
  const days = Number($("compDays")?.value) || 30;
  if (!email) return;
  try {
    const res = await fetch("/api/admin/grant-comp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, plan, days })
    });
    const data = await res.json();
    const el = $("compResult");
    if (el) { el.textContent = data.message || "Done"; el.style.display = "block"; }
    loadSubscribers();
  } catch (err) {
    const el = $("compResult");
    if (el) { el.textContent = "Error: " + err.message; el.style.display = "block"; el.style.color = "#f87171"; }
  }
}

function renderTrading(t) {
  const el = $("tradingBlock");
  if (!el) return;
  const r = t.risk || {};
  const m = t.monitor || {};
  const e = t.executionStats || {};
  const c = t.control || {};
  const cbColor = r.circuitBroken ? "red" : "green";
  const pnlColor = r.dailyPnl >= 0 ? "green" : "red";
  const stateColor = c.state === "running" ? "green" : c.state === "paused" ? "amber" : c.state === "draining" ? "blue" : "red";
  let html = `
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:10px">
      <div class="kv"><span class="k">Bot State</span><span class="v ${stateColor}">${(c.state || "unknown").toUpperCase()}</span></div>
      <div class="kv"><span class="k">API</span><span class="v ${t.configured ? "green" : "red"}">${t.configured ? "Configured" : "Not Set"}</span></div>
      <div class="kv"><span class="k">Balance</span><span class="v ${(t.wallet?.balance || 0) > 5 ? "green" : "red"}">$${(t.wallet?.balance || 0).toFixed(2)}</span></div>
      <div class="kv"><span class="k">Circuit</span><span class="v ${cbColor}">${r.circuitBroken ? "BROKEN" : "OK"}</span></div>
      <div class="kv"><span class="k">Monitor</span><span class="v ${m.running ? "green" : "amber"}">${m.running ? "Running" : "Stopped"}</span></div>
    </div>
    <div style="display:flex;gap:6px;margin-bottom:12px">
      <button class="try-btn" style="${c.state === "running" ? "border-color:#34d399;color:#34d399" : ""}" onclick="botControl('resume')">Resume</button>
      <button class="try-btn" style="${c.state === "paused" ? "border-color:#fbbf24;color:#fbbf24" : ""}" onclick="botControl('pause')">Pause</button>
      <button class="try-btn" style="${c.state === "draining" ? "border-color:#60a5fa;color:#60a5fa" : ""}" onclick="botControl('drain')">Drain</button>
      <button class="try-btn" style="${c.state === "stopped" ? "border-color:#f87171;color:#f87171" : ""}" onclick="botControl('stop')">Stop</button>
      <button class="try-btn" style="border-color:#f87171;color:#f87171;margin-left:auto" onclick="liquidateAll()">Liquidate All</button>
    </div>
    <div class="kv"><span class="k">Daily P&L</span><span class="v ${pnlColor}">$${(r.dailyPnl || 0).toFixed(2)} / -$${r.dailyLossLimit || 0} limit</span></div>
    <div class="kv"><span class="k">Open Positions</span><span class="v">${r.openPositions || 0} / ${r.maxPositions || 0}</span></div>
    <div class="kv"><span class="k">Total Trades</span><span class="v blue">${r.totalTrades || 0} (${e.live_trades || 0} live, ${e.dry_runs || 0} dry)</span></div>
    <div class="kv"><span class="k">Total P&L</span><span class="v ${(r.totalPnl || 0) >= 0 ? "green" : "red"}">$${(r.totalPnl || 0).toFixed(2)}</span></div>
    <div class="kv"><span class="k">Win/Loss</span><span class="v">${e.wins || 0}W / ${e.losses || 0}L</span></div>
    <div class="kv"><span class="k">TP / SL</span><span class="v">+${m.takeProfitPct || 0}% / ${m.stopLossPct || 0}%</span></div>
  `;
  // Streak info
  const streak = r.streak || {};
  if (streak.direction && streak.direction !== "none") {
    const sColor = streak.direction === "win" ? "green" : "red";
    const multColor = streak.multiplier < 1 ? "red" : streak.multiplier > 1 ? "green" : "";
    html += `<div class="kv"><span class="k">Streak</span><span class="v ${sColor}">${streak.streak}x ${streak.direction.toUpperCase()} <span style="font-size:9px;color:#6b7280">(${streak.multiplier}x sizing)</span></span></div>`;
  }
  // Exposure & concentration
  const exp = r.exposure || {};
  if (exp.totalExposure != null) {
    const expColor = exp.totalExposure >= (exp.maxExposure || 50) ? "red" : exp.totalExposure > 0 ? "amber" : "green";
    html += `<div class="kv"><span class="k">Total Exposure</span><span class="v ${expColor}">$${(exp.totalExposure || 0).toFixed(2)} / $${exp.maxExposure || 0}</span></div>`;
    if (exp.byCategory && Object.keys(exp.byCategory).length > 0) {
      html += '<div style="margin-top:4px;font-size:9px;color:#4b5563;font-weight:700">CATEGORY EXPOSURE</div>';
      for (const [cat, amt] of Object.entries(exp.byCategory)) {
        const pct = exp.totalExposure > 0 ? (amt / exp.totalExposure * 100).toFixed(0) : 0;
        const warn = (exp.warnings || []).some(w => w.category === cat);
        html += `<div class="kv"><span class="k" style="font-size:10px">${esc(cat)}</span><span class="v ${warn ? "red" : ""}" style="font-size:10px">$${amt.toFixed(2)} (${pct}%)</span></div>`;
      }
    }
  }
  // Unrealized P&L from real-time tracker
  const pnl = t._pnl;
  if (pnl && pnl.aggregate) {
    const a = pnl.aggregate;
    const upnlColor = a.totalUnrealizedPnl >= 0 ? "green" : "red";
    html += `<div class="kv"><span class="k">Unrealized P&L</span><span class="v ${upnlColor}">$${a.totalUnrealizedPnl.toFixed(2)} (${a.positionCount} positions)</span></div>`;
  }
  if (c.reason) html += `<div class="kv"><span class="k">State Reason</span><span class="v" style="color:#6b7280">${esc(c.reason)}</span></div>`;
  // Show open executions from DB with close buttons and live P&L
  const openExecs = t._openExecutions || [];
  const pnlPositions = pnl?.positions || [];
  if (openExecs.length > 0) {
    html += '<div style="margin-top:10px;font-size:10px;color:#4b5563;font-weight:700">OPEN POSITIONS</div>';
    for (const ex of openExecs) {
      const pp = pnlPositions.find(p => p.executionId === ex.id);
      const pnlStr = pp && pp.priceAvailable ? ` | <span style="color:${pp.unrealizedPnlPct >= 0 ? "#34d399" : "#f87171"}">${pp.unrealizedPnlPct >= 0 ? "+" : ""}${pp.unrealizedPnlPct.toFixed(1)}% ($${pp.unrealizedPnlUsd.toFixed(2)})</span>` : "";
      html += `<div style="display:flex;align-items:center;gap:6px;font-size:10px;color:#9ca3af;padding:3px 0;border-bottom:1px solid #141420">
        <span style="flex:1">#${ex.id} ${esc(ex.side)} ${esc(ex.question?.slice(0,40) || ex.market_id?.slice(0,12))} @ ${(ex.entry_price||0).toFixed(3)} ${ex.dry_run ? "[DRY]" : "[LIVE]"}${pnlStr}</span>
        <button class="try-btn" style="font-size:9px;padding:1px 6px;border-color:#f87171;color:#f87171" onclick="closePosition(${ex.id})">Close</button>
      </div>`;
    }
  } else if (m.trades && m.trades.length > 0) {
    html += '<div style="margin-top:8px;font-size:10px;color:#4b5563">Open trades (monitor):</div>';
    for (const tr of m.trades) {
      html += `<div style="font-size:10px;color:#9ca3af;padding:2px 0">${esc(tr.side)} ${esc(tr.marketId?.slice(0,12))} @ ${tr.entryPrice?.toFixed(3)} (${tr.ageMinutes}m) ${tr.dryRun ? "[DRY]" : "[LIVE]"}</div>`;
    }
  }
  el.innerHTML = html;
}

async function botControl(action) {
  try {
    const res = await fetch("/api/trading/control", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action })
    });
    const data = await res.json();
    if (data.ok) loadAdmin();
    else alert(data.error || "Failed");
  } catch (err) { alert("Error: " + err.message); }
}

async function closePosition(id) {
  if (!confirm("Cancel position #" + id + "?")) return;
  try {
    const res = await fetch("/api/trading/close/" + id, { method: "POST" });
    const data = await res.json();
    if (data.ok) loadAdmin();
    else alert(data.error || "Failed");
  } catch (err) { alert("Error: " + err.message); }
}

async function liquidateAll() {
  if (!confirm("Cancel ALL open positions and pause the bot?")) return;
  try {
    const res = await fetch("/api/trading/liquidate-all", { method: "POST" });
    const data = await res.json();
    if (data.ok) { alert("Cancelled " + data.cancelled + " positions. Bot paused."); loadAdmin(); }
    else alert(data.error || "Failed");
  } catch (err) { alert("Error: " + err.message); }
}

const CONFIG_LABELS = {
  max_bet_usd: "Max Bet ($)",
  daily_loss_limit_usd: "Daily Loss Limit ($)",
  max_open_positions: "Max Positions",
  take_profit_pct: "Take Profit (%)",
  stop_loss_pct: "Stop Loss (%)",
  trailing_stop_pct: "Trailing Stop (%)",
  breakeven_trigger_pct: "Breakeven Trigger (%)",
  max_hold_hours: "Max Hold (hours)",
  max_total_exposure_usd: "Max Exposure ($)",
  max_category_concentration_pct: "Max Category (%)",
  max_slippage_pct: "Max Slippage (%)",
  min_balance_usd: "Min Balance ($)",
  min_settlement_minutes: "Min Settlement (min)",
  max_spread: "Max Spread"
};

function renderTradingConfig(cfg) {
  const el = $("configBlock");
  if (!el) return;
  let html = '<div style="display:flex;flex-direction:column;gap:4px">';
  for (const [key, meta] of Object.entries(cfg)) {
    const label = CONFIG_LABELS[key] || key;
    const custom = meta.isCustom ? ' style="color:#c084fc"' : '';
    html += `<div style="display:flex;align-items:center;gap:6px;font-size:11px">
      <span style="color:#6b7280;width:110px;flex-shrink:0">${esc(label)}</span>
      <input type="number" id="cfg_${key}" value="${meta.value}" min="${meta.min}" max="${meta.max}" step="any"
        style="width:70px;background:#0e0e16;border:1px solid #1e1e2a;border-radius:4px;padding:3px 6px;color:#e5e7eb;font-size:11px;font-family:inherit;text-align:right"${custom}>
      <span style="color:#27272f;font-size:9px">${meta.min}-${meta.max}</span>
    </div>`;
  }
  html += '</div>';
  html += '<button class="try-btn" style="margin-top:8px" onclick="saveConfig()">Save Config</button>';
  html += '<div id="configResult" style="font-size:10px;margin-top:4px;display:none"></div>';
  el.innerHTML = html;
}

async function saveConfig() {
  const updates = {};
  for (const key of Object.keys(CONFIG_LABELS)) {
    const input = $("cfg_" + key);
    if (input) updates[key] = Number(input.value);
  }
  try {
    const res = await fetch("/api/trading/config", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(updates)
    });
    const data = await res.json();
    const el = $("configResult");
    if (data.ok) {
      const warnText = (data.warnings || []).map(w => w.warning).join("; ");
      el.innerHTML = "Saved" + (warnText ? `<br><span style="color:#fbbf24;font-size:10px">${esc(warnText)}</span>` : "");
      el.style.color = "#34d399"; el.style.display = "block";
      setTimeout(() => { el.style.display = "none"; }, warnText ? 6000 : 3000);
    } else {
      el.textContent = "Errors: " + (data.errors || []).map(e => e.key + ": " + e.error).join(", ");
      el.style.color = "#f87171"; el.style.display = "block";
    }
  } catch (err) { alert("Error: " + err.message); }
}

function renderAnalytics(a) {
  if (!a || !a.overall) return;
  const o = a.overall;
  const wr = o.win_rate != null ? o.win_rate + "%" : "N/A";
  const wrClass = (o.win_rate || 0) >= 50 ? "green" : "red";
  const pnlClass = (o.total_pnl || 0) >= 0 ? "green" : "red";

  $("analyticsBlock").innerHTML = `
    <div class="kv"><span class="k">Total Trades</span><span class="v">${o.total_trades} (${o.live_trades} live / ${o.dry_runs} dry)</span></div>
    <div class="kv"><span class="k">Win Rate</span><span class="v ${wrClass}">${wr}</span></div>
    <div class="kv"><span class="k">Total P&L</span><span class="v ${pnlClass}">$${(o.total_pnl || 0).toFixed(2)}</span></div>
    <div class="kv"><span class="k">Avg Win / Loss</span><span class="v">$${(o.avg_win || 0).toFixed(2)} / $${(o.avg_loss || 0).toFixed(2)}</span></div>
    <div class="kv"><span class="k">Best / Worst</span><span class="v">$${(o.best_trade || 0).toFixed(2)} / $${(o.worst_trade || 0).toFixed(2)}</span></div>
    <div class="kv"><span class="k">Avg Hold Time</span><span class="v">${a.avgHoldMinutes ? a.avgHoldMinutes.toFixed(0) + " min" : "N/A"}</span></div>
    <div class="kv"><span class="k">Edge Accuracy</span><span class="v">${a.edgeAccuracy?.avg_predicted_edge_pct != null ? "Pred: " + a.edgeAccuracy.avg_predicted_edge_pct + "% / Actual: " + a.edgeAccuracy.avg_actual_pnl_pct + "% (" + a.edgeAccuracy.sample_size + " trades)" : "N/A"}</span></div>
    ${(a.byCategory || []).length > 0 ? '<div style="margin-top:8px;font-size:10px;color:#4b5563;font-weight:700;text-transform:uppercase">By Category</div>' +
      a.byCategory.map(c => `<div class="kv"><span class="k">${esc(c.category)}</span><span class="v">${c.wins}W/${c.losses}L | $${(c.total_pnl || 0).toFixed(2)}</span></div>`).join("") : ""}
  `;

  // Close reasons
  $("closeReasonsBlock").innerHTML = (a.byCloseReason || []).length > 0
    ? a.byCloseReason.map(r => `<div class="kv"><span class="k">${esc(r.reason)}</span><span class="v">${r.count} trades | $${(r.total_pnl || 0).toFixed(2)}</span></div>`).join("")
    : '<div style="color:#4b5563;font-size:12px">No closed trades yet</div>';
}

function renderFilterStats(f) {
  const el = $("filterStatsBlock");
  if (!el) return;
  const passRate = f.signalsReceived > 0 ? ((f.tradesExecuted / f.signalsReceived) * 100).toFixed(1) : "0";
  const labels = { dedup: "Duplicate Market", cooldown: "Cooldown", correlated: "Correlated", settlement: "Settlement", spread: "Wide Spread", chop: "CHOP Regime", risk: "Risk Limit", quality: "Low Quality" };
  let html = `<div class="kv"><span class="k">Signals In</span><span class="v blue">${f.signalsReceived}</span></div>
    <div class="kv"><span class="k">Trades Out</span><span class="v green">${f.tradesExecuted}</span></div>
    <div class="kv"><span class="k">Pass Rate</span><span class="v">${passRate}%</span></div>
    <div class="kv"><span class="k">Total Filtered</span><span class="v amber">${f.totalFiltered}</span></div>`;
  for (const [key, label] of Object.entries(labels)) {
    const val = f[key] || 0;
    if (val > 0) html += `<div class="kv"><span class="k" style="font-size:10px">${label}</span><span class="v red" style="font-size:10px">${val}</span></div>`;
  }
  el.innerHTML = html;
}

function renderHourly(data) {
  const el = $("hourlyBlock");
  if (!el || !Array.isArray(data)) return;
  if (data.length === 0) { el.innerHTML = '<div style="color:#4b5563;font-size:12px">No hourly data yet</div>'; return; }
  const byHour = {};
  for (const d of data) byHour[d.hour] = d;
  let html = '<div style="display:flex;gap:2px;flex-wrap:wrap">';
  for (let h = 0; h < 24; h++) {
    const d = byHour[h];
    const wr = d?.win_rate;
    const n = d ? (d.wins || 0) + (d.losses || 0) : 0;
    let bg = "#1e1e2a"; let fg = "#4b5563";
    if (n >= 5) {
      if (wr >= 65) { bg = "#34d39930"; fg = "#34d399"; }
      else if (wr < 40) { bg = "#f8717130"; fg = "#f87171"; }
      else { bg = "#fbbf2420"; fg = "#fbbf24"; }
    }
    html += `<div title="${h}:00 UTC â€” ${n > 0 ? wr?.toFixed(0) + '% WR (' + n + ' trades)' : 'No data'}" style="width:30px;height:36px;background:${bg};border-radius:4px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:9px;cursor:default">
      <span style="color:${fg};font-weight:700">${h}</span>
      <span style="color:${n >= 5 ? fg : '#27272f'};font-size:8px">${n > 0 ? (wr?.toFixed(0) || "?") + "%" : "-"}</span>
    </div>`;
  }
  html += '</div>';
  el.innerHTML = html;
}

function esc(s) { if (!s) return ""; const el = document.createElement("span"); el.textContent = s; return el.innerHTML; }

// --- WebSocket: live trade events ---
const MAX_FEED_ITEMS = 50;
let ws = null;
let wsReconnectTimer = null;

function connectWs() {
  const proto = location.protocol === "https:" ? "wss:" : "ws:";
  ws = new WebSocket(`${proto}//${location.host}/ws`);

  ws.onopen = () => {
    const badge = $("wsBadge");
    if (badge) { badge.textContent = "LIVE"; badge.style.background = "#34d39920"; badge.style.color = "#34d399"; }
  };

  ws.onclose = () => {
    const badge = $("wsBadge");
    if (badge) { badge.textContent = "OFFLINE"; badge.style.background = "#f8717120"; badge.style.color = "#f87171"; }
    wsReconnectTimer = setTimeout(connectWs, 5000);
  };

  ws.onerror = () => ws.close();

  ws.onmessage = (evt) => {
    try {
      const msg = JSON.parse(evt.data);
      if (msg.type === "trade") handleTradeEvent(msg);
    } catch {}
  };
}

function handleTradeEvent(msg) {
  const feed = $("tradeFeed");
  if (!feed) return;

  // Remove placeholder text on first event
  if (feed.children.length === 1 && feed.children[0].tagName !== "DIV") { /* keep */ }
  if (feed.querySelector("[data-placeholder]")) feed.querySelector("[data-placeholder]").remove();

  const colors = {
    POSITION_OPENED: "#34d399", POSITION_CLOSED: "#60a5fa", ORDER_PLACED: "#a78bfa",
    ORDER_FILLED: "#34d399", TRAILING_STOP: "#fbbf24", BREAKEVEN_STOP: "#fbbf24",
    RISK_BLOCKED: "#f87171", CLOB_UNREACHABLE: "#f87171", CONFIG_CHANGE: "#c084fc"
  };

  const color = colors[msg.event] || "#6b7280";
  const time = new Date(msg.timestamp).toLocaleTimeString();
  let detail = "";

  if (msg.event === "POSITION_OPENED") {
    const qBadge = msg.quality != null ? `<span style="color:#a78bfa;font-weight:700">Q:${msg.quality}</span> ` : "";
    const rBadge = msg.regime ? `<span style="color:#6b7280">[${msg.regime}]</span> ` : "";
    detail = `${qBadge}${rBadge}${msg.side} on ${esc((msg.question || msg.marketId || "").slice(0, 40))} | $${(msg.amount || 0).toFixed(2)} @ ${(msg.price || 0).toFixed(3)}${msg.dryRun ? " [DRY]" : ""}`;
  } else if (msg.event === "POSITION_CLOSED") {
    const pnl = msg.pnlUsd || 0;
    detail = `${msg.closeReason} | ${msg.side} | P&L: ${pnl >= 0 ? "+" : ""}$${pnl.toFixed(2)} (${(msg.pnlPct || 0).toFixed(1)}%) | held ${msg.holdMinutes || 0}m`;
  } else if (msg.event === "ORDER_PLACED") {
    detail = `${msg.side} $${(msg.amount || 0).toFixed(2)} @ ${(msg.price || 0).toFixed(3)}`;
  } else if (msg.event === "CLOB_UNREACHABLE") {
    detail = `${msg.consecutiveFailures} consecutive failures`;
  } else if (msg.event === "CONFIG_CHANGE") {
    detail = JSON.stringify(msg.changes || {}).slice(0, 80);
  } else {
    detail = msg.marketId || "";
  }

  const row = document.createElement("div");
  row.style.cssText = "display:flex;gap:8px;padding:4px 0;border-bottom:1px solid #141420;align-items:baseline";
  row.innerHTML = `<span style="color:#4b5563;min-width:65px">${time}</span><span style="color:${color};font-weight:600;min-width:130px">${esc(msg.event)}</span><span style="color:#9ca3af;flex:1">${detail}</span>`;
  feed.prepend(row);

  // Trim old entries
  while (feed.children.length > MAX_FEED_ITEMS) feed.removeChild(feed.lastChild);

  // Auto-refresh positions on trade events
  if (msg.event === "POSITION_OPENED" || msg.event === "POSITION_CLOSED") {
    loadAdmin();
  }
}

connectWs();
loadAdmin();
setInterval(loadAdmin, 30_000);
</script>
</body>
</html>
