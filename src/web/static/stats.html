<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PolySignal Performance</title>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: #0b0b11; color: #c8c8d0; min-height: 100vh; line-height: 1.5; }

    .header { padding: 14px 28px; background: #101018; border-bottom: 1px solid #1e1e2a; display: flex; align-items: center; justify-content: space-between; }
    .header-left { display: flex; align-items: center; gap: 14px; }
    .header-left h1 { font-size: 17px; color: #fff; font-weight: 700; letter-spacing: -0.3px; }
    .header-left .badge { font-size: 10px; font-weight: 700; padding: 2px 10px; border-radius: 20px; background: #34d39920; color: #34d399; }
    .header-right { display: flex; align-items: center; gap: 14px; }
    .header-link { color: #6b7280; text-decoration: none; font-size: 12px; font-weight: 500; }
    .header-link:hover { color: #a5b4fc; }

    .hero { text-align: center; padding: 40px 28px 20px; }
    .hero h2 { font-size: 22px; color: #fff; font-weight: 700; margin-bottom: 6px; }
    .hero p { font-size: 13px; color: #6b7280; max-width: 500px; margin: 0 auto; }

    .kpi-strip { display: flex; justify-content: center; gap: 0; padding: 0 28px 24px; flex-wrap: wrap; }
    .kpi-item { padding: 14px 28px; text-align: center; border-right: 1px solid #1a1a24; }
    .kpi-item:last-child { border-right: none; }
    .kpi-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.6px; color: #4b5563; margin-bottom: 4px; }
    .kpi-value { font-size: 26px; font-weight: 700; font-variant-numeric: tabular-nums; }
    .kpi-value.green { color: #34d399; }
    .kpi-value.red { color: #f87171; }
    .kpi-value.blue { color: #60a5fa; }
    .kpi-value.amber { color: #fbbf24; }
    .kpi-sub { font-size: 10px; color: #4b5563; margin-top: 2px; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; padding: 0 28px 28px; }
    .card { background: #12121a; border: 1px solid #1e1e2a; border-radius: 10px; padding: 16px 18px; }
    .card.wide { grid-column: 1 / -1; }
    .card-title { font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 12px; }
    .chart-area { height: 220px; position: relative; }
    .card.wide .chart-area { height: 260px; }

    .cat-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #141420; }
    .cat-row:last-child { border-bottom: none; }
    .cat-name { font-size: 12px; color: #e5e7eb; font-weight: 500; width: 100px; }
    .cat-bar-bg { flex: 1; height: 8px; background: #1a1a24; border-radius: 4px; overflow: hidden; }
    .cat-bar-fill { height: 100%; border-radius: 4px; }
    .cat-bar-fill.green { background: #34d399; }
    .cat-bar-fill.blue { background: #60a5fa; }
    .cat-bar-fill.amber { background: #fbbf24; }
    .cat-bar-fill.red { background: #f87171; }
    .cat-stats { font-size: 11px; color: #9ca3af; width: 120px; text-align: right; font-variant-numeric: tabular-nums; }

    .str-badge { display: inline-block; font-size: 10px; font-weight: 700; padding: 3px 10px; border-radius: 4px; }
    .str-badge.strong { background: #f8717125; color: #fca5a5; }
    .str-badge.good { background: #fbbf2420; color: #fcd34d; }

    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    thead th { text-align: left; padding: 10px 12px; color: #4b5563; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 10px; background: #0e0e16; border-bottom: 1px solid #1e1e2a; }
    tbody tr { border-bottom: 1px solid #141420; }
    tbody tr:last-child { border-bottom: none; }
    td { padding: 9px 12px; font-variant-numeric: tabular-nums; }
    .win { color: #34d399; font-weight: 600; }
    .loss { color: #f87171; font-weight: 600; }

    .period-btns { display: flex; justify-content: center; gap: 6px; padding-bottom: 20px; }
    .period-btn { background: #14141e; border: 1px solid #1e1e2a; border-radius: 6px; padding: 5px 14px; font-size: 11px; color: #6b7280; cursor: pointer; font-family: inherit; font-weight: 600; transition: all 0.15s; }
    .period-btn:hover { border-color: #3b82f6; color: #93c5fd; }
    .period-btn.active { background: #3b82f618; border-color: #3b82f6; color: #60a5fa; }

    .footer { text-align: center; padding: 28px; color: #27272f; font-size: 11px; }
    .footer a { color: #4b5563; }

    @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } .card.wide { grid-column: 1; } .kpi-strip { flex-wrap: wrap; } }
  </style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <h1>PolySignal</h1>
    <span class="badge">LIVE PERFORMANCE</span>
  </div>
  <div class="header-right">
    <a href="/" class="header-link">Dashboard</a>
    <a href="/leaderboard.html" class="header-link">Leaderboard</a>
    <a href="/terms.html" class="header-link">Terms</a>
    <a href="/privacy.html" class="header-link">Privacy</a>
  </div>
</div>

<div class="hero">
  <h2>Signal Performance</h2>
  <p>Real-time, verified trading signal performance across all Polymarket prediction markets.</p>
</div>

<div class="period-btns">
  <button class="period-btn" onclick="loadStats(7)">7 Days</button>
  <button class="period-btn active" onclick="loadStats(30)">30 Days</button>
  <button class="period-btn" onclick="loadStats(90)">90 Days</button>
</div>

<div class="kpi-strip" id="kpiStrip">
  <div class="kpi-item"><div class="kpi-label">Win Rate</div><div class="kpi-value green" id="kWinRate">-</div><div class="kpi-sub" id="kRecord">-</div></div>
  <div class="kpi-item"><div class="kpi-label">Total P&L</div><div class="kpi-value" id="kPnl">-</div><div class="kpi-sub">cumulative</div></div>
  <div class="kpi-item"><div class="kpi-label">Sharpe Ratio</div><div class="kpi-value blue" id="kSharpe">-</div><div class="kpi-sub">risk-adjusted</div></div>
  <div class="kpi-item"><div class="kpi-label">Max Drawdown</div><div class="kpi-value red" id="kDrawdown">-</div><div class="kpi-sub">worst peak-to-trough</div></div>
  <div class="kpi-item"><div class="kpi-label">Avg Confidence</div><div class="kpi-value amber" id="kConf">-</div><div class="kpi-sub">model certainty</div></div>
  <div class="kpi-item"><div class="kpi-label">Total Signals</div><div class="kpi-value" id="kTotal">-</div><div class="kpi-sub" id="kPeriod">30d</div></div>
</div>

<div class="grid">
  <div class="card wide">
    <div class="card-title">Equity Curve (Cumulative P&L)</div>
    <div class="chart-area"><canvas id="equityChart"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Daily Win Rate</div>
    <div class="chart-area"><canvas id="winRateChart"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Signal Volume</div>
    <div class="chart-area"><canvas id="volumeChart"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Performance by Category</div>
    <div id="categoryBreakdown"></div>
  </div>
  <div class="card">
    <div class="card-title">Performance by Strength</div>
    <div id="strengthBreakdown"></div>
  </div>
  <div class="card wide">
    <div class="card-title">Performance by Regime</div>
    <div id="regimeBreakdown"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
  </div>
  <div class="card wide">
    <div class="card-title">Regime &times; Category Heatmap</div>
    <div style="overflow-x:auto"><table id="regimeMatrix"><tbody></tbody></table></div>
  </div>
  <div class="card wide">
    <div class="card-title">Edge Calibration Audit</div>
    <div id="edgeAuditBlock"><div style="color:#4b5563;font-size:12px">Loading...</div></div>
  </div>
  <div class="card wide">
    <div class="card-title">Recent Settled Signals</div>
    <div style="overflow-x:auto">
      <table>
        <thead><tr><th>Market</th><th>Side</th><th>Outcome</th><th>Edge</th><th>Confidence</th><th>P&L</th></tr></thead>
        <tbody id="settledBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="footer">
  PolySignal &mdash; AI-powered Polymarket signal scanner &mdash; <a href="/">Back to Dashboard</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script>
const $ = (id) => document.getElementById(id);
const C = { green: "#34d399", greenBg: "#34d39930", red: "#f87171", redBg: "#f8717130", blue: "#60a5fa", blueBg: "#60a5fa30", amber: "#fbbf24", gray: "#6b7280" };
let charts = {};

async function loadStats(days = 30) {
  document.querySelectorAll(".period-btn").forEach(b => b.classList.toggle("active", b.textContent.trim() === days + " Days"));
  try {
    const [data, regime, edgeAudit] = await Promise.all([
      fetch("/api/public-stats?days=" + days).then(r => r.json()),
      fetch("/api/analytics/regime?days=" + days).then(r => r.json()).catch(() => null),
      fetch("/api/analytics/edge-audit?days=" + days).then(r => r.json()).catch(() => null)
    ]);
    renderKPIs(data, days);
    renderEquity(data);
    renderWinRate(data);
    renderVolume(data);
    renderCategories(data);
    renderStrengths(data);
    renderSettled(data);
    if (regime) { renderRegime(regime); renderRegimeMatrix(regime); }
    if (edgeAudit) renderEdgeAudit(edgeAudit);
  } catch (err) {
    console.error("Failed to load stats:", err);
  }
}

function renderKPIs(d, days) {
  const wr = d.winRate;
  $("kWinRate").textContent = wr != null ? wr + "%" : "-";
  $("kWinRate").className = "kpi-value " + (parseFloat(wr) >= 50 ? "green" : "red");
  $("kRecord").textContent = d.wins + "W / " + d.losses + "L";

  const pnl = d.totalPnl;
  $("kPnl").textContent = pnl != null ? (pnl >= 0 ? "+" : "") + pnl.toFixed(1) + "%" : "-";
  $("kPnl").className = "kpi-value " + (pnl >= 0 ? "green" : "red");

  $("kSharpe").textContent = d.sharpe != null ? d.sharpe.toFixed(2) : "-";
  $("kDrawdown").textContent = d.maxDrawdown ? d.maxDrawdown.toFixed(1) + "%" : "-";
  $("kConf").textContent = d.avgConfidence != null ? Math.round(d.avgConfidence) : "-";
  $("kTotal").textContent = d.totalSignals ?? "-";
  $("kPeriod").textContent = days + "d";
}

function renderEquity(d) {
  const curve = d.equityCurve || [];
  if (!curve.length) return;
  const labels = curve.map(p => { const dt = new Date(p.date); return (dt.getMonth()+1) + "/" + dt.getDate(); });
  const data = curve.map(p => p.cumPnl);
  if (charts.equity) charts.equity.destroy();
  charts.equity = new Chart($("equityChart"), {
    type: "line",
    data: { labels, datasets: [{ data, borderColor: C.green, backgroundColor: C.greenBg, fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2 }] },
    options: chartOpts()
  });
}

function renderWinRate(d) {
  const ts = d.timeSeries || [];
  if (!ts.length) return;
  const labels = ts.map(t => t.date.slice(5));
  const rates = ts.map(t => t.win_rate ?? 0);
  if (charts.winRate) charts.winRate.destroy();
  charts.winRate = new Chart($("winRateChart"), {
    type: "bar",
    data: { labels, datasets: [{ data: rates, backgroundColor: rates.map(w => w >= 50 ? C.greenBg : C.redBg), borderColor: rates.map(w => w >= 50 ? C.green : C.red), borderWidth: 1, borderRadius: 4 }] },
    options: { ...chartOpts(), scales: { ...chartOpts().scales, y: { ...chartOpts().scales.y, min: 0, max: 100 } } }
  });
}

function renderVolume(d) {
  const ts = d.timeSeries || [];
  if (!ts.length) return;
  const labels = ts.map(t => t.date.slice(5));
  if (charts.volume) charts.volume.destroy();
  charts.volume = new Chart($("volumeChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label: "Wins", data: ts.map(t => t.wins || 0), backgroundColor: C.green, borderRadius: 2 },
        { label: "Losses", data: ts.map(t => t.losses || 0), backgroundColor: C.red, borderRadius: 2 },
        { label: "Pending", data: ts.map(t => t.pending || 0), backgroundColor: C.gray, borderRadius: 2 }
      ]
    },
    options: { ...chartOpts(), scales: { x: { ...chartOpts().scales.x, stacked: true }, y: { ...chartOpts().scales.y, stacked: true } },
      plugins: { ...chartOpts().plugins, legend: { display: true, labels: { color: "#6b7280", font: { size: 10 } } } } }
  });
}

function renderCategories(d) {
  const cats = (d.byCategory || []).filter(c => (c.wins || 0) + (c.losses || 0) > 0);
  const el = $("categoryBreakdown");
  if (!cats.length) { el.innerHTML = '<div style="color:#4b5563;text-align:center;padding:20px;font-size:12px">No settled signals yet</div>'; return; }
  const colors = ["green", "blue", "amber", "red"];
  el.innerHTML = cats.map((c, i) => {
    const settled = (c.wins || 0) + (c.losses || 0);
    const wr = settled > 0 ? Math.round(c.wins / settled * 100) : 0;
    const color = colors[i % colors.length];
    return `<div class="cat-row">
      <span class="cat-name">${esc(c.category || "other")}</span>
      <div class="cat-bar-bg"><div class="cat-bar-fill ${color}" style="width:${wr}%"></div></div>
      <span class="cat-stats">${wr}% (${settled} signals)</span>
    </div>`;
  }).join("");
}

function renderStrengths(d) {
  const strengths = d.byStrength || [];
  const el = $("strengthBreakdown");
  if (!strengths.length) { el.innerHTML = '<div style="color:#4b5563;text-align:center;padding:20px;font-size:12px">No settled signals yet</div>'; return; }
  el.innerHTML = strengths.map(s => {
    const settled = (s.wins || 0) + (s.losses || 0);
    const wr = settled > 0 ? Math.round(s.wins / settled * 100) : 0;
    const badge = (s.strength || "").toUpperCase() === "STRONG" ? "strong" : "good";
    const color = wr >= 55 ? "green" : wr >= 45 ? "amber" : "red";
    return `<div class="cat-row">
      <span class="cat-name"><span class="str-badge ${badge}">${esc(s.strength || "?")}</span></span>
      <div class="cat-bar-bg"><div class="cat-bar-fill ${color}" style="width:${wr}%"></div></div>
      <span class="cat-stats">${wr}% (${settled} signals)</span>
    </div>`;
  }).join("");
}

function renderSettled(d) {
  // Fetch recent signals with outcomes
  fetch("/api/signals/recent?limit=30").then(r => r.json()).then(signals => {
    const settled = signals.filter(s => s.outcome != null).slice(0, 15);
    $("settledBody").innerHTML = settled.length === 0
      ? '<tr><td colspan="6" style="text-align:center;color:#4b5563;padding:20px">No settled signals yet. Check back soon.</td></tr>'
      : settled.map(s => {
        const isWin = s.outcome === "WIN";
        const side = s.side === "UP" ? "YES" : "NO";
        const edge = s.edge != null ? (s.edge > 0 ? "+" : "") + (s.edge * 100).toFixed(1) + "%" : "-";
        const pnl = s.pnl_pct != null ? (s.pnl_pct >= 0 ? "+" : "") + (s.pnl_pct * 100).toFixed(1) + "%" : "-";
        return `<tr>
          <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc((s.question || "").slice(0, 55))}</td>
          <td>${side}</td>
          <td class="${isWin ? "win" : "loss"}">${s.outcome}</td>
          <td>${edge}</td>
          <td>${s.confidence ?? "-"}</td>
          <td class="${(s.pnl_pct ?? 0) >= 0 ? "win" : "loss"}">${pnl}</td>
        </tr>`;
      }).join("");
  }).catch(() => {});
}

function chartOpts() {
  return {
    responsive: true, maintainAspectRatio: false, animation: { duration: 400 },
    plugins: { legend: { display: false }, tooltip: { backgroundColor: "#1a1a24", titleColor: "#e5e7eb", bodyColor: "#9ca3af", borderColor: "#2a2a36", borderWidth: 1, cornerRadius: 6 } },
    scales: {
      x: { grid: { color: "#141420" }, ticks: { color: "#4b5563", font: { size: 10 } } },
      y: { grid: { color: "#141420" }, ticks: { color: "#4b5563", font: { size: 10 } } }
    }
  };
}

function renderRegime(r) {
  const el = $("regimeBreakdown");
  if (!r.byRegime?.length) { el.innerHTML = '<div style="color:#4b5563;font-size:12px">No regime data yet</div>'; return; }
  el.innerHTML = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px">' +
    r.byRegime.map(d => {
      const color = d.winRate >= 55 ? C.green : d.winRate >= 45 ? C.amber : C.red;
      return `<div style="background:#14141e;border:1px solid #1e1e2a;border-radius:8px;padding:12px">
        <div style="font-size:11px;color:#6b7280;font-weight:700;text-transform:uppercase;margin-bottom:6px">${esc(d.regime || "unknown")}</div>
        <div style="font-size:20px;font-weight:700;color:${color}">${d.winRate != null ? d.winRate + "%" : "-"}</div>
        <div style="font-size:10px;color:#4b5563">${d.wins}W / ${d.losses}L (${d.total})</div>
      </div>`;
    }).join("") + '</div>';
}

function renderRegimeMatrix(r) {
  const tbody = document.querySelector("#regimeMatrix tbody");
  if (!r.regimeCategoryMatrix?.length) { tbody.innerHTML = '<tr><td style="color:#4b5563;font-size:12px;padding:8px">No data</td></tr>'; return; }
  const regimes = [...new Set(r.regimeCategoryMatrix.map(d => d.regime))];
  const cats = [...new Set(r.regimeCategoryMatrix.map(d => d.category))];
  const lookup = {};
  for (const d of r.regimeCategoryMatrix) lookup[d.regime + "|" + d.category] = d;
  let html = '<tr><th></th>' + regimes.map(r => `<th>${esc(r)}</th>`).join("") + '</tr>';
  for (const cat of cats) {
    html += `<tr><td style="font-weight:600">${esc(cat)}</td>`;
    for (const reg of regimes) {
      const d = lookup[reg + "|" + cat];
      if (d) {
        const bg = d.winRate >= 55 ? "#34d39920" : d.winRate >= 45 ? "#fbbf2420" : "#f8717120";
        const color = d.winRate >= 55 ? C.green : d.winRate >= 45 ? C.amber : C.red;
        html += `<td style="background:${bg};color:${color};font-weight:600;text-align:center">${d.winRate}% <span style="color:#4b5563;font-size:9px">(${d.total})</span></td>`;
      } else {
        html += '<td style="color:#27272f;text-align:center">-</td>';
      }
    }
    html += '</tr>';
  }
  tbody.innerHTML = html;
}

function renderEdgeAudit(a) {
  const el = $("edgeAuditBlock");
  if (!a.totalAudited || a.totalAudited === 0) { el.innerHTML = '<div style="color:#4b5563;font-size:12px">No settled signals with edge data yet</div>'; return; }
  const o = a.overall;
  const biasColor = o.biasDirection === "well-calibrated" ? C.green : o.biasDirection === "overconfident" ? C.red : C.amber;
  let html = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-bottom:14px">
    <div style="text-align:center"><div style="font-size:10px;color:#4b5563">AUDITED</div><div style="font-size:18px;font-weight:700;color:#e5e7eb">${a.totalAudited}</div></div>
    <div style="text-align:center"><div style="font-size:10px;color:#4b5563">WIN RATE</div><div style="font-size:18px;font-weight:700;color:${o.actualWinRate >= 50 ? C.green : C.red}">${o.actualWinRate}%</div></div>
    <div style="text-align:center"><div style="font-size:10px;color:#4b5563">AVG EDGE</div><div style="font-size:18px;font-weight:700;color:${C.blue}">+${o.avgPredictedEdge}%</div></div>
    <div style="text-align:center"><div style="font-size:10px;color:#4b5563">BIAS</div><div style="font-size:18px;font-weight:700;color:${biasColor}">${o.calibrationBias > 0 ? "+" : ""}${o.calibrationBias}%</div><div style="font-size:9px;color:#4b5563">${o.biasDirection}</div></div>
  </div>`;
  if (a.edgeBuckets?.length) {
    html += '<div style="font-size:10px;color:#6b7280;font-weight:700;margin-bottom:6px">EDGE BUCKETS</div>';
    html += a.edgeBuckets.filter(b => b.total > 0).map(b => {
      const wr = b.winRate != null ? b.winRate + "%" : "-";
      const color = (b.winRate ?? 0) >= 55 ? C.green : (b.winRate ?? 0) >= 45 ? C.amber : C.red;
      return `<div class="cat-row"><span class="cat-name">${esc(b.range)}</span><div class="cat-bar-bg"><div class="cat-bar-fill" style="width:${b.winRate || 0}%;background:${color}"></div></div><span class="cat-stats">${wr} (${b.total})</span></div>`;
    }).join("");
  }
  el.innerHTML = html;
}

function esc(s) { if (!s) return ""; const el = document.createElement("span"); el.textContent = s; return el.innerHTML; }

loadStats(30);
</script>
</body>
</html>
</content>
</invoke>